name: Deploy Next.js to IIS via Artifact Copy (Windows Runner)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest
    env:
      SERVER: ${{ secrets.IIS_SERVER }}
      USER: ${{ secrets.IIS_USER }}
      PASSWORD: ${{ secrets.IIS_PASSWORD }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      RUN_DB_SEED: ${{ secrets.RUN_DB_SEED }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js app
        run: npm run build

      - name: Debug build output
        shell: pwsh
        run: |
          $buildPath = Join-Path $env:GITHUB_WORKSPACE ".next"
          Write-Host "Listing contents of $buildPath"
          Get-ChildItem -Path $buildPath -Recurse

      - name: Package deployment artifact
        shell: pwsh
        run: |
          $workspace = $env:GITHUB_WORKSPACE
          $standalonePath = Join-Path $workspace ".next/standalone"

          if (Test-Path $standalonePath) {
            Write-Host "Standalone build found, packaging standalone..."
            Compress-Archive -Path "$standalonePath","$workspace/public","$workspace/prisma","$workspace/package.json" -DestinationPath "$workspace/deploy.zip" -Force
          } else {
            Write-Host "Standalone build not found, packaging full .next..."
            Compress-Archive -Path "$workspace/.next","$workspace/public","$workspace/prisma","$workspace/package.json" -DestinationPath "$workspace/deploy.zip" -Force
          }

      - name: Upload artifact to IIS server via SCP (WinSCP / pscp)
        shell: pwsh
        run: |
          $user = "${{ secrets.IIS_USER }}"
          $pass = "${{ secrets.IIS_PASSWORD }}"
          $server = "${{ secrets.IIS_SERVER }}"
          $localFile = "$env:GITHUB_WORKSPACE/deploy.zip"
          $remotePath = "C:/Deployments/NIBProcur/deploy.zip"

          # Make sure pscp.exe is available on the runner
          # You can install PuTTY tools or include it in your PATH
          Write-Host "Uploading $localFile to $server:$remotePath..."
          & "C:\Program Files\PuTTY\pscp.exe" -pw $pass $localFile "$user@$server:$remotePath"

      - name: Deploy on IIS Server
        shell: pwsh
        run: |
          $deployPath = "C:/inetpub/wwwroot/NIBProcur"
          $appPool = "NIBProcurment"
          $siteName = "NIBProcurment"
          $databaseUrl = "${{ secrets.DATABASE_URL }}"
          $runSeed = "${{ secrets.RUN_DB_SEED }}"

          # Run deploy.ps1 as a single command
          & "C:/Deployments/NIBProcur/deploy.ps1" `
            -DeployPath $deployPath `
            -AppPool $appPool `
            -SiteName $siteName `
            -DatabaseUrl $databaseUrl `
            -RunSeed $runSeed

      - name: Notify deployment success (email)
        if: ${{ success() }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Deployment Success"
          body: "Next.js app deployed successfully."
          to: ${{ secrets.NOTIFY_TO }}
          from: ${{ secrets.NOTIFY_FROM }}
          secure: true

      - name: Notify deployment failure (email)
        if: ${{ failure() }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Deployment Failed"
          body: "Next.js app deployment failed! Check workflow logs for details."
          to: ${{ secrets.NOTIFY_TO }}
          from: ${{ secrets.NOTIFY_FROM }}
          secure: true
