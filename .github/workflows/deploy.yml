
name: Deploy Next.js to IIS Remotely

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest
    env:
      SERVER: ${{ secrets.IIS_SERVER }}
      USER: ${{ secrets.IIS_USER }}
      PASSWORD: ${{ secrets.IIS_PASSWORD }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install

    - name: Prisma Migrations & Seed
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        $ErrorActionPreference = "Stop"

        Write-Host "Running Prisma migrations (deploy)"
        npx prisma migrate deploy

        Write-Host "Generating Prisma client..."
        npx prisma generate

        Write-Host "Seeding database..."
        npm run db:seed
      shell: pwsh

    - name: Build Next.js app
      run: npm run build

    - name: Deploy to IIS via PowerShell Remoting
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"

        $secPassword = ConvertTo-SecureString $env:PASSWORD -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ($env:USER, $secPassword)

        $scriptBlock = {
            param($sourcePath, $destinationPath, $appPool, $siteName)

            Write-Host "Stopping IIS App Pool and Website..."
            try { Stop-WebAppPool -Name $appPool -ErrorAction Stop; Write-Host "App Pool '$appPool' stopped." } catch { Write-Host "Could not stop App Pool '$appPool'. It may not exist or is already stopped." }
            try { Stop-Website -Name $siteName -ErrorAction Stop; Write-Host "Website '$siteName' stopped." } catch { Write-Host "Could not stop Website '$siteName'. It may not exist or is already stopped." }

            Write-Host "Copying files to IIS at '$destinationPath'..."
            robocopy $sourcePath "$destinationPath\.next" /E /MIR
            robocopy $sourcePath\public "$destinationPath\public" /E /MIR
            robocopy $sourcePath\node_modules "$destinationPath\node_modules" /E /MIR
            Copy-Item "$sourcePath\package.json" "$destinationPath\package.json" -Force

            if ($LASTEXITCODE -ge 8) { throw "File copy failed with exit code $LASTEXITCODE" }
            Write-Host "Files copied successfully."

            Write-Host "Starting IIS App Pool and Website..."
            try { Start-WebAppPool -Name $appPool -ErrorAction Stop; Write-Host "App Pool '$appPool' started." } catch { throw "Failed to start App Pool '$appPool'." }
            try { Start-Website -Name $siteName -ErrorAction Stop; Write-Host "Website '$siteName' started." } catch { throw "Failed to start Website '$siteName'." }
        }

        $sourcePath = "${{ github.workspace }}"
        $destinationPath = "C:\inetpub\wwwroot\NIBProcur"
        $appPool = "NIBProcurment"
        $siteName = "NIBProcurment"

        Invoke-Command -ComputerName $env:SERVER -Credential $cred -ScriptBlock $scriptBlock -ArgumentList $sourcePath, $destinationPath, $appPool, $siteName

    - name: Notify deployment success (email)
      if: ${{ success() }}
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "Deployment Success"
        body: "Next.js app deployed successfully."
        to: ${{ secrets.NOTIFY_TO }}
        from: ${{ secrets.NOTIFY_FROM }}
        secure: true

    - name: Notify deployment failure (email)
      if: ${{ failure() }}
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "Deployment Failed"
        body: "Next.js app deployment failed! Check workflow logs for details."
        to: ${{ secrets.NOTIFY_TO }}
        from: ${{ secrets.NOTIFY_FROM }}
        secure: true
