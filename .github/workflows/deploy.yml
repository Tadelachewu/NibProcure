name: Deploy Next.js to IIS via Artifact Copy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest
    env:
      SERVER: ${{ secrets.IIS_SERVER }}
      USER: ${{ secrets.IIS_USER }}
      PASSWORD: ${{ secrets.IIS_PASSWORD }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      RUN_DB_SEED: ${{ secrets.RUN_DB_SEED }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm ci

    - name: Build Next.js app (standalone)
      run: npm run build

    - name: Package deployment artifact
      run: |
        Compress-Archive -Path ".next\standalone","public","prisma","package.json" -DestinationPath "deploy.zip" -Force

    - name: Upload artifact to IIS server via SFTP
      uses: appleboy/scp-action@v0.1.6
      with:
        host: ${{ secrets.IIS_SERVER }}
        username: ${{ secrets.IIS_USER }}
        password: ${{ secrets.IIS_PASSWORD }}
        source: "deploy.zip"
        target: "C:\\Deployments\\NIBProcur"

    - name: Deploy on IIS Server
      run: |
        pwsh -File "C:\Deployments\NIBProcur\deploy.ps1" `
          -DeployPath "C:\inetpub\wwwroot\NIBProcur" `
          -AppPool "NIBProcurment" `
          -SiteName "NIBProcurment" `
          -DatabaseUrl "${{ secrets.DATABASE_URL }}" `
          -RunSeed:${{ secrets.RUN_DB_SEED }}
      shell: pwsh

    - name: Notify deployment success (email)
      if: ${{ success() }}
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "Deployment Success"
        body: "Next.js app deployed successfully."
        to: ${{ secrets.NOTIFY_TO }}
        from: ${{ secrets.NOTIFY_FROM }}
        secure: true

    - name: Notify deployment failure (email)
      if: ${{ failure() }}
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "Deployment Failed"
        body: "Next.js app deployment failed! Check workflow logs for details."
        to: ${{ secrets.NOTIFY_TO }}
        from: ${{ secrets.NOTIFY_FROM }}
        secure: true
