
# This workflow builds and deploys the Next.js application to a remote IIS server.
# It is triggered on every push to the 'main' branch.

name: Deploy Next.js to IIS Remotely

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest
    env:
      # These environment variables pull secrets from the GitHub repository settings.
      # You MUST configure these secrets in your repository's settings under:
      # "Settings" > "Secrets and variables" > "Actions" > "New repository secret"
      SERVER: ${{ secrets.IIS_SERVER }} # e.g., your_server_ip_address
      USER: ${{ secrets.IIS_USER }}     # e.g., your_windows_username
      PASSWORD: ${{ secrets.IIS_PASSWORD }}

    steps:
    # 1. Checkout repository
    # This step checks out a copy of your repository on the GitHub runner.
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. Setup Node.js
    # This step installs the specified version of Node.js on the runner.
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # 3. Install dependencies
    # This step installs all the npm packages defined in package.json.
    - name: Install dependencies
      run: npm install

    # 4. Build Next.js app
    # This step runs the 'npm run build' command to create a production-ready build.
    - name: Build Next.js app
      run: npm run build

    # 5. Run Prisma migrations and seeding
    # THIS IS THE MOST CRITICAL STEP TO FIX YOUR DATABASE ERRORS.
    # It ensures the database schema on your IIS server is perfectly in sync
    # with the schema defined in your code (prisma/schema.prisma).
    - name: Prisma Migrations & Seed
      run: |
        # This command applies any pending database schema changes.
        # It is the solution to errors like "The column does not exist".
        echo "Applying Prisma migrations..."
        npx prisma migrate deploy

        # This regenerates the Prisma client to match the updated schema.
        echo "Generating Prisma client..."
        npx prisma generate

        # This clears and repopulates the database with fresh test data.
        echo "Seeding database..."
        npm run db:seed
      shell: pwsh

    # 6. Deploy to IIS remotely via PowerShell Remoting
    # This is the core deployment step. It uses PowerShell to connect to the remote
    # IIS server and copy the built application files.
    - name: Deploy to IIS via PowerShell Remoting
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"

        # Convert the password from a plain text secret to a secure string for PowerShell Remoting.
        $secPassword = ConvertTo-SecureString $env:PASSWORD -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ($env:USER, $secPassword)

        # This script block runs on the remote IIS server.
        $scriptBlock = {
            param($sourcePath, $destinationPath, $appPool, $siteName)

            Write-Host "Stopping IIS App Pool and Website..."
            try { Stop-WebAppPool -Name $appPool -ErrorAction Stop; Write-Host "App Pool '$appPool' stopped." } catch { Write-Host "Could not stop App Pool '$appPool'. It may not exist or is already stopped." }
            try { Stop-Website -Name $siteName -ErrorAction Stop; Write-Host "Website '$siteName' stopped." } catch { Write-Host "Could not stop Website '$siteName'. It may not exist or is already stopped." }

            Write-Host "Copying files to IIS at '$destinationPath'..."
            # Use robocopy for efficient and mirrored file transfers.
            robocopy $sourcePath "$destinationPath\.next" /E /MIR
            robocopy $sourcePath\public "$destinationPath\public" /E /MIR
            robocopy $sourcePath\node_modules "$destinationPath\node_modules" /E /MIR
            Copy-Item "$sourcePath\package.json" "$destinationPath\package.json" -Force

            # Check if robocopy was successful. Exit codes >= 8 indicate failure.
            if ($LASTEXITCODE -ge 8) { throw "File copy failed with exit code $LASTEXITCODE" }
            Write-Host "Files copied successfully."

            Write-Host "Starting IIS App Pool and Website..."
            try { Start-WebAppPool -Name $appPool -ErrorAction Stop; Write-Host "App Pool '$appPool' started." } catch { throw "Failed to start App Pool '$appPool'." }
            try { Start-Website -Name $siteName -ErrorAction Stop; Write-Host "Website '$siteName' started." } catch { throw "Failed to start Website '$siteName'." }
        }

        # ===================================================================
        # === IMPORTANT: UPDATE THESE VALUES TO MATCH YOUR IIS SERVER     ===
        # ===================================================================
        $sourcePath = "${{ github.workspace }}"  # The path of the code on the GitHub runner (do not change this).
        
        # --- (REQUIRED) UPDATE THE 3 VARIABLES BELOW ---
        $destinationPath = "C:\inetpub\wwwroot\YourAppName" # The physical path on the IIS server where the app will be deployed.
        $appPool = "YourAppPoolName" # The name of the IIS Application Pool for your site.
        $siteName = "YourSiteName" # The name of the IIS Website.
        # -----------------------------------------------

        # Execute the script block on the remote server.
        Invoke-Command -ComputerName $env:SERVER -Credential $cred -ScriptBlock $scriptBlock -ArgumentList $sourcePath, $destinationPath, $appPool, $siteName

    # 7. Post-deployment notifications
    # This step sends an email notification about the deployment status.
    - name: Post-deployment status
      if: always() # This ensures the step runs even if the deployment fails.
      shell: pwsh
      run: |
        if (${{ job.status }} -eq 'success') { 
          Write-Host "Deployment succeeded ✅"
          # Example: send email notification for success.
          # You will need to configure your own SMTP server details.
          Send-MailMessage -To "tade2024bdu@gmail.com" -From "ci-cd@company.com" -Subject "Deployment Success" -Body "Next.js app deployed successfully." -SmtpServer "smtp.yourserver.com"
        } 
        else { 
          Write-Host "Deployment failed ❌"; 
          # Example: send email notification for failure.
          Send-MailMessage -To "tade2024bdu@gmail.com" -From "ci-cd@company.com" -Subject "Deployment Failed" -Body "Next.js app deployment failed!" -SmtpServer "smtp.yourserver.com"
          exit 1 
        }

