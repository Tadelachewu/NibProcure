name: Deploy Next.js to IIS via Artifact Copy (Windows Runner)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest
    env:
      SERVER: ${{ secrets.IIS_SERVER }}
      USER: ${{ secrets.IIS_USER }}
      PASSWORD: ${{ secrets.IIS_PASSWORD }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      RUN_DB_SEED: ${{ secrets.RUN_DB_SEED }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js app
        run: npm run build

      - name: Package deployment artifact
        shell: pwsh
        run: |
          $workspace = $env:GITHUB_WORKSPACE
          $standalonePath = Join-Path $workspace ".next/standalone"

          if (Test-Path $standalonePath) {
            Write-Host "Standalone build found, packaging standalone..."
            Compress-Archive -Path "$standalonePath","$workspace/public","$workspace/prisma","$workspace/package.json" -DestinationPath "$workspace/deploy.zip" -Force
          } else {
            Write-Host "Standalone build not found, packaging full .next..."
            Compress-Archive -Path "$workspace/.next","$workspace/public","$workspace/prisma","$workspace/package.json" -DestinationPath "$workspace/deploy.zip" -Force
          }

      - name: Copy artifact to IIS server via PowerShell Remoting
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $secPassword = ConvertTo-SecureString $env:PASSWORD -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ($env:USER, $secPassword)

          $localFile = "$env:GITHUB_WORKSPACE/deploy.zip"
          $remotePath = "C:\Deployments\NIBProcur\deploy.zip"

          Write-Host "Copying $localFile to $env:SERVER:$remotePath ..."
          Copy-Item -Path $localFile -Destination $remotePath -ToSession (New-PSSession -ComputerName $env:SERVER -Credential $cred)

      - name: Deploy on IIS Server
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $secPassword = ConvertTo-SecureString $env:PASSWORD -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ($env:USER, $secPassword)

          $deployPath = "C:\inetpub\wwwroot\NIBProcur"
          $appPool = "NIBProcurment"
          $siteName = "NIBProcurment"
          $databaseUrl = "${{ secrets.DATABASE_URL }}"
          $runSeed = "${{ secrets.RUN_DB_SEED }}"

          $scriptBlock = {
            param($deployPath, $appPool, $siteName, $databaseUrl, $runSeed)

            Write-Host "Stopping IIS App Pool and Website..."
            try { Stop-WebAppPool -Name $appPool -ErrorAction Stop } catch {}
            try { Stop-Website -Name $siteName -ErrorAction Stop } catch {}

            Write-Host "Extracting deploy.zip..."
            Expand-Archive -Path "$deployPath\deploy.zip" -DestinationPath $deployPath -Force

            Write-Host "Running Node modules install..."
            Push-Location $deployPath
            npm ci
            Pop-Location

            Write-Host "Running Prisma migrations..."
            $env:DATABASE_URL = $databaseUrl
            npx prisma migrate deploy

            if ($runSeed -eq "true") {
              Write-Host "Seeding database..."
              npm run db:seed
            }

            Write-Host "Starting IIS App Pool and Website..."
            Start-WebAppPool -Name $appPool
            Start-Website -Name $siteName
          }

          Invoke-Command -ComputerName $env:SERVER -Credential $cred -ScriptBlock $scriptBlock -ArgumentList $deployPath, $appPool, $siteName, $databaseUrl, $runSeed

      - name: Notify deployment success (email)
        if: ${{ success() }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Deployment Success"
          body: "Next.js app deployed successfully."
          to: ${{ secrets.NOTIFY_TO }}
          from: ${{ secrets.NOTIFY_FROM }}
          secure: true

      - name: Notify deployment failure (email)
        if: ${{ failure() }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Deployment Failed"
          body: "Next.js app deployment failed! Check workflow logs for details."
          to: ${{ secrets.NOTIFY_TO }}
          from: ${{ secrets.NOTIFY_FROM }}
          secure: true
