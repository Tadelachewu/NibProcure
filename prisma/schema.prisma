// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                      String                 @id @default(cuid())
  name                    String?
  email                   String?                @unique
  emailVerified           DateTime?
  image                   String?
  password                String?
  role                    String                 @default("Requester")
  departmentId            String?
  vendorId                String?                @unique
  managerId               String?
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  accounts                Account[]
  sessions                Session[]
  department              Department?            @relation("DepartmentUsers", fields: [departmentId], references: [id])
  headedDepartment        Department?            @relation("DepartmentHead")
  vendor                  Vendor?
  requisitions            PurchaseRequisition[]  @relation("Requester")
  approvedRequisitions    PurchaseRequisition[]  @relation("Approver")
  currentApprovals        PurchaseRequisition[]  @relation("CurrentApprover")
  auditLogs               AuditLog[]
  receipts                GoodsReceiptNote[]
  reviews                 Review[]
  financialCommittees     PurchaseRequisition[]  @relation("FinancialCommittee")
  technicalCommittees     PurchaseRequisition[]  @relation("TechnicalCommittee")
  scores                  CommitteeScoreSet[]
  committeeAssignments    CommitteeAssignment[]
  authoredMinutes         Minute[]               @relation("Author")
  attendedMinutes         Minute[]               @relation("Attendees")
  sentContracts           Contract[]
  manager                 User?                  @relation("Subordinates", fields: [managerId], references: [id])
  subordinates            User[]                 @relation("Subordinates")
}

model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  headId      String?  @unique
  head        User?    @relation("DepartmentHead", fields: [headId], references: [id], onDelete: SetNull)
  users       User[]   @relation("DepartmentUsers")
}

model Vendor {
  id            String         @id @default(cuid())
  name          String
  contactPerson String
  email         String         @unique
  phone         String
  address       String
  kycStatus     String
  rejectionReason String?
  userId        String         @unique
  user          User           @relation(fields: [userId], references: [id])
  kycDocuments  KYC_Document[]
  quotations    Quotation[]
  contracts     Contract[]
  purchaseOrders PurchaseOrder[]
}

model KYC_Document {
  id          String   @id @default(cuid())
  vendorId    String
  name        String
  url         String
  submittedAt DateTime @default(now())
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
}

model PurchaseRequisition {
  id                             String                 @id @default(cuid())
  transactionId                  String?                @unique
  title                          String
  departmentId                   String
  requesterId                    String
  status                         String
  urgency                        String
  justification                  String
  totalPrice                     Float
  deadline                       DateTime?
  scoringDeadline                DateTime?
  awardResponseDeadline          DateTime?
  awardResponseDurationMinutes   Int?
  committeeName                  String?
  committeePurpose               String?
  cpoAmount                      Float?
  awardStrategy                  AwardStrategy?
  awardDetails                   Json?
  failedAwardItemIds             String[]
  rfqSettings                    Json?
  createdAt                      DateTime               @default(now())
  updatedAt                      DateTime               @updatedAt
  approverId                     String?
  currentApproverId              String?
  department                     Department             @relation(fields: [departmentId], references: [id])
  requester                      User                   @relation("Requester", fields: [requesterId], references: [id])
  approver                       User?                  @relation("Approver", fields: [approverId], references: [id])
  currentApprover                User?                  @relation("CurrentApprover", fields: [currentApproverId], references: [id])
  items                          RequisitionItem[]
  customQuestions                CustomQuestion[]
  evaluationCriteria             EvaluationCriteria?
  quotations                     Quotation[]
  financialCommitteeMembers      User[]                 @relation("FinancialCommittee")
  technicalCommitteeMembers      User[]                 @relation("TechnicalCommittee")
  committeeAssignments           CommitteeAssignment[]
  reviews                        Review[]
  purchaseOrders                 PurchaseOrder[]
  contracts                      Contract[]
  minutes                        Minute[]
}

model CommitteeAssignment {
    userId String
    requisitionId String
    user User @relation(fields: [userId], references: [id])
    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    scoresSubmitted Boolean @default(false)
    individualDeadline DateTime?

    @@id([userId, requisitionId])
}


model RequisitionItem {
  id            String              @id @default(cuid())
  name          String
  description   String?
  quantity      Int
  unitPrice     Float?
  requisitionId String
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  quoteItems    QuoteItem[]
  poItems       POItem[]
}

model CustomQuestion {
  id              String              @id @default(cuid())
  questionText    String
  questionType    String
  isRequired      Boolean
  options         String[]
  requisitionId   String
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  answers         QuoteAnswer[]
}

model EvaluationCriteria {
  id                  String                @id @default(cuid())
  requisitionId       String                @unique
  requisition         PurchaseRequisition   @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  financialWeight     Int
  technicalWeight     Int
  financialCriteria   FinancialCriterion[]
  technicalCriteria   TechnicalCriterion[]
}

model FinancialCriterion {
  id                    String              @id @default(cuid())
  name                  String
  weight                Int
  evaluationCriteriaId  String
  evaluationCriteria  EvaluationCriteria  @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
  scores                Score[]
}

model TechnicalCriterion {
  id                    String              @id @default(cuid())
  name                  String
  weight                Int
  evaluationCriteriaId  String
  evaluationCriteria  EvaluationCriteria  @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
  scores                Score[]
}


model Quotation {
  id                    String              @id @default(cuid())
  transactionId         String?
  requisitionId         String
  vendorId              String
  vendorName            String
  totalPrice            Float
  deliveryDate          DateTime
  status                String
  notes                 String?
  rank                  Int?
  finalAverageScore     Float?
  cpoDocumentUrl        String?
  experienceDocumentUrl String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  requisition           PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  vendor                Vendor              @relation(fields: [vendorId], references: [id])
  items                 QuoteItem[]
  answers               QuoteAnswer[]
  scores                CommitteeScoreSet[]
}

model QuoteItem {
  id                String          @id @default(cuid())
  quotationId       String
  requisitionItemId String
  name              String
  quantity          Int
  unitPrice         Float
  leadTimeDays      Int
  brandDetails      String?
  quotation         Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  requisitionItem   RequisitionItem @relation(fields: [requisitionItemId], references: [id])
  scores            ItemScore[]
}

model QuoteAnswer {
  id          String         @id @default(cuid())
  quotationId String
  quotation   Quotation      @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  questionId  String
  question    CustomQuestion @relation(fields: [questionId], references: [id])
  answer      String
}

model CommitteeScoreSet {
    id String @id @default(cuid())
    quotationId String
    scorerId String
    quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    scorer User @relation(fields: [scorerId], references: [id])
    finalScore Float
    committeeComment String?
    itemScores ItemScore[]
    submittedAt DateTime @default(now())

    @@unique([quotationId, scorerId])
}

model ItemScore {
    id String @id @default(cuid())
    scoreSetId String
    quoteItemId String
    scoreSet CommitteeScoreSet @relation(fields: [scoreSetId], references: [id], onDelete: Cascade)
    quoteItem QuoteItem @relation(fields: [quoteItemId], references: [id], onDelete: Cascade)
    finalScore Float
    scores Score[]
}

model Score {
    id String @id @default(cuid())
    itemScoreId String
    itemScore ItemScore @relation(fields: [itemScoreId], references: [id], onDelete: Cascade)
    score Int
    comment String?
    type String // FINANCIAL or TECHNICAL
    financialCriterionId String?
    technicalCriterionId String?
    financialCriterion FinancialCriterion? @relation(fields: [financialCriterionId], references: [id])
    technicalCriterion TechnicalCriterion? @relation(fields: [technicalCriterionId], references: [id])
}

model PurchaseOrder {
  id               String               @id @default(cuid())
  transactionId    String?
  requisitionId    String
  requisition      PurchaseRequisition  @relation(fields: [requisitionId], references: [id])
  requisitionTitle String
  vendorId         String
  vendor           Vendor               @relation(fields: [vendorId], references: [id])
  totalAmount      Float
  status           String
  notes            String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  items            POItem[]
  receipts         GoodsReceiptNote[]
  invoices         Invoice[]
}

model POItem {
  id                String            @id @default(cuid())
  purchaseOrderId   String
  purchaseOrder     PurchaseOrder     @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  requisitionItemId String
  requisitionItem   RequisitionItem   @relation(fields: [requisitionItemId], references: [id])
  name              String
  quantity          Int
  unitPrice         Float
  totalPrice        Float
  receivedQuantity  Int
  receiptItems      ReceiptItem[]
}

model GoodsReceiptNote {
  id              String        @id @default(cuid())
  transactionId   String?
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  receivedById    String
  receivedBy      User          @relation(fields: [receivedById], references: [id])
  receivedDate    DateTime      @default(now())
  items           ReceiptItem[]
}

model ReceiptItem {
  id                String           @id @default(cuid())
  goodsReceiptNoteId String
  goodsReceiptNote  GoodsReceiptNote @relation(fields: [goodsReceiptNoteId], references: [id], onDelete: Cascade)
  poItemId          String
  poItem            POItem           @relation(fields: [poItemId], references: [id])
  quantityReceived  Int
  condition         String
  notes             String?
}

model Invoice {
  id                 String       @id @default(cuid())
  transactionId      String?
  purchaseOrderId    String
  po                 PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  vendorId           String
  invoiceDate        DateTime
  totalAmount        Float
  status             String
  documentUrl        String?
  paymentDate        DateTime?
  paymentReference   String?
  paymentEvidenceUrl String?
  items              InvoiceItem[]
}

model InvoiceItem {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  name      String
  quantity  Int
  unitPrice Float
  totalPrice Float
}

model AuditLog {
  id            String   @id @default(cuid())
  transactionId String?
  timestamp     DateTime @default(now())
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  action        String
  entity        String
  entityId      String
  details       String
}

model Review {
    id String @id @default(cuid())
    requisitionId String
    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    reviewerId String
    reviewer User @relation(fields: [reviewerId], references: [id])
    decision String // 'APPROVED', 'REJECTED'
    comment String?
    createdAt DateTime @default(now())
}

model Contract {
    id String @id @default(cuid())
    contractNumber String @unique @default(cuid()) // Simplified: use cuid for unique number
    requisitionId String
    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    vendorId String
    vendor Vendor @relation(fields: [vendorId], references: [id])
    senderId String
    sender User @relation(fields: [senderId], references: [id])
    startDate DateTime
    endDate DateTime
    filePath String?
    status String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model Minute {
  id            String   @id @default(cuid())
  requisitionId String
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  authorId      String
  author        User     @relation("Author", fields: [authorId], references: [id])
  decision      String
  decisionBody  String
  justification String
  createdAt     DateTime @default(now())
  attendees     User[]   @relation("Attendees")
}

model Setting {
  key   String @id
  value Json
}

model ApprovalThreshold {
  id    String         @id @default(cuid())
  name  String
  min   Float
  max   Float?
  steps ApprovalStep[]
}

model ApprovalStep {
  id          String            @id @default(cuid())
  thresholdId String
  threshold   ApprovalThreshold @relation(fields: [thresholdId], references: [id], onDelete: Cascade)
  role        String
  order       Int
}

enum AwardStrategy {
  SINGLE_VENDOR
  BEST_ITEM
}
