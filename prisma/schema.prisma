
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                                              String    @id @default(cuid())
  name                                            String
  email                                           String    @unique
  password                                        String
  roles                                           Role[]    @relation("UserRoles")
  departmentId                                    String?
  vendorId                                        String?   @unique
  createdAt                                       DateTime  @default(now())
  updatedAt                                       DateTime  @updatedAt
  department                                      Department? @relation(fields: [departmentId], references: [id])
  managingDepartment                              Department? @relation("DepartmentHead")
  vendor                                          Vendor?
  requisitions                                    PurchaseRequisition[] @relation("Requesters")
  approvals                                       PurchaseRequisition[] @relation("Approvers")
  currentApprovals                                PurchaseRequisition[] @relation("CurrentApprovers")
  financialCommitteeAssignments                   PurchaseRequisition[] @relation("FinancialCommittee")
  technicalCommitteeAssignments                   PurchaseRequisition[] @relation("TechnicalCommittee")
  committeeAssignments                            CommitteeAssignment[]
  reviews                                         Review[]
  authoredMinutes                                 Minute[]              @relation("authoredMinutes")
  attendedMinutes                                 Minute[]              @relation("MinuteAttendees")
  goodsReceipts                                   GoodsReceiptNote[]
  contractsSent                                   Contract[]
  committeeScores                                 CommitteeScoreSet[]
  directorPins                                    DirectorPin[]
  signatures                                      Signature[]
  requesterTickets                                SupportTicket[]       @relation("RequesterTickets")
  adminResponses                                  SupportTicket[]       @relation("AdminResponses")
  auditLogs                                       AuditLog[]

  @@map("users")
}

model Role {
  id          String @id @default(cuid())
  name        String @unique
  description String?
  users       User[] @relation("UserRoles")
  approvalSteps ApprovalStep[]

  @@map("roles")
}


model Department {
  id           String    @id @default(cuid())
  name         String    @unique
  description  String?
  headId       String?   @unique
  head         User?     @relation("DepartmentHead", fields: [headId], references: [id])
  users        User[]
  requisitions PurchaseRequisition[]

  @@map("departments")
}

model PurchaseRequisition {
  id                              String    @id @default(cuid())
  transactionId                   String    @unique
  requester                       User      @relation("Requesters", fields: [requesterId], references: [id])
  requesterId                     String
  department                      Department @relation(fields: [departmentId], references: [id])
  departmentId                    String
  title                           String
  urgency                         String
  justification                   String
  status                          String
  totalPrice                      Float
  createdAt                       DateTime  @default(now())
  updatedAt                       DateTime  @updatedAt
  approver                        User?     @relation("Approvers", fields: [approverId], references: [id])
  approverId                      String?
  approverComment                 String?
  currentApprover                 User?     @relation("CurrentApprovers", fields: [currentApproverId], references: [id])
  currentApproverId               String?
  deadline                        DateTime?
  cpoAmount                       Float?
  items                           RequisitionItem[]
  customQuestions                 CustomQuestion[]
  evaluationCriteria              EvaluationCriteria?
  financialCommitteeMembers       User[]              @relation("FinancialCommittee")
  technicalCommitteeMembers       User[]              @relation("TechnicalCommittee")
  committeeName                   String?
  committeePurpose                String?
  scoringDeadline                 DateTime?
  awardResponseDeadline           DateTime?
  allowedVendorIds                String[]
  awardedQuoteItemIds             String[]            @default([])
  rfqSettings                     Json?
  quotations                      Quotation[]
  reviews                         Review[]
  purchaseOrders                  PurchaseOrder[]
  contracts                       Contract[]
  minutes                         Minute[]
  committeeAssignments            CommitteeAssignment[]
  standbyAssignments              StandbyAssignment[]
  directorPins                    DirectorPin[]
  parent                          PurchaseRequisition? @relation("RequisitionChildren", fields: [parentId], references: [id])
  parentId                        String?
  children                        PurchaseRequisition[] @relation("RequisitionChildren")

  @@map("purchase_requisitions")
}

model RequisitionItem {
  id                  String   @id @default(cuid())
  requisition         PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionId       String
  name                String
  description         String?
  quantity            Int
  unitPrice           Float
  perItemAwardDetails Json?
  purchaseOrderItem   POItem?
  
  @@map("requisition_items")
}

model CustomQuestion {
    id                  String   @id @default(cuid())
    requisition         PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    requisitionId       String
    questionText        String
    questionType        String
    isRequired          Boolean
    options             String[]
    answers             QuoteAnswer[]

    @@map("custom_questions")
}

model EvaluationCriteria {
    id                  String @id @default(cuid())
    requisition         PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    requisitionId       String @unique
    financialWeight     Int
    technicalWeight     Int
    financialCriteria   FinancialCriterion[]
    technicalCriteria   TechnicalCriterion[]

    @@map("evaluation_criteria")
}

model FinancialCriterion {
    id                      String @id @default(cuid())
    evaluationCriteria      EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
    evaluationCriteriaId    String
    name                    String
    weight                  Int
    scores                  Score[]

    @@map("financial_criteria")
}

model TechnicalCriterion {
    id                      String @id @default(cuid())
    evaluationCriteria      EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
    evaluationCriteriaId    String
    name                    String
    weight                  Int
    scores                  Score[]

    @@map("technical_criteria")
}


model Quotation {
    id                  String @id @default(cuid())
    transactionId       String
    requisition         PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    requisitionId       String
    vendor              Vendor @relation(fields: [vendorId], references: [id])
    vendorId            String
    vendorName          String
    items               QuoteItem[]
    answers             QuoteAnswer[]
    totalPrice          Float
    deliveryDate        DateTime
    status              String
    notes               String?
    cpoDocumentUrl      String?
    experienceDocumentUrl String?
    bidDocumentUrl      String?
    rejectionReason     String?
    rank                Int?
    finalAverageScore   Float?
    createdAt           DateTime @default(now())
    updatedAt           DateTime @updatedAt
    scores              CommitteeScoreSet[]

    @@map("quotations")
}

model QuoteItem {
    id              String @id @default(cuid())
    quotation       Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    quotationId     String
    requisitionItemId String
    name            String
    quantity        Int
    unitPrice       Float
    leadTimeDays    Int
    brandDetails    String?
    imageUrl        String?
    scores          ItemScore[]

    @@map("quote_items")
}

model QuoteAnswer {
    id          String @id @default(cuid())
    quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    quotationId String
    question    CustomQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
    questionId  String
    answer      String

    @@map("quote_answers")
}

model CommitteeScoreSet {
    id          String      @id @default(cuid())
    quotation   Quotation   @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    quotationId String
    scorerId    String
    scorer      User        @relation(fields: [scorerId], references: [id], onDelete: Cascade)
    itemScores  ItemScore[]
    finalScore  Float       @default(0)
    committeeComment String?
    submittedAt DateTime    @default(now())
    
    @@unique([quotationId, scorerId])
    @@map("committee_score_sets")
}

model ItemScore {
    id          String @id @default(cuid())
    scoreSet    CommitteeScoreSet @relation(fields: [scoreSetId], references: [id], onDelete: Cascade)
    scoreSetId  String
    quoteItem   QuoteItem @relation(fields: [quoteItemId], references: [id], onDelete: Cascade)
    quoteItemId String
    scores      Score[]
    finalScore  Float // The calculated weighted score for this item from this scorer

    @@map("item_scores")
}

model Score {
    id                      String @id @default(cuid())
    itemScore               ItemScore @relation(fields: [itemScoreId], references: [id], onDelete: Cascade)
    itemScoreId             String
    financialCriterion      FinancialCriterion? @relation(fields: [financialCriterionId], references: [id])
    financialCriterionId    String?
    technicalCriterion      TechnicalCriterion? @relation(fields: [technicalCriterionId], references: [id])
    technicalCriterionId    String?
    score                   Int
    comment                 String
    type                    String // FINANCIAL or TECHNICAL

    @@map("scores")
}

model CommitteeAssignment {
    id              String @id @default(cuid())
    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    requisitionId   String
    user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
    userId          String
    scoresSubmitted Boolean @default(false)

    @@unique([userId, requisitionId])
    @@map("committee_assignments")
}

model StandbyAssignment {
  id            String    @id @default(cuid())
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionId String
  vendorId      String
  rank          Int
  createdAt     DateTime  @default(now())

  @@map("standby_assignments")
}

model Review {
    id            String    @id @default(cuid())
    requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    requisitionId String
    reviewer      User      @relation(fields: [reviewerId], references: [id])
    reviewerId    String
    decision      String // Approved, Rejected
    comment       String?
    createdAt     DateTime  @default(now())

    @@map("reviews")
}


model PurchaseOrder {
    id                String    @id @default(cuid())
    transactionId     String
    requisition       PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    requisitionId     String
    requisitionTitle  String
    vendorId          String
    vendor            Vendor @relation(fields: [vendorId], references: [id])
    items             POItem[]
    totalAmount       Float
    status            String
    createdAt         DateTime  @default(now())
    notes             String?
    receipts          GoodsReceiptNote[]
    invoices          Invoice[]

    @@map("purchase_orders")
}

model POItem {
    id                  String   @id @default(cuid())
    po                  PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
    purchaseOrderId     String
    requisitionItemId   String   @unique
    requisitionItem     RequisitionItem @relation(fields: [requisitionItemId], references: [id])
    name                String
    quantity            Int
    unitPrice           Float
    totalPrice          Float
    receivedQuantity    Int
    receiptItems        ReceiptItem[]
    
    @@map("po_items")
}

model GoodsReceiptNote {
  id              String    @id @default(cuid())
  transactionId   String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  purchaseOrderId String
  receivedBy      User          @relation(fields: [receivedById], references: [id])
  receivedById    String
  receivedDate    DateTime  @default(now())
  items           ReceiptItem[]
  photos          Json[]
  status          String? // e.g., 'Processed', 'Disputed'

  @@map("goods_receipt_notes")
}

model ReceiptItem {
    id                  String @id @default(cuid())
    grn                 GoodsReceiptNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
    grnId               String
    poItem              POItem @relation(fields: [poItemId], references: [id])
    poItemId            String
    quantityReceived    Int
    condition           String // Good, Damaged, Incorrect
    notes               String?

    @@map("receipt_items")
}


model Invoice {
  id                  String    @id @default(cuid())
  transactionId       String
  purchaseOrder       PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  purchaseOrderId     String
  vendorId            String
  invoiceDate         DateTime
  items               InvoiceItem[]
  totalAmount         Float
  status              String
  documentUrl         String?
  disputeReason       String?
  paymentDate         DateTime?
  paymentReference    String?
  paymentEvidenceUrl  String?

  @@map("invoices")
}

model InvoiceItem {
  id              String @id @default(cuid())
  invoice         Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId       String
  name            String
  quantity        Int
  unitPrice       Float
  totalPrice      Float
  
  @@map("invoice_items")
}


model Vendor {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id])
  name            String
  contactPerson   String
  email           String    @unique
  phone           String
  address         String
  kycStatus       String
  rejectionReason String?
  kycDocuments    KYC_Document[]
  quotations      Quotation[]
  purchaseOrders  PurchaseOrder[]
  contracts       Contract[]

  @@map("vendors")
}

model KYC_Document {
    id          String @id @default(cuid())
    vendor      Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
    vendorId    String
    name        String
    url         String
    submittedAt DateTime

    @@map("kyc_documents")
}

model AuditLog {
  id            String    @id @default(cuid())
  transactionId String?
  timestamp     DateTime  @default(now())
  user          User?     @relation(fields: [userId], references: [id])
  userId        String?
  action        String
  entity        String
  entityId      String
  details       String

  @@map("audit_logs")
}

model Setting {
  id          String @id @default(cuid())
  key         String @unique
  value       Json

  @@map("settings")
}

model Contract {
  id              String    @id @default(cuid())
  contractNumber  String    @unique
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  requisitionId   String
  vendorId        String
  vendor          Vendor    @relation(fields: [vendorId], references: [id])
  senderId        String
  sender          User      @relation(fields: [senderId], references: [id])
  startDate       DateTime
  endDate         DateTime
  filePath        String?
  status          String // Draft, Active, Expired
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("contracts")
}

model Minute {
    id            String @id @default(cuid())
    requisitionId String
    requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    authorId      String
    author        User @relation("authoredMinutes", fields: [authorId], references: [id])
    decision      String
    decisionBody  String
    justification String
    attendees     User[] @relation("MinuteAttendees")
    createdAt     DateTime @default(now())
    type          String // e.g., 'system_generated', 'uploaded_document'
    documentUrl   String?
    signatures    Signature[]
    
    @@map("minutes")
}

model Signature {
    id           String @id @default(cuid())
    minuteId     String
    minute       Minute @relation(fields: [minuteId], references: [id])
    signerId     String
    signer       User @relation(fields: [signerId], references: [id])
    signerName   String
    signerRole   String
    decision     String // 'APPROVED', 'REJECTED'
    comment      String?
    signedAt     DateTime @default(now())

    @@map("signatures")
}

model ApprovalThreshold {
    id      String @id @default(cuid())
    name    String @unique
    min     Float
    max     Float?
    steps   ApprovalStep[]

    @@map("approval_thresholds")
}

model ApprovalStep {
    id          String @id @default(cuid())
    threshold   ApprovalThreshold @relation(fields: [thresholdId], references: [id], onDelete: Cascade)
    thresholdId String
    role        Role   @relation(fields: [roleId], references: [id])
    roleId      String
    order       Int

    @@map("approval_steps")
}


model SupportTicket {
  id          String   @id @default(cuid())
  subject     String
  message     String
  status      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  requester   User     @relation("RequesterTickets", fields: [requesterId], references: [id])
  requesterId String
  admin       User?    @relation("AdminResponses", fields: [adminId], references: [id])
  adminId     String?
  response    String?

  @@map("support_tickets")
}


model DirectorPin {
  id            String   @id @default(cuid())
  pin           String   @unique
  requisitionId String
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  expiresAt     DateTime

  @@unique([requisitionId, userId])
  @@map("director_pins")
}
