// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                                       String                @id @default(cuid())
  name                                     String
  email                                    String                @unique
  password                                 String
  role                                     UserRole
  vendorId                                 String?               @unique
  departmentId                             String?
  managerId                                String?
  createdAt                                DateTime              @default(now())
  updatedAt                                DateTime              @updatedAt
  department                               Department?           @relation("DepartmentMembers", fields: [departmentId], references: [id])
  managingDepartment                       Department?           @relation("DepartmentHead")
  manager                                  User?                 @relation("manager", fields: [managerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  reports                                  User[]                @relation("manager")
  vendor                                   Vendor?
  requisitions                             PurchaseRequisition[] @relation("requester")
  approvals                                PurchaseRequisition[] @relation("approver")
  currentApprovals                         PurchaseRequisition[] @relation("currentApprover")
  scores                                   CommitteeScoreSet[]
  committeeAssignments                     CommitteeAssignment[]
  minutesAuthored                          Minute[]              @relation("author")
  minutesAttended                          Minute[]              @relation("MinuteAttendees")
  receipts                                 GoodsReceiptNote[]
  financialCommittees                      PurchaseRequisition[] @relation("financialCommittee")
  technicalCommittees                      PurchaseRequisition[] @relation("technicalCommittee")
  contracts                                Contract[]

  @@map("users")
}

model Department {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  headId      String? @unique
  head        User?   @relation("DepartmentHead", fields: [headId], references: [id])
  users       User[]  @relation("DepartmentMembers")

  requisitions PurchaseRequisition[]

  @@map("departments")
}

model Vendor {
  id              String        @id @default(cuid())
  name            String
  contactPerson   String
  email           String        @unique
  phone           String
  address         String
  kycStatus       KycStatus     @default(Pending)
  rejectionReason String?
  userId          String        @unique
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  quotations      Quotation[]
  kycDocuments    KYC_Document[]
  purchaseOrders  PurchaseOrder[]
  contracts       Contract[]

  @@map("vendors")
}

model KYC_Document {
  id          String   @id @default(cuid())
  name        String
  url         String
  submittedAt DateTime @default(now())
  vendorId    String
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@map("kyc_documents")
}

model PurchaseRequisition {
  id                          String                @id @default(cuid())
  transactionId               String                @unique
  title                       String
  totalPrice                  Float
  justification               String
  status                      RequisitionStatus
  urgency                     Urgency
  requesterId                 String
  departmentId                String
  approverId                  String?
  currentApproverId           String?
  deadline                    DateTime?
  scoringDeadline             DateTime?
  awardResponseDeadline       DateTime?
  awardResponseDurationMinutes Int?
  committeeName               String?
  committeePurpose            String?
  cpoAmount                   Float?
  createdAt                   DateTime              @default(now())
  updatedAt                   DateTime              @updatedAt
  approverComment             String?
  allowedVendorIds            String[]
  awardedQuoteItemIds         String[]
  rfqSettings                 Json                  @default("{}")
  purchaseOrderId             String?
  requester                   User                  @relation("requester", fields: [requesterId], references: [id])
  department                  Department            @relation(fields: [departmentId], references: [id])
  approver                    User?                 @relation("approver", fields: [approverId], references: [id])
  currentApprover             User?                 @relation("currentApprover", fields: [currentApproverId], references: [id])
  items                       RequisitionItem[]
  customQuestions             CustomQuestion[]
  evaluationCriteria          EvaluationCriteria?
  financialCommitteeMembers   User[]                @relation("financialCommittee")
  technicalCommitteeMembers   User[]                @relation("technicalCommittee")
  committeeAssignments        CommitteeAssignment[]
  quotations                  Quotation[]
  standbyAssignments          StandbyAssignment[]
  purchaseOrders              PurchaseOrder[]
  reviews                     Review[]
  minutes                     Minute[]
  contracts                   Contract[]

  @@map("purchase_requisitions")
}

model RequisitionItem {
  id                String              @id @default(cuid())
  name              String
  quantity          Int
  unitPrice         Float
  description       String?
  requisitionId     String
  requisition       PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  quoteItems        QuoteItem[]
  poItems           POItem[]
  standbyAssignment StandbyAssignment[]

  @@map("requisition_items")
}

model CustomQuestion {
  id              String              @id @default(cuid())
  questionText    String
  questionType    QuestionType
  isRequired      Boolean
  options         String[]
  requisitionId   String
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  quoteAnswers    QuoteAnswer[]

  @@map("custom_questions")
}

model EvaluationCriteria {
  id                String                @id @default(cuid())
  requisitionId     String                @unique
  financialWeight   Int
  technicalWeight   Int
  requisition       PurchaseRequisition   @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  financialCriteria FinancialCriterion[]
  technicalCriteria TechnicalCriterion[]

  @@map("evaluation_criteria")
}

model FinancialCriterion {
  id                   String             @id @default(cuid())
  name                 String
  weight               Int
  evaluationCriteriaId String
  evaluationCriteria   EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
  scores               Score[]

  @@map("financial_criteria")
}

model TechnicalCriterion {
  id                   String             @id @default(cuid())
  name                 String
  weight               Int
  evaluationCriteriaId String
  evaluationCriteria   EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
  scores               Score[]

  @@map("technical_criteria")
}

model StandbyAssignment {
  id                String              @id @default(cuid())
  requisitionId     String
  requisitionItemId String
  quotationId       String
  rank              Int
  requisition       PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionItem   RequisitionItem     @relation(fields: [requisitionItemId], references: [id])
  quotation         Quotation           @relation(fields: [quotationId], references: [id])

  @@map("standby_assignments")
}

model Quotation {
  id                    String              @id @default(cuid())
  transactionId         String
  requisitionId         String
  vendorId              String
  vendorName            String
  totalPrice            Float
  deliveryDate          DateTime
  status                QuotationStatus
  notes                 String?
  rank                  Int?
  finalAverageScore     Float?
  cpoDocumentUrl        String?
  experienceDocumentUrl String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  requisition           PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  vendor                Vendor              @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  items                 QuoteItem[]
  answers               QuoteAnswer[]
  scores                CommitteeScoreSet[]
  standbyAssignments    StandbyAssignment[]

  @@map("quotations")
}

model QuoteItem {
  id                String    @id @default(cuid())
  requisitionItemId String
  name              String
  quantity          Int
  unitPrice         Float
  leadTimeDays      Int
  brandDetails      String?
  quotationId       String
  quotation         Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  requisitionItem   RequisitionItem @relation(fields: [requisitionItemId], references: [id])

  @@map("quote_items")
}

model QuoteAnswer {
  id          String         @id @default(cuid())
  questionId  String
  answer      String
  quotationId String
  quotation   Quotation      @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  question    CustomQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("quote_answers")
}

model CommitteeScoreSet {
  id               String      @id @default(cuid())
  quotationId      String
  scorerId         String
  finalScore       Float
  committeeComment String?
  submittedAt      DateTime    @default(now())
  quotation        Quotation   @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  scorer           User        @relation(fields: [scorerId], references: [id], onDelete: Cascade)
  itemScores       ItemScore[]

  @@unique([quotationId, scorerId])
  @@map("committee_score_sets")
}

model ItemScore {
  id         String            @id @default(cuid())
  scoreSetId String
  quoteItemId String
  finalScore Float
  scoreSet   CommitteeScoreSet @relation(fields: [scoreSetId], references: [id], onDelete: Cascade)
  scores     Score[]

  @@map("item_scores")
}

model Score {
  id                   String              @id @default(cuid())
  itemScoreId          String
  score                Float
  comment              String?
  type                 ScoreType
  financialCriterionId String?
  technicalCriterionId String?
  itemScore            ItemScore           @relation(fields: [itemScoreId], references: [id], onDelete: Cascade)
  financialCriterion   FinancialCriterion? @relation(fields: [financialCriterionId], references: [id])
  technicalCriterion   TechnicalCriterion? @relation(fields: [technicalCriterionId], references: [id])

  @@map("scores")
}

model CommitteeAssignment {
  userId        String
  requisitionId String
  scoresSubmitted Boolean @default(false)

  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)

  @@id([userId, requisitionId])
  @@map("committee_assignments")
}

model PurchaseOrder {
  id               String             @id @default(cuid())
  transactionId    String
  requisitionId    String
  requisitionTitle String
  vendorId         String
  totalAmount      Float
  status           PurchaseOrderStatus
  notes            String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  requisition      PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  vendor           Vendor             @relation(fields: [vendorId], references: [id])
  items            POItem[]
  receipts         GoodsReceiptNote[]
  invoices         Invoice[]

  @@map("purchase_orders")
}

model POItem {
  id                String          @id @default(cuid())
  name              String
  quantity          Int
  unitPrice         Float
  totalPrice        Float
  receivedQuantity  Int
  requisitionItemId String
  purchaseOrderId   String
  purchaseOrder     PurchaseOrder   @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  requisitionItem   RequisitionItem @relation(fields: [requisitionItemId], references: [id])
  receiptItems      ReceiptItem[]

  @@map("po_items")
}

model GoodsReceiptNote {
  id              String      @id @default(cuid())
  transactionId   String
  purchaseOrderId String
  receivedById    String
  receivedDate    DateTime    @default(now())
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  receivedBy      User        @relation(fields: [receivedById], references: [id])
  items           ReceiptItem[]

  @@map("goods_receipt_notes")
}

model ReceiptItem {
  id               String           @id @default(cuid())
  poItemId         String
  quantityReceived Int
  condition        ReceiptCondition
  notes            String?
  grnId            String
  grn              GoodsReceiptNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
  poItem           POItem           @relation(fields: [poItemId], references: [id])

  @@map("receipt_items")
}

model Invoice {
  id                 String        @id @default(cuid())
  transactionId      String
  purchaseOrderId    String
  vendorId           String
  invoiceDate        DateTime
  totalAmount        Float
  status             InvoiceStatus
  documentUrl        String?
  paymentDate        DateTime?
  paymentReference   String?
  paymentEvidenceUrl String?
  po                 PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  items              InvoiceItem[]

  @@map("invoices")
}

model InvoiceItem {
  id          String  @id @default(cuid())
  name        String
  quantity    Int
  unitPrice   Float
  totalPrice  Float
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_items")
}

model AuditLog {
  id            String    @id @default(cuid())
  transactionId String?
  timestamp     DateTime  @default(now())
  userId        String?
  action        String
  entity        String
  entityId      String
  details       String
  user          User?     @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model Review {
  id            String              @id @default(cuid())
  requisitionId String
  reviewerId    String
  decision      String // "APPROVED", "REJECTED"
  comment       String?
  createdAt     DateTime            @default(now())
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  reviewer      User                @relation(fields: [reviewerId], references: [id])

  @@map("reviews")
}

model Minute {
  id             String                @id @default(cuid())
  requisitionId  String
  authorId       String
  author         User                  @relation("author", fields: [authorId], references: [id])
  decision       MinuteDecision
  decisionBody   String
  justification  String
  attendeeIds    String[]
  attendees      User[]                @relation("MinuteAttendees")
  createdAt      DateTime              @default(now())
  requisition    PurchaseRequisition   @relation(fields: [requisitionId], references: [id], onDelete: Cascade)

  @@map("minutes")
}

model Contract {
  id             String              @id @default(cuid())
  contractNumber String              @unique @default(cuid())
  requisitionId  String
  vendorId       String
  senderId       String
  startDate      DateTime
  endDate        DateTime
  filePath       String?
  status         ContractStatus
  createdAt      DateTime            @default(now())
  requisition    PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  vendor         Vendor              @relation(fields: [vendorId], references: [id])
  sender         User                @relation(fields: [senderId], references: [id])

  @@map("contracts")
}

// Settings Models
model Setting {
  key   String @id
  value Json

  @@map("settings")
}

model Role {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?

  @@map("roles")
}

model ApprovalThreshold {
  id    String         @id @default(cuid())
  name  String         @unique
  min   Float
  max   Float?
  steps ApprovalStep[]

  @@map("approval_thresholds")
}

model ApprovalStep {
  id          String            @id @default(cuid())
  thresholdId String
  role        UserRole
  order       Int
  threshold   ApprovalThreshold @relation(fields: [thresholdId], references: [id], onDelete: Cascade)

  @@map("approval_steps")
}


enum UserRole {
  Requester
  Approver
  Procurement_Officer
  Finance
  Admin
  Receiving
  Vendor
  Committee_Member
  Committee
  Committee_A_Member
  Committee_B_Member
  Manager_Procurement_Division
  Director_Supply_Chain_and_Property_Management
  VP_Resources_and_Facilities
  President
}

enum KycStatus {
  Pending
  Verified
  Rejected
}

enum RequisitionStatus {
  Draft
  Pending_Approval
  Rejected
  PreApproved
  Accepting_Quotes
  Scoring_In_Progress
  Scoring_Complete
  Awarded
  Award_Declined
  PostApproved
  PO_Created
  Fulfilled
  Closed
  Pending_Committee_B_Review
  Pending_Committee_A_Recommendation
  Pending_Managerial_Approval
  Pending_Director_Approval
  Pending_VP_Approval
  Pending_President_Approval
}

enum Urgency {
  Low
  Medium
  High
  Critical
}

enum QuestionType {
  text
  boolean
  multiple_choice
  file
}

enum ScoreType {
  FINANCIAL
  TECHNICAL
}

enum ReceiptCondition {
  Good
  Damaged
  Incorrect
}

enum PurchaseOrderStatus {
  Issued
  Acknowledged
  Shipped
  Partially_Delivered
  Delivered
  Cancelled
  Matched
  Mismatched
  On_Hold
  Closed
}

enum InvoiceStatus {
  Pending
  Approved_for_Payment
  Paid
  Disputed
}

enum QuotationStatus {
  Submitted
  Awarded
  Partially_Awarded
  Rejected
  Standby
  Invoice_Submitted
  Failed
  Accepted
  Declined
  Pending_Award
}

enum MinuteDecision {
  APPROVED
  REJECTED
  REVISION
}

enum ContractStatus {
  Draft
  Active
  Expired
}
