// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                                    String                                 @id @default(cuid())
  name                                  String?
  email                                 String?                                @unique
  emailVerified                         DateTime?
  image                                 String?
  password                              String?
  role                                  String                                 @default("Requester")
  createdAt                             DateTime                               @default(now())
  updatedAt                             DateTime                               @updatedAt
  departmentId                          String?
  vendorId                              String?                                @unique
  managerId                             String?
  department                            Department?                            @relation(fields: [departmentId], references: [id])
  vendor                                Vendor?
  accounts                              Account[]
  sessions                              Session[]
  requisitions                          PurchaseRequisition[]                  @relation("Requester")
  approvals                             PurchaseRequisition[]                  @relation("Approver")
  currentApprovals                      PurchaseRequisition[]                  @relation("CurrentApprover")
  financialCommitteeAssignments         PurchaseRequisition[]                  @relation("FinancialCommittee")
  technicalCommitteeAssignments         PurchaseRequisition[]                  @relation("TechnicalCommittee")
  manager                               User?                                  @relation("ManagerSubordinates", fields: [managerId], references: [id])
  subordinates                          User[]                                 @relation("ManagerSubordinates")
  goodsReceipts                         GoodsReceiptNote[]
  reviews                               Review[]
  committeeAssignments                  CommitteeAssignment[]
  auditLogs                             AuditLog[]
  authoredMinutes                       Minute[]                               @relation("Author")
  attendedMinutes                       Minute[]                               @relation("Attendees")
  contractsSent                         Contract[]
  committeeScores                       CommitteeScoreSet[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Department {
  id          String                @id @default(cuid())
  name        String                @unique
  description String?
  headId      String?               @unique
  users       User[]
  head        User?                 @relation(fields: [headId], references: [id])
  requisitions PurchaseRequisition[]
}

model Role {
  id          String @id @default(cuid())
  name        String @unique
  description String?
}

// === PROCUREMENT MODELS ===

model PurchaseRequisition {
  id                   String     @id @default(cuid())
  transactionId        String     @unique @default(cuid())
  title                String
  justification        String
  status               String
  urgency              String
  totalPrice           Float
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  requesterId          String
  departmentId         String
  approverId           String?
  approverComment      String?
  currentApproverId    String?
  purchaseOrderId      String?    @unique
  deadline             DateTime?
  scoringDeadline      DateTime?
  awardResponseDeadline DateTime?
  awardResponseDurationMinutes Int?
  committeeName        String?
  committeePurpose     String?
  cpoAmount            Float?
  
  allowedVendorIds      String[]
  awardedQuoteItemIds   String[]
  rfqSettings           Json?

  requester             User                   @relation("Requester", fields: [requesterId], references: [id])
  department            Department             @relation(fields: [departmentId], references: [id])
  approver              User?                  @relation("Approver", fields: [approverId], references: [id])
  currentApprover       User?                  @relation("CurrentApprover", fields: [currentApproverId], references: [id])
  items                 RequisitionItem[]
  customQuestions       CustomQuestion[]
  quotations            Quotation[]
  reviews               Review[]
  committeeAssignments  CommitteeAssignment[]
  financialCommitteeMembers User[]             @relation("FinancialCommittee")
  technicalCommitteeMembers User[]             @relation("TechnicalCommittee")
  evaluationCriteria    EvaluationCriteria?
  contract              Contract?
  minutes               Minute[]
}

model RequisitionItem {
  id            String  @id @default(cuid())
  requisitionId String
  name          String
  description   String?
  quantity      Int
  unitPrice     Float?
  
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  quoteItems    QuoteItem[]
  poItems       POItem[]
  standbyAssignments StandbyAssignment[]
}

model CustomQuestion {
    id              String @id @default(cuid())
    requisitionId   String
    questionText    String
    questionType    String // text, boolean, multiple_choice, file
    isRequired      Boolean @default(false)
    options         String[]
    requisitionItemId String?
    
    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    answers     QuoteAnswer[]
}

model Vendor {
  id            String      @id @default(cuid())
  name          String
  contactPerson String
  email         String      @unique
  phone         String
  address       String
  kycStatus     String      @default("Pending")
  rejectionReason String?
  userId        String      @unique
  
  user              User
  quotations        Quotation[]
  kycDocuments      KYC_Document[]
  purchaseOrders    PurchaseOrder[]
  contracts         Contract[]
}

model KYC_Document {
    id          String @id @default(cuid())
    vendorId    String
    name        String
    url         String
    submittedAt DateTime
    
    vendor      Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
}

model Quotation {
    id                  String        @id @default(cuid())
    transactionId       String
    requisitionId       String
    vendorId            String
    vendorName          String
    totalPrice          Float
    deliveryDate        DateTime
    status              String        @default("Submitted") // Submitted, Awarded, Rejected, Standby
    notes               String?
    rank                Int? // 1, 2, 3
    finalAverageScore   Float?
    cpoDocumentUrl      String?
    experienceDocumentUrl String?
    createdAt           DateTime      @default(now())
    updatedAt           DateTime      @updatedAt
    
    requisition         PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    vendor              Vendor              @relation(fields: [vendorId], references: [id])
    items               QuoteItem[]
    answers             QuoteAnswer[]
    scores              CommitteeScoreSet[]
    standbyAssignments  StandbyAssignment[]
}

model QuoteItem {
    id                 String   @id @default(cuid())
    quotationId        String
    requisitionItemId  String
    name               String
    quantity           Int
    unitPrice          Float
    leadTimeDays       Int
    brandDetails       String?

    quotation          Quotation           @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    requisitionItem    RequisitionItem     @relation(fields: [requisitionItemId], references: [id])
    scores             ItemScore[]
}

model QuoteAnswer {
    id          String   @id @default(cuid())
    quotationId String
    questionId  String
    answer      String

    quotation   Quotation       @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    question    CustomQuestion  @relation(fields: [questionId], references: [id])
}

model CommitteeScoreSet {
    id               String @id @default(cuid())
    quotationId      String
    scorerId         String
    scorer           User        @relation(fields: [scorerId], references: [id])
    finalScore       Float
    committeeComment String?
    submittedAt      DateTime @default(now())
    
    quotation        Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    itemScores       ItemScore[]

    @@unique([quotationId, scorerId])
}

model ItemScore {
    id          String   @id @default(cuid())
    scoreSetId  String
    quoteItemId String
    finalScore  Float
    
    scoreSet    CommitteeScoreSet @relation(fields: [scoreSetId], references: [id], onDelete: Cascade)
    quoteItem   QuoteItem         @relation(fields: [quoteItemId], references: [id])
    scores      Score[]
}

model Score {
    id            String  @id @default(cuid())
    itemScoreId   String
    score         Int
    comment       String?
    type          String // FINANCIAL or TECHNICAL
    
    financialCriterionId String?
    technicalCriterionId String?

    itemScore      ItemScore @relation(fields: [itemScoreId], references: [id], onDelete: Cascade)
    financialCriterion FinancialCriterion? @relation(fields: [financialCriterionId], references: [id])
    technicalCriterion TechnicalCriterion? @relation(fields: [technicalCriterionId], references: [id])
}

model StandbyAssignment {
    id                String              @id @default(cuid())
    requisitionId     String
    requisitionItemId String
    requisitionItem   RequisitionItem     @relation(fields: [requisitionItemId], references: [id], onDelete: Cascade)
    quotationId       String
    rank              Int // 2 or 3

    requisition       PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    quotation         Quotation           @relation(fields: [quotationId], references: [id])
}

model EvaluationCriteria {
    id String @id @default(cuid())
    requisitionId String @unique
    financialWeight Int
    technicalWeight Int

    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    financialCriteria FinancialCriterion[]
    technicalCriteria TechnicalCriterion[]
}

model FinancialCriterion {
    id String @id @default(cuid())
    evaluationCriteriaId String
    name String
    weight Int

    evaluationCriteria EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
    scores Score[]
}

model TechnicalCriterion {
    id String @id @default(cuid())
    evaluationCriteriaId String
    name String
    weight Int

    evaluationCriteria EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
    scores Score[]
}

model Contract {
    id                String     @id @default(cuid())
    contractNumber    String     @unique @default(cuid())
    requisitionId     String     @unique
    vendorId          String
    senderId          String
    startDate         DateTime
    endDate           DateTime
    filePath          String?
    status            String
    createdAt         DateTime   @default(now())

    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    vendor      Vendor              @relation(fields: [vendorId], references: [id])
    sender      User                @relation(fields: [senderId], references: [id])
}

model PurchaseOrder {
    id                 String   @id @default(cuid())
    transactionId      String
    requisitionId      String
    requisitionTitle   String
    vendorId           String
    totalAmount        Float
    status             String
    createdAt          DateTime @default(now())
    
    requisition        PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    vendor             Vendor              @relation(fields: [vendorId], references: [id])
    items              POItem[]
    receipts           GoodsReceiptNote[]
    invoices           Invoice[]
}

model POItem {
    id                 String  @id @default(cuid())
    poId               String
    requisitionItemId  String
    name               String
    quantity           Int
    unitPrice          Float
    totalPrice         Float
    receivedQuantity   Int     @default(0)
    
    po                 PurchaseOrder      @relation(fields: [poId], references: [id], onDelete: Cascade)
    requisitionItem    RequisitionItem    @relation(fields: [requisitionItemId], references: [id])
    receiptItems       ReceiptItem[]
}

model GoodsReceiptNote {
    id                 String   @id @default(cuid())
    transactionId      String
    purchaseOrderId    String
    receivedById       String
    receivedDate       DateTime @default(now())

    purchaseOrder      PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
    receivedBy         User          @relation(fields: [receivedById], references: [id])
    items              ReceiptItem[]
}

model ReceiptItem {
    id                 String  @id @default(cuid())
    grnId              String
    poItemId           String
    quantityReceived   Int
    condition          String
    notes              String?
    
    grn                GoodsReceiptNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
    poItem             POItem           @relation(fields: [poItemId], references: [id])
}

model Invoice {
    id                 String    @id @default(cuid())
    transactionId      String
    purchaseOrderId    String
    vendorId           String
    invoiceDate        DateTime
    totalAmount        Float
    status             String
    documentUrl        String?
    paymentDate        DateTime?
    paymentReference   String?
    paymentEvidenceUrl String?
    
    po                 PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
    items              InvoiceItem[]
}

model InvoiceItem {
    id                 String @id @default(cuid())
    invoiceId          String
    name               String
    quantity           Int
    unitPrice          Float
    totalPrice         Float
    
    invoice            Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id            String   @id @default(cuid())
  transactionId String?
  timestamp     DateTime @default(now())
  userId        String?
  action        String
  entity        String
  entityId      String
  details       String

  user User? @relation(fields: [userId], references: [id])
}

model Review {
    id            String @id @default(cuid())
    requisitionId String
    reviewerId    String
    decision      String // APPROVED, REJECTED
    comment       String?
    createdAt     DateTime @default(now())

    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    reviewer    User                @relation(fields: [reviewerId], references: [id])
}

model CommitteeAssignment {
    userId          String
    requisitionId   String
    scoresSubmitted Boolean @default(false)
    
    user            User                @relation(fields: [userId], references: [id])
    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])

    @@id([userId, requisitionId])
}

model Setting {
    key     String @id
    value   Json
}

model ApprovalStep {
    id          String @id @default(cuid())
    thresholdId String
    role        String
    order       Int

    threshold   ApprovalThreshold @relation(fields: [thresholdId], references: [id], onDelete: Cascade)
}

model ApprovalThreshold {
    id    String  @id @default(cuid())
    name  String
    min   Float
    max   Float?

    steps ApprovalStep[]
}

model Minute {
    id             String   @id @default(cuid())
    requisitionId  String
    authorId       String
    decision       String // APPROVED, REJECTED, REVISION
    decisionBody   String // e.g., "Committee A", "VP Resources"
    justification  String
    createdAt      DateTime @default(now())
    
    requisition    PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    author         User                @relation("Author", fields: [authorId], references: [id])
    attendees      User[]              @relation("Attendees")
}
