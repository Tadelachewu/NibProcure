
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                                 String                       @id @default(cuid())
  name                               String
  email                              String                       @unique
  password                           String
  roles                              Role[]                       @relation("UserRoles")
  departmentId                       String?
  department                         Department?                  @relation(fields: [departmentId], references: [id])
  managingDepartment               Department?                  @relation("DepartmentHead")
  vendorId                           String?                      @unique
  vendor                             Vendor?                      @relation(fields: [vendorId], references: [id])
  createdRequisitions                PurchaseRequisition[]        @relation("Requester")
  approvedRequisitions               PurchaseRequisition[]        @relation("Approver")
  currentApprovals                   PurchaseRequisition[]        @relation("CurrentApprover")
  financialCommitteeMembersOn        PurchaseRequisition[]        @relation("FinancialCommittee")
  technicalCommitteeMembersOn        PurchaseRequisition[]        @relation("TechnicalCommittee")
  committeeAssignments               CommitteeAssignment[]
  createdAuditLogs                   AuditLog[]
  goodsReceipts                      GoodsReceiptNote[]
  authoredMinutes                    Minute[]                     @relation("MinuteAuthor")
  attendedMinutes                    Minute[]                     @relation("MinuteAttendees")
  sentContracts                      Contract[]
  signatures                         Signature[]
  scoresMade                         CommitteeScoreSet[]
}

model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  headId      String?  @unique
  head        User?    @relation("DepartmentHead", fields: [headId], references: [id])
  users       User[]
  requisitions PurchaseRequisition[]
}

model Role {
    id          String   @id @default(cuid())
    name        String   @unique
    description String?
    users       User[]   @relation("UserRoles")
    approvalSteps ApprovalStep[]
}

model Setting {
    key String @id
    value Json
}


// --- PROCUREMENT CORE MODELS ---

model PurchaseRequisition {
  id                  String   @id @default(cuid())
  transactionId       String   @unique @default(cuid())

  // Core Details
  title               String
  justification       String
  status              String   @default("Draft") // RequisitionStatus enum
  urgency             String   @default("Low") // Urgency enum
  totalPrice          Float
  
  // Requester & Department
  requesterId         String
  requester           User     @relation("Requester", fields: [requesterId], references: [id])
  departmentId        String
  department          Department @relation(fields: [departmentId], references: [id])
  
  // Approval Chain
  approverId          String?  // Legacy approver
  approver            User?    @relation("Approver", fields: [approverId], references: [id])
  approverComment     String?
  currentApproverId   String?
  currentApprover     User?    @relation("CurrentApprover", fields: [currentApproverId], references: [id])

  // Timestamps & Deadlines
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  deadline            DateTime? // Vendor quote submission deadline
  scoringDeadline     DateTime? // Committee scoring deadline
  awardResponseDeadline DateTime?
  awardResponseDurationMinutes Int?

  // RFQ & Award Details
  allowedVendorIds      String[]
  awardedQuoteItemIds   String[]
  rfqSettings           Json?
  
  // Committee
  committeeName         String?
  committeePurpose      String?
  financialCommitteeMembers User[] @relation("FinancialCommittee")
  technicalCommitteeMembers User[] @relation("TechnicalCommittee")
  committeeAssignments  CommitteeAssignment[]
  
  // Relations
  items               RequisitionItem[]
  customQuestions     CustomQuestion[]
  evaluationCriteria  EvaluationCriteria?
  quotations          Quotation[]
  purchaseOrders      PurchaseOrder[]
  reviews             Review[]
  minutes             Minute[]
  contracts           Contract[]
  standbyAssignments  StandbyAssignment[]

  // For re-tender process
  parentId            String?
  parent              PurchaseRequisition? @relation("ReTender", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children            PurchaseRequisition[] @relation("ReTender")
}

model RequisitionItem {
  id                   String       @id @default(cuid())
  name                 String
  description          String?
  quantity             Int
  unitPrice            Float
  requisitionId        String
  requisition          PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  quoteItems           QuoteItem[]
  poItems              POItem[]
  perItemAwardDetails  Json?
}

model CustomQuestion {
  id              String   @id @default(cuid())
  requisitionId   String
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  questionText    String
  questionType    String   // 'text', 'boolean', 'multiple_choice', 'file'
  isRequired      Boolean  @default(true)
  options         String[]
  answers         QuoteAnswer[]
}

model EvaluationCriteria {
  id                  String   @id @default(cuid())
  requisitionId       String   @unique
  requisition         PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  financialWeight     Float
  technicalWeight     Float
  financialCriteria   FinancialCriterion[]
  technicalCriteria   TechnicalCriterion[]
}

model FinancialCriterion {
  id                  String   @id @default(cuid())
  evaluationCriteriaId String
  evaluationCriteria  EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id])
  name                String
  weight              Float
  scores              Score[]
}

model TechnicalCriterion {
  id                  String   @id @default(cuid())
  evaluationCriteriaId String
  evaluationCriteria  EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id])
  name                String
  weight              Float
  scores              Score[]
}

model Quotation {
  id              String   @id @default(cuid())
  transactionId   String
  requisitionId   String
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  vendorId        String
  vendor          Vendor   @relation(fields: [vendorId], references: [id])
  vendorName      String
  totalPrice      Float
  deliveryDate    DateTime
  status          String   @default("Submitted") // QuotationStatus enum
  notes           String?
  rejectionReason String?
  rank            Int?     @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  cpoDocumentUrl  String?
  experienceDocumentUrl String?

  items           QuoteItem[]
  answers         QuoteAnswer[]
  scores          CommitteeScoreSet[]
  standbyAssignment StandbyAssignment?
}

model QuoteItem {
  id                String   @id @default(cuid())
  quotationId       String
  quotation         Quotation @relation(fields: [quotationId], references: [id])
  requisitionItemId String
  requisitionItem   RequisitionItem @relation(fields: [requisitionItemId], references: [id])
  name              String
  quantity          Int
  unitPrice         Float
  leadTimeDays      Int
  brandDetails      String?
  imageUrl          String?
  scores            ItemScore[]
}

model QuoteAnswer {
  id              String   @id @default(cuid())
  quotationId     String
  quotation       Quotation @relation(fields: [quotationId], references: [id])
  questionId      String
  question        CustomQuestion @relation(fields: [questionId], references: [id])
  answer          String
}

model CommitteeAssignment {
  userId          String
  requisitionId   String
  scoresSubmitted Boolean @default(false)
  user            User @relation(fields: [userId], references: [id])
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])

  @@id([userId, requisitionId])
}

model CommitteeScoreSet {
  id              String      @id @default(cuid())
  quotationId     String
  quotation       Quotation   @relation(fields: [quotationId], references: [id])
  scorerId        String
  scorer          User        @relation(fields: [scorerId], references: [id])
  finalScore      Float       @default(0)
  committeeComment String?
  submittedAt     DateTime    @default(now())
  itemScores      ItemScore[]

  @@unique([quotationId, scorerId])
}

model ItemScore {
    id          String @id @default(cuid())
    scoreSetId  String
    scoreSet    CommitteeScoreSet @relation(fields: [scoreSetId], references: [id])
    quoteItemId String
    quoteItem   QuoteItem @relation(fields: [quoteItemId], references: [id])
    finalScore  Float
    scores      Score[]
}

model Score {
    id String @id @default(cuid())
    itemScoreId String
    itemScore ItemScore @relation(fields: [itemScoreId], references: [id])
    score Int
    comment String
    type String // 'FINANCIAL' or 'TECHNICAL'
    financialCriterionId String?
    financialCriterion   FinancialCriterion? @relation(fields: [financialCriterionId], references: [id])
    technicalCriterionId String?
    technicalCriterion   TechnicalCriterion? @relation(fields: [technicalCriterionId], references: [id])
}

model StandbyAssignment {
    id              String @id @default(cuid())
    requisitionId   String
    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    rank            Int // 2 or 3
    quotationId     String @unique
    quotation       Quotation @relation(fields: [quotationId], references: [id])
    promoted        Boolean @default(false)
}

model Review {
    id          String   @id @default(cuid())
    requisitionId String
    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    committeeType String // e.g., 'A', 'B'
    decision      String // 'Approved', 'Rejected'
    comment       String?
    createdAt     DateTime @default(now())
}

model PurchaseOrder {
  id              String   @id @default(cuid())
  transactionId   String
  requisitionId   String
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  requisitionTitle String
  vendorId        String
  vendor          Vendor   @relation(fields: [vendorId], references: [id])
  totalAmount     Float
  status          String   @default("Issued") // PurchaseOrderStatus enum
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  items           POItem[]
  receipts        GoodsReceiptNote[]
  invoices        Invoice[]
}

model POItem {
  id              String    @id @default(cuid())
  poId            String
  purchaseOrder   PurchaseOrder @relation(fields: [poId], references: [id])
  requisitionItemId String
  requisitionItem RequisitionItem @relation(fields: [requisitionItemId], references: [id])
  name            String
  quantity        Int
  unitPrice       Float
  totalPrice      Float
  receivedQuantity Int      @default(0)
  receiptItems    ReceiptItem[]
}

model GoodsReceiptNote {
  id              String    @id @default(cuid())
  transactionId   String
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  receivedById    String
  receivedBy      User      @relation(fields: [receivedById], references: [id])
  receivedDate    DateTime  @default(now())
  status          String    @default("Pending") // 'Pending', 'Processed', 'Disputed'
  items           ReceiptItem[]
}

model ReceiptItem {
  id                String    @id @default(cuid())
  grnId             String
  goodsReceiptNote  GoodsReceiptNote @relation(fields: [grnId], references: [id])
  poItemId          String
  poItem            POItem    @relation(fields: [poItemId], references: [id])
  quantityReceived  Int
  condition         String    // 'Good', 'Damaged', 'Incorrect'
  notes             String?
}

model Invoice {
  id                String    @id @default(cuid())
  transactionId     String
  purchaseOrderId   String
  purchaseOrder     PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  vendorId          String
  vendor            Vendor    @relation(fields: [vendorId], references: [id])
  invoiceDate       DateTime
  totalAmount       Float
  status            String    @default("Pending") // InvoiceStatus enum
  disputeReason     String?
  documentUrl       String?
  paymentDate       DateTime?
  paymentReference  String?
  paymentEvidenceUrl String?

  items             InvoiceItem[]
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id])
  name        String
  quantity    Int
  unitPrice   Float
  totalPrice  Float
}

model Contract {
    id              String @id @default(cuid())
    contractNumber  String @unique @default(cuid())
    requisitionId   String @unique
    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    vendorId        String
    vendor          Vendor @relation(fields: [vendorId], references: [id])
    senderId        String
    sender          User   @relation(fields: [senderId], references: [id])
    startDate       DateTime
    endDate         DateTime
    filePath        String?
    status          String // 'Draft', 'Active', 'Expired'
    createdAt       DateTime @default(now())
}

model Vendor {
  id                String    @id @default(cuid())
  name              String
  contactPerson     String
  email             String    @unique
  phone             String
  address           String
  kycStatus         String    // 'Pending', 'Verified', 'Rejected'
  rejectionReason   String?
  userId            String    @unique
  user              User?
  
  kycDocuments      KYC_Document[]
  quotations        Quotation[]
  purchaseOrders    PurchaseOrder[]
  invoices          Invoice[]
  contracts         Contract[]
}

model KYC_Document {
  id          String   @id @default(cuid())
  vendorId    String
  vendor      Vendor   @relation(fields: [vendorId], references: [id])
  name        String   // e.g., 'Business License', 'Tax ID'
  url         String
  submittedAt DateTime
}


model AuditLog {
  id          String   @id @default(cuid())
  transactionId String
  timestamp   DateTime @default(now())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  action      String
  entity      String
  entityId    String
  details     String
}

model ApprovalStep {
    id          String @id @default(cuid())
    thresholdId String
    threshold   ApprovalThreshold @relation(fields: [thresholdId], references: [id])
    roleId      String
    role        Role @relation(fields: [roleId], references: [id])
    order       Int

    @@unique([thresholdId, order])
}

model ApprovalThreshold {
    id          String @id @default(cuid())
    name        String @unique
    min         Float
    max         Float?
    steps       ApprovalStep[]
}

model Minute {
    id            String @id @default(cuid())
    requisitionId String
    requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    authorId      String
    author        User @relation(name: "MinuteAuthor", fields: [authorId], references: [id])
    decision      String // APPROVED, REJECTED, REVISION
    decisionBody  String
    justification String
    attendees     User[] @relation("MinuteAttendees")
    createdAt     DateTime @default(now())
    type          String // 'system_generated' or 'uploaded_document'
    documentUrl   String?
    signatures    Signature[]
}

model Signature {
    id          String @id @default(cuid())
    minuteId    String
    minute      Minute @relation(fields: [minuteId], references: [id])
    signerId    String
    signer      User   @relation(fields: [signerId], references: [id])
    signerName  String
    signerRole  String
    decision    String // APPROVED, REJECTED
    comment     String
    signedAt    DateTime @default(now())
}
