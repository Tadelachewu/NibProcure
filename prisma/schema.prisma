
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model PurchaseRequisition {
  id                String        @id @default(cuid())
  transactionId     String        @unique @default(cuid())
  requester         User          @relation("UserRequisitions", fields: [requesterId], references: [id])
  requesterId       String
  department        Department    @relation(fields: [departmentId], references: [id])
  departmentId      String
  title             String
  justification     String        @db.Text
  status            RequisitionStatus @default(Draft)
  urgency           UrgencyLevel  @default(Low)
  totalPrice        Float
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Departmental Approval
  approverId        String?
  approver          User?         @relation("UserApprovals", fields: [approverId], references: [id])
  approverComment   String?
  
  // Hierarchical/Committee Approval
  currentApproverId String?
  currentApprover   User?         @relation("UserCurrentApprovals", fields: [currentApproverId], references: [id])
  reviews           Review[]

  // RFQ Details
  allowedVendorIds          String[]
  deadline                  DateTime?
  awardResponseDeadline     DateTime?
  awardResponseDurationMinutes Int?
  cpoAmount                 Float?
  rfqSettings               Json?

  // Items
  items             RequisitionItem[]
  
  // Quotations
  quotations        Quotation[]
  
  // Evaluation Committee
  committeeName               String?
  committeePurpose            String?
  scoringDeadline             DateTime?
  financialCommitteeMembers   User[]                      @relation("FinancialCommitteeMembers")
  technicalCommitteeMembers   User[]                      @relation("TechnicalCommitteeMembers")
  committeeAssignments        CommitteeAssignment[]

  // Award Details
  awardedQuoteItemIds String[]
  
  // Documents
  customQuestions   CustomQuestion[]
  evaluationCriteria EvaluationCriteria?
  contracts         Contract[]
  purchaseOrders    PurchaseOrder[]
  minutes           Minute[]

  // For tracking restarted RFQs
  parentId      String?
  parent        PurchaseRequisition? @relation("RequisitionRestarts", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children      PurchaseRequisition[] @relation("RequisitionRestarts")

  @@index([requesterId])
  @@index([departmentId])
  @@index([approverId])
  @@index([currentApproverId])
}

model RequisitionItem {
  id              String  @id @default(cuid())
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionId   String
  name            String
  description     String? @db.Text
  quantity        Int
  unitPrice       Float
  
  // Per-item award tracking
  perItemAwardDetails Json?
  
  // For re-opened RFQs on specific items
  reopenDeadline    DateTime?
  reopenVendorIds   String[]

  quoteItems      QuoteItem[]
  poItems         POItem[]
  
  @@index([requisitionId])
}

model Department {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  headId      String?   @unique
  head        User?     @relation("DepartmentHead", fields: [headId], references: [id])
  users       User[]    @relation("UserDepartment")
  requisitions PurchaseRequisition[]
}

model User {
  id                  String       @id @default(cuid())
  email               String       @unique
  name                String
  password            String
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  
  departmentId        String?
  department          Department?  @relation("UserDepartment", fields: [departmentId], references: [id])
  
  roles               Role[]

  // For Vendors
  vendorId            String?      @unique
  vendor              Vendor?      @relation(fields: [vendorId], references: [id])

  // Requisitions
  requisitions        PurchaseRequisition[] @relation("UserRequisitions")
  approvals           PurchaseRequisition[] @relation("UserApprovals")
  currentApprovals    PurchaseRequisition[] @relation("UserCurrentApprovals")
  
  // Department Head
  managingDepartment  Department?  @relation("DepartmentHead")

  // Audits
  auditLogs           AuditLog[]

  // Committees
  financialCommittees   PurchaseRequisition[] @relation("FinancialCommitteeMembers")
  technicalCommittees   PurchaseRequisition[] @relation("TechnicalCommitteeMembers")
  committeeAssignments  CommitteeAssignment[]
  
  // Reviews
  reviews             Review[]
  
  // Contracts & Standby
  sentContracts       Contract[]
  standbyAssignments  StandbyAssignment[]
  
  // Goods Receipt
  goodsReceiptNotes   GoodsReceiptNote[]
  
  // Minutes
  authoredMinutes     Minute[] @relation("AuthoredMinutes")
  attendedMinutes     Minute[] @relation("AttendedMinutes")

  @@index([departmentId])
}

model Role {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  users       User[]
  approvalSteps ApprovalStep[]
}

model AuditLog {
  id              String    @id @default(cuid())
  transactionId   String?
  user            User?     @relation(fields: [userId], references: [id])
  userId          String?
  timestamp       DateTime  @default(now())
  action          String
  entity          String
  entityId        String
  details         String    @db.Text
  
  @@index([userId])
  @@index([transactionId])
}

model Vendor {
  id              String    @id @default(cuid())
  name            String
  contactPerson   String
  email           String    @unique
  phone           String
  address         String
  kycStatus       KYCStatus @default(Pending)
  rejectionReason String?
  
  userId          String    @unique
  user            User?
  
  kycDocuments    KYC_Document[]
  quotations      Quotation[]
  contracts       Contract[]
  purchaseOrders  PurchaseOrder[]
  
  standbyAssignments StandbyAssignment[]

  @@index([userId])
}

model KYC_Document {
  id          String   @id @default(cuid())
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId    String
  name        String
  url         String
  submittedAt DateTime @default(now())
  
  @@index([vendorId])
}

model CustomQuestion {
    id              String      @id @default(cuid())
    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    requisitionId   String
    questionText    String
    questionType    QuestionType
    isRequired      Boolean     @default(true)
    options         String[]
    
    answers         QuoteAnswer[]
    
    @@index([requisitionId])
}

model Quotation {
    id                  String      @id @default(cuid())
    transactionId       String
    requisition         PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    requisitionId       String
    vendor              Vendor      @relation(fields: [vendorId], references: [id], onDelete: Cascade)
    vendorId            String
    vendorName          String
    items               QuoteItem[]
    totalPrice          Float
    deliveryDate        DateTime
    status              QuotationStatus @default(Submitted)
    notes               String?
    rank                Int?
    finalAverageScore   Float?
    
    cpoDocumentUrl      String?
    experienceDocumentUrl String?

    answers             QuoteAnswer[]
    scores              CommitteeScoreSet[]

    createdAt           DateTime    @default(now())
    updatedAt           DateTime    @updatedAt
    
    @@index([requisitionId])
    @@index([vendorId])
}

model QuoteItem {
    id                  String      @id @default(cuid())
    quotation           Quotation   @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    quotationId         String
    requisitionItem     RequisitionItem @relation(fields: [requisitionItemId], references: [id], onDelete: Restrict)
    requisitionItemId   String
    
    name                String
    quantity            Int
    unitPrice           Float
    leadTimeDays        Int
    brandDetails        String?
    
    scores              ItemScore[]
    
    @@index([quotationId])
    @@index([requisitionItemId])
}

model QuoteAnswer {
    id              String      @id @default(cuid())
    quotation       Quotation   @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    quotationId     String
    question        CustomQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
    questionId      String
    answer          String
    
    @@index([quotationId])
    @@index([questionId])
}

model EvaluationCriteria {
    id                  String @id @default(cuid())
    requisition         PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    requisitionId       String @unique
    financialWeight     Int
    technicalWeight     Int
    financialCriteria   FinancialCriterion[]
    technicalCriteria   TechnicalCriterion[]
}

model FinancialCriterion {
    id                  String @id @default(cuid())
    evaluationCriteria  EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
    evaluationCriteriaId String
    name                String
    weight              Int
    scores              Score[]
    @@index([evaluationCriteriaId])
}

model TechnicalCriterion {
    id                  String @id @default(cuid())
    evaluationCriteria  EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
    evaluationCriteriaId String
    name                String
    weight              Int
    scores              Score[]
    @@index([evaluationCriteriaId])
}

model CommitteeAssignment {
  userId          String
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  requisitionId   String
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  scoresSubmitted Boolean @default(false)
  
  @@id([userId, requisitionId])
  @@index([requisitionId])
}

model CommitteeScoreSet {
    id               String @id @default(cuid())
    quotation        Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    quotationId      String
    scorer           User @relation(fields: [scorerId], references: [id], onDelete: Cascade)
    scorerId         String
    itemScores       ItemScore[]
    committeeComment String?
    finalScore       Float
    submittedAt      DateTime @default(now())

    @@unique([quotationId, scorerId])
    @@index([scorerId])
}

model ItemScore {
  id              String @id @default(cuid())
  scoreSet        CommitteeScoreSet @relation(fields: [scoreSetId], references: [id], onDelete: Cascade)
  scoreSetId      String
  quoteItem       QuoteItem @relation(fields: [quoteItemId], references: [id], onDelete: Cascade)
  quoteItemId     String @unique
  finalScore      Float
  scores          Score[]

  @@index([scoreSetId])
}

model Score {
    id                      String @id @default(cuid())
    itemScore               ItemScore @relation(fields: [itemScoreId], references: [id], onDelete: Cascade)
    itemScoreId             String
    type                    ScoreType
    financialCriterionId    String?
    financialCriterion      FinancialCriterion? @relation(fields: [financialCriterionId], references: [id], onDelete: SetNull)
    technicalCriterionId    String?
    technicalCriterion      TechnicalCriterion? @relation(fields: [technicalCriterionId], references: [id], onDelete: SetNull)
    score                   Float
    comment                 String?
    
    @@index([itemScoreId])
    @@index([financialCriterionId])
    @@index([technicalCriterionId])
}

model StandbyAssignment {
  id            String @id @default(cuid())
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionId String
  vendor        Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId      String
  rank          Int // 2 or 3
  
  @@index([requisitionId])
  @@index([vendorId])
}

model Contract {
  id              String      @id @default(cuid())
  contractNumber  String      @unique @default(cuid())
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  requisitionId   String
  vendor          Vendor      @relation(fields: [vendorId], references: [id])
  vendorId        String
  sender          User        @relation(fields: [senderId], references: [id])
  senderId        String
  startDate       DateTime
  endDate         DateTime
  filePath        String?
  status          ContractStatus @default(Draft)
  createdAt       DateTime    @default(now())
  
  @@index([requisitionId])
  @@index([vendorId])
  @@index([senderId])
}

model PurchaseOrder {
    id              String      @id @default(cuid())
    transactionId   String
    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    requisitionId   String
    requisitionTitle String
    vendor          Vendor      @relation(fields: [vendorId], references: [id])
    vendorId        String
    items           POItem[]
    totalAmount     Float
    status          POStatus    @default(Issued)
    createdAt       DateTime    @default(now())
    receipts        GoodsReceiptNote[]
    invoices        Invoice[]
    
    @@index([requisitionId])
    @@index([vendorId])
}

model POItem {
    id              String      @id @default(cuid())
    po              PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)
    poId            String
    name            String
    quantity        Int
    unitPrice       Float
    totalPrice      Float
    receivedQuantity Int
    
    requisitionItem   RequisitionItem @relation(fields: [requisitionItemId], references: [id], onDelete: Restrict)
    requisitionItemId String

    receiptItems    ReceiptItem[]
    
    @@index([poId])
    @@index([requisitionItemId])
}

model GoodsReceiptNote {
    id              String      @id @default(cuid())
    transactionId   String
    purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
    purchaseOrderId String
    receivedBy      User        @relation(fields: [receivedById], references: [id])
    receivedById    String
    receivedDate    DateTime    @default(now())
    items           ReceiptItem[]
    
    @@index([purchaseOrderId])
    @@index([receivedById])
}

model ReceiptItem {
    id               String @id @default(cuid())
    grn              GoodsReceiptNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
    grnId            String
    poItem           POItem @relation(fields: [poItemId], references: [id], onDelete: Restrict)
    poItemId         String
    quantityReceived Int
    condition        ItemCondition @default(Good)
    notes            String?
    
    @@index([grnId])
    @@index([poItemId])
}

model Invoice {
    id                  String      @id @default(cuid())
    transactionId       String
    purchaseOrder       PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
    purchaseOrderId     String
    vendorId            String
    invoiceDate         DateTime
    items               InvoiceItem[]
    totalAmount         Float
    status              InvoiceStatus @default(Pending)
    documentUrl         String?
    paymentDate         DateTime?
    paymentReference    String?
    paymentEvidenceUrl  String?
    
    @@index([purchaseOrderId])
}

model InvoiceItem {
    id              String @id @default(cuid())
    invoice         Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
    invoiceId       String
    name            String
    quantity        Int
    unitPrice       Float
    totalPrice      Float
    
    @@index([invoiceId])
}

model Review {
  id            String   @id @default(cuid())
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionId String
  reviewer      User     @relation(fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewerId    String
  decision      String // APPROVED, REJECTED
  comment       String?
  createdAt     DateTime @default(now())

  @@unique([requisitionId, reviewerId])
  @@index([reviewerId])
}

model Minute {
  id              String   @id @default(cuid())
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionId   String
  author          User     @relation("AuthoredMinutes", fields: [authorId], references: [id], onDelete: Cascade)
  authorId        String
  decision        String
  decisionBody    String
  justification   String
  attendees       User[]   @relation("AttendedMinutes")
  createdAt       DateTime @default(now())

  @@index([requisitionId])
  @@index([authorId])
}

model Setting {
  key   String @id
  value Json
}

model ApprovalThreshold {
  id        String         @id @default(cuid())
  name      String         @unique
  min       Float
  max       Float?
  steps     ApprovalStep[]
}

model ApprovalStep {
  id          String            @id @default(cuid())
  threshold   ApprovalThreshold @relation(fields: [thresholdId], references: [id], onDelete: Cascade)
  thresholdId String
  role        Role              @relation(fields: [roleId], references: [id])
  roleId      String
  order       Int

  @@index([thresholdId])
  @@index([roleId])
}

enum RequisitionStatus {
  Draft
  Pending_Approval
  Rejected
  PreApproved
  Accepting_Quotes
  Scoring_In_Progress
  Scoring_Complete
  Award_Declined
  Awarded
  PostApproved
  PO_Created
  Fulfilled
  Closed
  Pending_Committee_B_Review
  Pending_Committee_A_Recommendation
  Pending_Managerial_Review
  Pending_Director_Approval
  Pending_VP_Approval
  Pending_President_Approval
  Pending_Managerial_Approval
}

enum UrgencyLevel {
  Low
  Medium
  High
  Critical
}

enum KYCStatus {
  Pending
  Verified
  Rejected
}

enum QuotationStatus {
  Submitted
  Awarded
  Partially_Awarded
  Rejected
  Standby
  Invoice_Submitted
  Failed
  Accepted
  Declined
  Pending_Award
  Failed_to_Award
}

enum QuestionType {
    text
    boolean
    multiple_choice
    file
}

enum ScoreType {
    FINANCIAL
    TECHNICAL
}

enum POStatus {
  Issued
  Acknowledged
  Shipped
  Partially_Delivered
  Delivered
  Cancelled
  Matched
  Mismatched
  On_Hold
  Closed
}

enum ItemCondition {
  Good
  Damaged
  Incorrect
}

enum InvoiceStatus {
  Pending
  Approved_for_Payment
  Paid
  Disputed
}

enum ContractStatus {
  Draft
  Active
  Expired
}
