
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String    @id @default(cuid())
  name             String
  email            String    @unique
  password         String
  role             String
  departmentId     String?
  approvalLimit    Float?
  managerId        String?
  manager          User?     @relation("ManagerSubordinate", fields: [managerId], references: [id])
  subordinates     User[]    @relation("ManagerSubordinate")
  department       Department? @relation("DepartmentMembers", fields: [departmentId], references: [id])
  departmentHeaded Department? @relation("DepartmentHead")
  vendorId         String?   @unique
  vendor           Vendor?   @relation(fields: [vendorId], references: [id])
  auditLogs        AuditLog[]
  createdRequisitions PurchaseRequisition[] @relation("Requester")
  approvedRequisitions PurchaseRequisition[] @relation("Approver")
  currentApprovals    PurchaseRequisition[] @relation("CurrentApprover")
  financialCommittee  PurchaseRequisition[] @relation("FinancialCommitteeMembers")
  technicalCommittee  PurchaseRequisition[] @relation("TechnicalCommitteeMembers")
  committeeAssignments  CommitteeAssignment[]
  createdContracts    Contract[]
  receivedGoods       GoodsReceiptNote[]
  authoredMinutes     Minute[]
  attendedMinutes     Minute[] @relation("MinuteAttendees")
  scores              CommitteeScoreSet[]
}


model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  headId      String?  @unique
  head        User?    @relation("DepartmentHead", fields: [headId], references: [id])
  users       User[]   @relation("DepartmentMembers")
  requisitions PurchaseRequisition[]
}

model PurchaseRequisition {
  id                          String    @id @default(cuid())
  transactionId               String    @unique @default(cuid())
  requesterId                 String
  requester                   User      @relation("Requester", fields: [requesterId], references: [id])
  approverId                  String?
  approver                    User?     @relation("Approver", fields: [approverId], references: [id])
  currentApproverId           String?
  currentApprover             User?     @relation("CurrentApprover", fields: [currentApproverId], references: [id])
  title                       String
  departmentId                String
  department                  Department @relation(fields: [departmentId], references: [id])
  items                       RequisitionItem[]
  totalPrice                  Float
  justification               String
  status                      String
  urgency                     String
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime  @updatedAt
  purchaseOrderId             String?   @unique
  purchaseOrder               PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  allowedVendorIds            String[]
  awardedQuoteItemIds         String[]  @default([])
  customQuestions             CustomQuestion[]
  deadline                    DateTime?
  scoringDeadline             DateTime?
  awardResponseDeadline       DateTime?
  awardResponseDurationMinutes Int?
  evaluationCriteria          EvaluationCriteria?
  financialCommitteeMembers   User[] @relation("FinancialCommitteeMembers")
  technicalCommitteeMembers   User[] @relation("TechnicalCommitteeMembers")
  committeeName               String?
  committeePurpose            String?
  rfqSettings                 Json?
  cpoAmount                   Float?
  quotations                  Quotation[]
  reviews                     Review[]
  contracts                   Contract[]
  committeeAssignments        CommitteeAssignment[]
  minutes                     Minute[]
}

model RequisitionItem {
  id            String   @id @default(cuid())
  requisitionId String
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  quantity      Int
  unitPrice     Float
  quoteItems    QuoteItem[]
  poItems       POItem[]
}

model CustomQuestion {
    id              String @id @default(cuid())
    requisitionId   String
    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    questionText    String
    questionType    String
    isRequired      Boolean
    options         String[]
    answers         QuoteAnswer[]
}

model EvaluationCriteria {
    id String @id @default(cuid())
    requisitionId String @unique
    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    financialWeight Float
    technicalWeight Float
    financialCriteria FinancialCriterion[]
    technicalCriteria TechnicalCriterion[]
}

model FinancialCriterion {
    id String @id @default(cuid())
    evaluationCriteriaId String
    evaluationCriteria EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
    name String
    weight Float
    scores Score[]
}

model TechnicalCriterion {
    id String @id @default(cuid())
    evaluationCriteriaId String
    evaluationCriteria EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
    name String
    weight Float
    scores Score[]
}

model Quotation {
    id String @id @default(cuid())
    transactionId String
    requisitionId String
    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    vendorId String
    vendor Vendor @relation(fields: [vendorId], references: [id])
    vendorName String
    items QuoteItem[]
    totalPrice Float
    deliveryDate DateTime
    createdAt DateTime @default(now())
    status String
    notes String?
    rank Int?
    answers QuoteAnswer[]
    scores CommitteeScoreSet[]
    finalAverageScore Float?
    cpoDocumentUrl String?
    experienceDocumentUrl String?
}

model QuoteItem {
    id String @id @default(cuid())
    quotationId String
    quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    requisitionItemId String
    requisitionItem RequisitionItem @relation(fields: [requisitionItemId], references: [id])
    name String
    quantity Int
    unitPrice Float
    leadTimeDays Int
    brandDetails String?
    itemScores    ItemScore[]
}

model QuoteAnswer {
    id String @id @default(cuid())
    quotationId String
    quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    questionId String
    question CustomQuestion @relation(fields: [questionId], references: [id])
    answer String
}

model CommitteeScoreSet {
    id String @id @default(cuid())
    quotationId String
    quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    scorerId String
    scorer User @relation(fields: [scorerId], references: [id])
    itemScores ItemScore[]
    finalScore Float @default(0)
    committeeComment String?
    submittedAt DateTime @default(now())

    @@unique([quotationId, scorerId])
}

model ItemScore {
    id String @id @default(cuid())
    scoreSetId String
    scoreSet CommitteeScoreSet @relation(fields: [scoreSetId], references: [id], onDelete: Cascade)
    quoteItemId   String
    quoteItem     QuoteItem  @relation(fields: [quoteItemId], references: [id], onDelete: Cascade)
    scores Score[]
    finalScore Float
}

model Score {
    id String @id @default(cuid())
    itemScoreId String
    itemScore ItemScore @relation(fields: [itemScoreId], references: [id], onDelete: Cascade)
    criterionId String
    score Float
    comment String?
    type String // FINANCIAL or TECHNICAL
    financialCriterion FinancialCriterion? @relation(fields: [criterionId], references: [id], onUpdate: NoAction, onDelete: NoAction)
    technicalCriterion TechnicalCriterion? @relation(fields: [criterionId], references: [id], onUpdate: NoAction, onDelete: NoAction)
}

model PurchaseOrder {
  id              String   @id @default(cuid())
  transactionId   String
  requisitionId   String   @unique
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  requisitionTitle String
  vendorId        String
  vendor          Vendor   @relation(fields: [vendorId], references: [id])
  items           POItem[]
  totalAmount     Float
  status          String
  createdAt       DateTime @default(now())
  receipts        GoodsReceiptNote[]
  invoices        Invoice[]
}

model POItem {
    id String @id @default(cuid())
    purchaseOrderId String
    purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
    requisitionItemId String
    requisitionItem RequisitionItem @relation(fields: [requisitionItemId], references: [id])
    name String
    quantity Int
    unitPrice Float
    totalPrice Float
    receivedQuantity Int
    receiptItems ReceiptItem[]
}

model GoodsReceiptNote {
    id String @id @default(cuid())
    transactionId String
    purchaseOrderId String
    purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
    receivedById String
    receivedBy User @relation(fields: [receivedById], references: [id])
    receivedDate DateTime @default(now())
    items ReceiptItem[]
}

model ReceiptItem {
    id String @id @default(cuid())
    goodsReceiptNoteId String
    goodsReceiptNote GoodsReceiptNote @relation(fields: [goodsReceiptNoteId], references: [id], onDelete: Cascade)
    poItemId String
    poItem POItem @relation(fields: [poItemId], references: [id])
    quantityReceived Int
    condition String
    notes String?
}

model Invoice {
    id String @id @default(cuid())
    transactionId String
    purchaseOrderId String
    po PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
    vendorId String
    vendor Vendor @relation(fields: [vendorId], references: [id])
    invoiceDate DateTime
    items InvoiceItem[]
    totalAmount Float
    status String
    documentUrl String?
    paymentDate DateTime?
    paymentReference String?
}

model InvoiceItem {
    id String @id @default(cuid())
    invoiceId String
    invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
    name String
    quantity Int
    unitPrice Float
    totalPrice Float
}

model Vendor {
  id              String   @id @default(cuid())
  user            User?
  name            String
  contactPerson   String
  email           String   @unique
  phone           String
  address         String
  kycStatus       String
  kycDocuments    KYC_Document[]
  rejectionReason String?
  quotations      Quotation[]
  purchaseOrders  PurchaseOrder[]
  invoices        Invoice[]
  contracts       Contract[]
}

model KYC_Document {
  id        String   @id @default(cuid())
  vendorId  String
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  name      String
  url       String
  submittedAt DateTime
}

model AuditLog {
  id            String   @id @default(cuid())
  transactionId String?
  timestamp     DateTime @default(now())
  userId        String?
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action        String
  entity        String
  entityId      String
  details       String
}

model Setting {
    id      String @id @default(cuid())
    key     String @unique
    value   Json
}

model Review {
    id String @id @default(cuid())
    requisitionId String
    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    reviewerId String
    decision String // 'Recommended', 'Rejected'
    comment String?
    createdAt DateTime @default(now())
}

model Contract {
  id String @id @default(cuid())
  contractNumber String @unique @default(cuid())
  requisitionId String
  requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  vendorId String
  vendor Vendor @relation(fields: [vendorId], references: [id])
  senderId String
  sender User @relation(fields: [senderId], references: [id])
  startDate DateTime
  endDate DateTime
  filePath String?
  status String
  createdAt DateTime @default(now())
}

model CommitteeAssignment {
    userId String
    user User @relation(fields: [userId], references: [id])
    requisitionId String
    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    scoresSubmitted Boolean @default(false)
    @@id([userId, requisitionId])
}

model ApprovalThreshold {
    id String @id @default(cuid())
    name String @unique
    min Float
    max Float?
    steps ApprovalStep[]
}

model ApprovalStep {
    id String @id @default(cuid())
    thresholdId String
    threshold ApprovalThreshold @relation(fields: [thresholdId], references: [id], onDelete: Cascade)
    role String // UserRole as a string
    order Int
}

model Minute {
    id String @id @default(cuid())
    requisitionId String
    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    authorId String
    author User @relation(fields: [authorId], references: [id])
    decision String
    decisionBody String
    justification String
    attendees User[] @relation("MinuteAttendees")
    createdAt DateTime @default(now())
}

