// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                                              String                  @id @default(cuid())
  name                                            String
  email                                           String                  @unique
  password                                        String
  roles                                           Role[]
  departmentId                                    String?
  department                                      Department?             @relation(fields: [departmentId], references: [id])
  managingDepartment                              Department?             @relation("DepartmentHead")
  vendorId                                        String?                 @unique
  vendor                                          Vendor?
  requisitions                                    PurchaseRequisition[]   @relation("Requester")
  approvals                                       PurchaseRequisition[]   @relation("Approver")
  auditLogs                                       AuditLog[]
  committeeAssignments                            CommitteeAssignment[]
  createdContracts                                Contract[]
  goodsReceipts                                   GoodsReceiptNote[]
  reviews                                         Review[]
  minutesAuthored                                 Minute[]
  minutesAttended                                 Minute[]                @relation("MinuteAttendees")
  currentRequisitions                             PurchaseRequisition[]   @relation("CurrentApprover")
  financialCommittees                             PurchaseRequisition[]   @relation("FinancialCommittee")
  technicalCommittees                             PurchaseRequisition[]   @relation("TechnicalCommittee")
  scoresGiven                                     CommitteeScoreSet[]
  submittedQuotes                                 Quotation[]

  createdAt                                       DateTime                @default(now())
  updatedAt                                       DateTime                @updatedAt
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  users       User[]
  steps       ApprovalStep[]
}

model Department {
  id          String                @id @default(cuid())
  name        String                @unique
  description String?
  users       User[]
  headId      String?               @unique
  head        User?                 @relation("DepartmentHead", fields: [headId], references: [id])
  requisitions PurchaseRequisition[]
}

model Setting {
  key   String @id
  value Json
}

model PurchaseRequisition {
  id                   String        @id @default(cuid())
  transactionId        String        @unique @default(cuid())
  requesterId          String
  requester            User          @relation("Requester", fields: [requesterId], references: [id])
  departmentId         String
  department           Department    @relation(fields: [departmentId], references: [id])
  title                String
  urgency              String
  justification        String
  status               String
  totalPrice           Float
  items                RequisitionItem[]
  customQuestions      CustomQuestion[]
  evaluationCriteria   EvaluationCriteria?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  approverId           String?
  approver             User?         @relation("Approver", fields: [approverId], references: [id])
  approverComment      String?
  currentApproverId    String?
  currentApprover      User?         @relation("CurrentApprover", fields: [currentApproverId], references: [id])
  financialCommitteeMembers User[]        @relation("FinancialCommittee")
  technicalCommitteeMembers User[]        @relation("TechnicalCommittee")
  committeeAssignments CommitteeAssignment[]
  standbyAssignments   StandbyAssignment[]
  deadline             DateTime?
  scoringDeadline      DateTime?
  cpoAmount            Float?
  rfqSettings          Json?
  allowedVendorIds     String[]
  awardedQuoteItemIds  String[]
  awardResponseDeadline DateTime?
  awardResponseDurationMinutes Int?
  committeeName        String?
  committeePurpose     String?
  quotations           Quotation[]
  purchaseOrders       PurchaseOrder[]
  contract             Contract?
  reviews              Review[]
  minutes              Minute[]
  parentRequisitionId  String?
  parentRequisition    PurchaseRequisition? @relation("RequisitionRestart", fields: [parentRequisitionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  childRequisitions    PurchaseRequisition[] @relation("RequisitionRestart")
}

model RequisitionItem {
  id                   String        @id @default(cuid())
  requisitionId        String
  requisition          PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  name                 String
  quantity             Int
  unitPrice            Float
  description          String?
  quoteItems           QuoteItem[]
  poItems              POItem[]
  perItemAwardDetails  Json?
  reopenDeadline       DateTime?
  reopenVendorIds      String[]
}

model CustomQuestion {
  id             String        @id @default(cuid())
  requisitionId  String
  requisition    PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  questionText   String
  questionType   String // "text", "boolean", "multiple_choice", "file"
  isRequired     Boolean       @default(true)
  options        String[]
  answers        QuoteAnswer[]
}

model EvaluationCriteria {
  id                 String               @id @default(cuid())
  requisitionId      String               @unique
  requisition        PurchaseRequisition  @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  financialWeight    Int
  technicalWeight    Int
  financialCriteria  FinancialCriterion[]
  technicalCriteria  TechnicalCriterion[]
}

model FinancialCriterion {
  id                   String             @id @default(cuid())
  evaluationCriteriaId String
  evaluationCriteria   EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
  name                 String
  weight               Int
  scores               Score[]
}

model TechnicalCriterion {
  id                   String             @id @default(cuid())
  evaluationCriteriaId String
  evaluationCriteria   EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
  name                 String
  weight               Int
  scores               Score[]
}

model Vendor {
  id            String      @id @default(cuid())
  userId        String      @unique
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  contactPerson String
  email         String      @unique
  phone         String
  address       String
  kycStatus     String // Pending, Verified, Rejected
  rejectionReason String?
  kycDocuments  KYC_Document[]
  quotations    Quotation[]
  purchaseOrders PurchaseOrder[]
  contracts     Contract[]

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

model KYC_Document {
  id          String   @id @default(cuid())
  vendorId    String
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  name        String // e.g., 'Business License', 'Tax ID Document'
  url         String
  submittedAt DateTime
}

model CommitteeAssignment {
  userId        String
  requisitionId String
  user          User @relation(fields: [userId], references: [id])
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  scoresSubmitted Boolean @default(false)
  
  @@id([userId, requisitionId])
}

model StandbyAssignment {
  id            String              @id @default(cuid())
  requisitionId String
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  quotationId   String              @unique
  quotation     Quotation           @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  rank          Int
}

model Quotation {
  id              String        @id @default(cuid())
  transactionId   String
  requisitionId   String
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  vendorId        String
  vendor          User          @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorName      String
  items           QuoteItem[]
  totalPrice      Float
  deliveryDate    DateTime
  status          String // Submitted, Awarded, Rejected, Standby, Accepted
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  rank            Int?
  answers         QuoteAnswer[]
  scores          CommitteeScoreSet[]
  finalAverageScore Float?
  cpoDocumentUrl  String?
  experienceDocumentUrl String?
  standbyAssignment StandbyAssignment?
}

model QuoteItem {
  id                String      @id @default(cuid())
  quotationId       String
  quotation         Quotation   @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  requisitionItemId String
  requisitionItem   RequisitionItem @relation(fields: [requisitionItemId], references: [id])
  name              String
  quantity          Int
  unitPrice         Float
  leadTimeDays      Int
  brandDetails      String?
  imageUrl          String?
  scores            ItemScore[]
}

model QuoteAnswer {
  id          String    @id @default(cuid())
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  questionId  String
  question    CustomQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answer      String
}

model CommitteeScoreSet {
    id              String      @id @default(cuid())
    quotationId     String
    quotation       Quotation   @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    scorerId        String
    scorer          User @relation(fields: [scorerId], references: [id])
    committeeComment String?
    finalScore      Float @default(0)
    submittedAt     DateTime    @default(now())
    itemScores      ItemScore[]

    @@unique([quotationId, scorerId])
}

model ItemScore {
  id                String      @id @default(cuid())
  scoreSetId        String
  scoreSet          CommitteeScoreSet @relation(fields: [scoreSetId], references: [id], onDelete: Cascade)
  quoteItemId       String
  quoteItem         QuoteItem   @relation(fields: [quoteItemId], references: [id])
  finalScore        Float
  scores            Score[]
}

model Score {
    id                   String      @id @default(cuid())
    itemScoreId          String
    itemScore            ItemScore   @relation(fields: [itemScoreId], references: [id], onDelete: Cascade)
    score                Int
    comment              String
    type                 String // FINANCIAL or TECHNICAL
    financialCriterionId String?
    financialCriterion   FinancialCriterion? @relation(fields: [financialCriterionId], references: [id])
    technicalCriterionId String?
    technicalCriterion   TechnicalCriterion? @relation(fields: [technicalCriterionId], references: [id])
}

model PurchaseOrder {
    id              String      @id @default(cuid())
    transactionId   String
    requisitionId   String
    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    requisitionTitle String
    vendorId        String
    vendor          Vendor      @relation(fields: [vendorId], references: [id])
    items           POItem[]
    totalAmount     Float
    status          String // Issued, Acknowledged, Shipped, Partially Delivered, Delivered, Cancelled
    createdAt       DateTime    @default(now())
    notes           String?
    receipts        GoodsReceiptNote[]
    invoices        Invoice[]
}

model POItem {
    id                String      @id @default(cuid())
    purchaseOrderId   String
    purchaseOrder     PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
    requisitionItemId String
    requisitionItem   RequisitionItem @relation(fields: [requisitionItemId], references: [id])
    name              String
    quantity          Int
    unitPrice         Float
    totalPrice        Float
    receivedQuantity  Int
    receiptItems      ReceiptItem[]
}

model GoodsReceiptNote {
    id                String      @id @default(cuid())
    transactionId     String
    purchaseOrderId   String
    purchaseOrder     PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
    receivedById      String
    receivedBy        User      @relation(fields: [receivedById], references: [id])
    receivedDate      DateTime    @default(now())
    items             ReceiptItem[]
}

model ReceiptItem {
    id                String      @id @default(cuid())
    grnId             String
    grn               GoodsReceiptNote @relation(fields: [grnId], references: [id])
    poItemId          String
    poItem            POItem      @relation(fields: [poItemId], references: [id])
    quantityReceived  Int
    condition         String // Good, Damaged, Incorrect
    notes             String?
}

model Invoice {
    id                String      @id @default(cuid())
    transactionId     String
    purchaseOrderId   String
    po                PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
    vendorId          String
    invoiceDate       DateTime
    items             InvoiceItem[]
    totalAmount       Float
    status            String // Pending, Approved for Payment, Paid, Disputed
    documentUrl       String?
    paymentDate       DateTime?
    paymentReference  String?
    paymentEvidenceUrl String?
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  name        String
  quantity    Int
  unitPrice   Float
  totalPrice  Float
}

model Contract {
    id              String @id @default(cuid())
    contractNumber  String @unique @default(cuid())
    requisitionId   String @unique
    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    vendorId        String
    vendor          Vendor @relation(fields: [vendorId], references: [id])
    senderId        String
    sender          User @relation(fields: [senderId], references: [id])
    startDate       DateTime
    endDate         DateTime
    filePath        String?
    status          String // Draft, Active, Expired
    createdAt       DateTime @default(now())
}

model AuditLog {
    id            String   @id @default(cuid())
    transactionId String?
    timestamp     DateTime @default(now())
    userId        String?
    user          User?    @relation(fields: [userId], references: [id])
    action        String
    entity        String
    entityId      String
    details       String
}

model ApprovalThreshold {
  id    String         @id @default(cuid())
  name  String         @unique
  min   Float
  max   Float?
  steps ApprovalStep[]
}

model ApprovalStep {
  id          String            @id @default(cuid())
  thresholdId String
  threshold   ApprovalThreshold @relation(fields: [thresholdId], references: [id], onDelete: Cascade)
  roleName    String
  role        Role              @relation(fields: [roleName], references: [name])
  order       Int

  @@unique([thresholdId, order])
}

model Review {
    id            String @id @default(cuid())
    requisitionId String
    requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    minuteId      String?
    minute        Minute? @relation(fields: [minuteId], references: [id])
    reviewerId    String
    reviewer      User @relation(fields: [reviewerId], references: [id])
    decision      String // APPROVED, REJECTED, REVISION_REQUESTED
    comment       String?
    createdAt     DateTime @default(now())

    @@unique([requisitionId, reviewerId]) // A user can only review a requisition once directly
}

model Minute {
  id                String        @id @default(cuid())
  minuteReference   String        @unique @default(cuid())
  requisitionId     String        @unique
  requisition       PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  authorId          String
  author            User          @relation(fields: [authorId], references: [id])
  meetingDate       DateTime
  participants      Json
  procurementSummary Json
  evaluationSummary Json
  systemAnalysis    Json
  awardRecommendation Json
  conclusion        String
  decision          String
  decisionBody      String
  justification     String
  attendees         User[]        @relation("MinuteAttendees")
  auditMetadata     Json
  reviews           Review[]
  createdAt         DateTime      @default(now())
}
