
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                                 String                 @id @default(cuid())
  name                               String
  email                              String                 @unique
  password                           String
  roleId                             String
  role                               Role                   @relation(fields: [roleId], references: [id])
  departmentId                       String?
  department                         Department?            @relation(fields: [departmentId], references: [id])
  managingDepartment                 Department?            @relation("DepartmentHead", fields: [id], references: [headId])
  vendorId                           String?                @unique
  vendor                             Vendor?                @relation(fields: [vendorId], references: [id])
  requisitions                       PurchaseRequisition[]  @relation("Requester")
  approvedRequisitions               PurchaseRequisition[]  @relation("Approver")
  currentApprovals                   PurchaseRequisition[]  @relation("CurrentApprover")
  sentContracts                      Contract[]
  receipts                           GoodsReceiptNote[]
  auditLogs                          AuditLog[]
  financialCommitteeForRequisitions  PurchaseRequisition[]  @relation("FinancialCommittee")
  technicalCommitteeForRequisitions  PurchaseRequisition[]  @relation("TechnicalCommittee")
  committeeAssignments               CommitteeAssignment[]
  reviews                            Review[]
  authoredMinutes                    Minute[]
  attendedMinutes                    Minute[]               @relation("MinuteAttendees")

  @@map("users")
}

model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  headId      String?  @unique
  head        User?    @relation("DepartmentHead")
  users       User[]
  requisitions PurchaseRequisition[]

  @@map("departments")
}

model Role {
  id          String @id @default(cuid())
  name        String @unique
  description String?
  users       User[]

  @@map("roles")
}


model PurchaseRequisition {
  id                   String    @id @default(cuid())
  transactionId        String    @unique @default(cuid())
  title                String
  requesterId          String
  requester            User      @relation("Requester", fields: [requesterId], references: [id])
  departmentId         String
  department           Department @relation(fields: [departmentId], references: [id])
  items                RequisitionItem[]
  customQuestions      CustomQuestion[]
  totalPrice           Float
  justification        String
  urgency              String
  status               String
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  approverId           String?
  approver             User?     @relation("Approver", fields: [approverId], references: [id])
  currentApproverId    String?
  currentApprover      User?      @relation("CurrentApprover", fields: [currentApproverId], references: [id])
  approverComment      String?
  quotations           Quotation[]
  purchaseOrder        PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  purchaseOrderId      String?          @unique
  allowedVendorIds     String[]
  awardedQuoteItemIds  String[]
  deadline             DateTime?
  scoringDeadline      DateTime?
  awardResponseDeadline DateTime?
  awardResponseDurationMinutes Int?
  evaluationCriteria   EvaluationCriteria?
  financialCommitteeMembers User[] @relation("FinancialCommittee")
  technicalCommitteeMembers User[] @relation("TechnicalCommittee")
  committeeAssignments      CommitteeAssignment[]
  reviews                     Review[]
  committeeName        String?
  committeePurpose     String?
  cpoAmount            Float?
  rfqSettings          Json?
  contracts            Contract[]
  minutes              Minute[]
  standbyAssignments   StandbyAssignment[]

  @@map("purchase_requisitions")
}

model RequisitionItem {
  id                  String               @id @default(cuid())
  requisition         PurchaseRequisition  @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionId       String
  name                String
  description         String?
  quantity            Int
  unitPrice           Float
  quoteItems          QuoteItem[]
  poItems             POItem[]
  standbyAssignments  StandbyAssignment[]

  @@map("requisition_items")
}

model CustomQuestion {
    id              String              @id @default(cuid())
    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    requisitionId   String
    questionText    String
    questionType    String
    isRequired      Boolean
    options         String[]
    answers         QuoteAnswer[]

    @@map("custom_questions")
}

model EvaluationCriteria {
    id                  String                  @id @default(cuid())
    requisition         PurchaseRequisition     @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    requisitionId       String                  @unique
    financialWeight     Int
    technicalWeight     Int
    financialCriteria   FinancialCriterion[]
    technicalCriteria   TechnicalCriterion[]

    @@map("evaluation_criteria")
}

model FinancialCriterion {
    id                      String              @id @default(cuid())
    evaluationCriteria      EvaluationCriteria  @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
    evaluationCriteriaId    String
    name                    String
    weight                  Int
    scores                  Score[]             @relation("FinancialScore")

    @@map("financial_criteria")
}

model TechnicalCriterion {
    id                      String              @id @default(cuid())
    evaluationCriteria      EvaluationCriteria  @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
    evaluationCriteriaId    String
    name                    String
    weight                  Int
    scores                  Score[]             @relation("TechnicalScore")

    @@map("technical_criteria")
}

model Quotation {
  id            String    @id @default(cuid())
  transactionId String
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionId String
  vendor        Vendor    @relation(fields: [vendorId], references: [id])
  vendorId      String
  vendorName    String
  items         QuoteItem[]
  totalPrice    Float
  deliveryDate  DateTime
  status        String
  notes         String?
  rank          Int? // 1 for winner, 2 for 2nd standby, etc. (overall)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  answers       QuoteAnswer[]
  scores        CommitteeScoreSet[]
  finalAverageScore Float?
  cpoDocumentUrl String?
  experienceDocumentUrl String?
  standbyAssignments StandbyAssignment[]

  @@map("quotations")
}

model QuoteItem {
  id                String          @id @default(cuid())
  quotation         Quotation       @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  quotationId       String
  requisitionItem   RequisitionItem @relation(fields: [requisitionItemId], references: [id])
  requisitionItemId String
  name              String
  quantity          Int
  unitPrice         Float
  leadTimeDays      Int
  brandDetails      String?
  scores            ItemScore[]
  
  @@map("quote_items")
}

model QuoteAnswer {
    id          String      @id @default(cuid())
    quotation   Quotation   @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    quotationId String
    question    CustomQuestion @relation(fields: [questionId], references: [id])
    questionId  String
    answer      String

    @@map("quote_answers")
}

model CommitteeAssignment {
  userId        String
  requisitionId String
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  scoresSubmitted Boolean @default(false)
  
  @@id([userId, requisitionId])
  @@map("committee_assignments")
}

model CommitteeScoreSet {
    id                  String      @id @default(cuid())
    quotation           Quotation   @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    quotationId         String
    scorer              User        @relation(fields: [scorerId], references: [id])
    scorerId            String
    itemScores          ItemScore[]
    committeeComment    String?
    finalScore          Float
    submittedAt         DateTime    @default(now())

    @@unique([quotationId, scorerId])
    @@map("committee_scores")
}

model ItemScore {
    id          String              @id @default(cuid())
    scoreSet    CommitteeScoreSet   @relation(fields: [scoreSetId], references: [id], onDelete: Cascade)
    scoreSetId  String
    quoteItem   QuoteItem           @relation(fields: [quoteItemId], references: [id])
    quoteItemId String
    scores      Score[]
    finalScore  Float
    
    @@map("item_scores")
}

model Score {
    id                      String                  @id @default(cuid())
    itemScore               ItemScore               @relation(fields: [itemScoreId], references: [id], onDelete: Cascade)
    itemScoreId             String
    score                   Float
    comment                 String?
    type                    String // "FINANCIAL" or "TECHNICAL"
    financialCriterion      FinancialCriterion?     @relation("FinancialScore", fields: [financialCriterionId], references: [id])
    financialCriterionId    String?
    technicalCriterion      TechnicalCriterion?     @relation("TechnicalScore", fields: [technicalCriterionId], references: [id])
    technicalCriterionId    String?

    @@map("scores")
}

model StandbyAssignment {
  id                  String              @id @default(cuid())
  requisition         PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionId       String
  requisitionItem     RequisitionItem     @relation(fields: [requisitionItemId], references