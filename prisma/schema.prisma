// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model User {
  id              String  @id @default(cuid())
  name            String
  email           String  @unique
  password        String
  role            String
  departmentId    String?
  vendorId        String? @unique
  managerId       String?

  departmentHeaded     Department?            @relation("DepartmentHead")
  department           Department?            @relation("DepartmentUsers", fields: [departmentId], references: [id])
  requisitions         PurchaseRequisition[]  @relation("requester")
  approvedRequisitions PurchaseRequisition[]  @relation("approver")
  currentApprovals     PurchaseRequisition[]  @relation("currentApprover")
  vendor               Vendor?                @relation(fields: [vendorId], references: [id])
  auditLogs            AuditLog[]
  receipts             GoodsReceiptNote[]
  contractsSent        Contract[]
  committeeAssignments CommitteeAssignment[]
  reviews              Review[]
  authoredMinutes      Minute[]               @relation("MinuteAuthor")
  attendedMinutes      Minute[]               @relation("MinuteAttendees")
  financialCommittees  PurchaseRequisition[]  @relation("financialCommittee")
  technicalCommittees  PurchaseRequisition[]  @relation("technicalCommittee")

  manager       User?   @relation("ManagerSubordinates", fields: [managerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subordinates  User[]  @relation("ManagerSubordinates")
}

model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  headId      String?  @unique

  users       User[]    @relation("DepartmentUsers")
  head        User?     @relation("DepartmentHead", fields: [headId], references: [id])
  requisitions PurchaseRequisition[]
}

model Role {
    id          String @id @default(cuid())
    name        String @unique
    description String
}

model PurchaseRequisition {
  id                String       @id @default(cuid())
  transactionId     String       @unique @default(cuid())
  requesterId       String
  approverId        String?
  currentApproverId String?
  departmentId      String
  title             String
  urgency           String       @default("Low")
  justification     String
  status            String
  totalPrice        Float
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  approverComment   String?
  deadline          DateTime?
  scoringDeadline   DateTime?
  awardResponseDeadline DateTime?
  awardResponseDurationMinutes Int?
  allowedVendorIds  String[]
  awardedQuoteItemIds String[]
  committeeName     String?
  committeePurpose  String?
  cpoAmount         Float?
  rfqSettings       Json?

  items               RequisitionItem[]
  customQuestions     CustomQuestion[]
  quotations          Quotation[]
  purchaseOrders      PurchaseOrder[]
  requester           User         @relation("requester", fields: [requesterId], references: [id])
  approver            User?        @relation("approver", fields: [approverId], references: [id])
  currentApprover     User?        @relation("currentApprover", fields: [currentApproverId], references: [id])
  department          Department   @relation(fields: [departmentId], references: [id])
  financialCommitteeMembers User[] @relation("financialCommittee")
  technicalCommitteeMembers User[] @relation("technicalCommittee")
  committeeAssignments    CommitteeAssignment[]
  reviews                 Review[]
  contracts               Contract[]
  minutes                 Minute[]
  evaluationCriteria      EvaluationCriteria?
}

model RequisitionItem {
  id            String  @id @default(cuid())
  requisitionId String
  name          String
  quantity      Int
  unitPrice     Float
  description   String?

  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  quoteItems    QuoteItem[]
  poItems       POItem[]
}

model CustomQuestion {
  id            String   @id @default(cuid())
  requisitionId String
  questionText  String
  questionType  String
  isRequired    Boolean
  options       String[]

  requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  answers     QuoteAnswer[]
}

model EvaluationCriteria {
    id String @id @default(cuid())
    requisitionId String @unique
    financialWeight Float
    technicalWeight Float

    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    financialCriteria FinancialCriterion[]
    technicalCriteria TechnicalCriterion[]
}

model FinancialCriterion {
    id String @id @default(cuid())
    evaluationCriteriaId String
    name String
    weight Float

    criteriaSet EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
    scores Score[]
}

model TechnicalCriterion {
    id String @id @default(cuid())
    evaluationCriteriaId String
    name String
    weight Float
    
    criteriaSet EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
    scores Score[]
}

model Vendor {
  id              String        @id @default(cuid())
  userId          String        @unique
  name            String
  contactPerson   String
  email           String
  phone           String
  address         String
  kycStatus       String
  rejectionReason String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  quotations   Quotation[]
  purchaseOrders PurchaseOrder[]
  kycDocuments   KYC_Document[]
  contracts    Contract[]
}

model KYC_Document {
    id          String   @id @default(cuid())
    vendorId    String
    name        String
    url         String
    submittedAt DateTime
    
    vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
}

model Quotation {
  id            String   @id @default(cuid())
  transactionId String
  requisitionId String
  vendorId      String
  vendorName    String
  totalPrice    Float
  deliveryDate  DateTime
  status        String
  notes         String?
  rank          Int?
  finalAverageScore Float?
  cpoDocumentUrl String?
  experienceDocumentUrl String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  vendor      Vendor              @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  items       QuoteItem[]
  answers     QuoteAnswer[]
  scores      CommitteeScoreSet[]
}

model QuoteItem {
  id                String  @id @default(cuid())
  quotationId       String
  requisitionItemId String
  name              String
  quantity          Int
  unitPrice         Float
  leadTimeDays      Int
  brandDetails      String?

  quotation   Quotation       @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  requisitionItem RequisitionItem @relation(fields: [requisitionItemId], references: [id], onDelete: Cascade)
  scores      ItemScore[]
}

model QuoteAnswer {
  id          String @id @default(cuid())
  quotationId String
  questionId  String
  answer      String

  quotation Quotation      @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  question  CustomQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model PurchaseOrder {
  id               String   @id @default(cuid())
  transactionId    String
  requisitionId    String
  requisitionTitle String
  vendorId         String
  totalAmount      Float
  status           String
  notes            String?
  createdAt        DateTime @default(now())

  requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  vendor      Vendor              @relation(fields: [vendorId], references: [id])
  items       POItem[]
  receipts    GoodsReceiptNote[]
  invoices    Invoice[]
}

model POItem {
  id                String  @id @default(cuid())
  poId              String
  requisitionItemId String
  name              String
  quantity          Int
  unitPrice         Float
  totalPrice        Float
  receivedQuantity  Int

  po              PurchaseOrder   @relation(fields: [poId], references: [id], onDelete: Cascade)
  requisitionItem RequisitionItem @relation(fields: [requisitionItemId], references: [id])
  receiptItems    ReceiptItem[]
}

model GoodsReceiptNote {
  id              String   @id @default(cuid())
  transactionId   String
  purchaseOrderId String
  receivedById    String
  receivedDate    DateTime @default(now())

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  receivedBy    User          @relation(fields: [receivedById], references: [id])
  items         ReceiptItem[]
}

model ReceiptItem {
  id               String  @id @default(cuid())
  grnId            String
  poItemId         String
  quantityReceived Int
  condition        String
  notes            String?

  grn    GoodsReceiptNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
  poItem POItem           @relation(fields: [poItemId], references: [id])
}

model Invoice {
  id                String   @id @default(cuid())
  transactionId     String
  purchaseOrderId   String
  vendorId          String
  invoiceDate       DateTime
  totalAmount       Float
  status            String
  documentUrl       String?
  paymentDate       DateTime?
  paymentReference  String?
  paymentEvidenceUrl String?

  po    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  items InvoiceItem[]
}

model InvoiceItem {
    id          String  @id @default(cuid())
    invoiceId   String
    name        String
    quantity    Int
    unitPrice   Float
    totalPrice  Float

    invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model CommitteeAssignment {
    userId        String
    requisitionId String
    scoresSubmitted Boolean @default(false)
    
    user        User                @relation(fields: [userId], references: [id])
    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id])

    @@id([userId, requisitionId])
}

model CommitteeScoreSet {
    id String @id @default(cuid())
    quotationId String
    scorerId String
    committeeComment String?
    finalScore Float
    submittedAt DateTime @default(now())

    quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    scorer User @relation(fields: [scorerId], references: [id], onDelete: Cascade)
    itemScores ItemScore[]
    
    @@unique([quotationId, scorerId])
}

model ItemScore {
    id String @id @default(cuid())
    scoreSetId String
    quoteItemId String
    finalScore Float

    scoreSet CommitteeScoreSet @relation(fields: [scoreSetId], references: [id], onDelete: Cascade)
    quoteItem QuoteItem @relation(fields: [quoteItemId], references: [id], onDelete: Cascade)
    scores Score[]

    @@unique([scoreSetId, quoteItemId])
}

model Score {
    id String @id @default(cuid())
    itemScoreId String
    financialCriterionId String?
    technicalCriterionId String?
    score Float
    comment String?
    type String

    itemScore ItemScore @relation(fields: [itemScoreId], references: [id], onDelete: Cascade)
    financialCriterion FinancialCriterion? @relation(fields: [financialCriterionId], references: [id])
    technicalCriterion TechnicalCriterion? @relation(fields: [technicalCriterionId], references: [id])
}

model Review {
    id String @id @default(cuid())
    requisitionId String
    reviewerId String
    decision String // APPROVED, REJECTED
    comment String?
    createdAt DateTime @default(now())

    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    reviewer User @relation(fields: [reviewerId], references: [id])
}

model Contract {
    id             String   @id @default(cuid())
    contractNumber String   @unique @default(cuid())
    requisitionId  String   @unique
    vendorId       String
    senderId       String
    startDate      DateTime
    endDate        DateTime
    filePath       String?
    status         String
    createdAt      DateTime @default(now())

    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    vendor      Vendor              @relation(fields: [vendorId], references: [id])
    sender      User                @relation(fields: [senderId], references: [id])
}

model Minute {
    id            String   @id @default(cuid())
    requisitionId String
    authorId      String
    decision      String
    decisionBody  String
    justification String
    createdAt     DateTime @default(now())

    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    author      User                @relation("MinuteAuthor", fields: [authorId], references: [id])
    attendees   User[]              @relation("MinuteAttendees")
}

model Setting {
    key String @id
    value Json
}

model ApprovalThreshold {
    id String @id @default(cuid())
    name String @unique
    min Int
    max Int?
    steps ApprovalStep[]
}

model ApprovalStep {
    id String @id @default(cuid())
    thresholdId String
    role String
    order Int
    threshold ApprovalThreshold @relation(fields: [thresholdId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id            String   @id @default(cuid())
  transactionId String?
  timestamp     DateTime @default(now())
  userId        String?
  action        String
  entity        String
  entityId      String
  details       String

  user User? @relation(fields: [userId], references: [id])
}
