
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --------------------------------------
// Core Models
// --------------------------------------

model User {
  id                                            String                @id @default(cuid())
  email                                         String                @unique
  name                                          String
  password                                      String
  departmentId                                  String?
  vendorId                                      String?               @unique
  createdAt                                     DateTime              @default(now())
  updatedAt                                     DateTime              @updatedAt
  
  department                                    Department?           @relation(fields: [departmentId], references: [id])
  vendor                                        Vendor?               @relation(fields: [vendorId], references: [id])
  roles                                         Role[]                @relation("UserRoles")
  
  requisitions                                  PurchaseRequisition[] @relation("RequisitionsByUser")
  approvedRequisitions                          PurchaseRequisition[] @relation("ApprovedByUser")
  currentApprovals                              PurchaseRequisition[] @relation("CurrentApprover")
  
  goodsReceipts                                 GoodsReceiptNote[]
  reviews                                       Review[]
  
  auditLogs                                     AuditLog[]

  // Many-to-Many for Evaluation Committees
  financialCommitteeOn                              PurchaseRequisition[] @relation("FinancialCommitteeMembers")
  technicalCommitteeOn                              PurchaseRequisition[] @relation("TechnicalCommitteeMembers")

  committeeAssignments                          CommitteeAssignment[]
  standbyAssignments                            StandbyAssignment[]
  scores                                        CommitteeScoreSet[]

  sentContracts                                 Contract[]

  minutesAuthored                               Minute[]              @relation("MinuteAuthor")
  minutesAttended                               Minute[]              @relation("MinuteAttendees")
}

model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  headId      String?  @unique
  
  head        User?    @relation(fields: [headId], references: [id])
  users       User[]
  requisitions PurchaseRequisition[]
}

model Role {
  id            String   @id @default(cuid())
  name          String   @unique
  description   String?
  
  users         User[]   @relation("UserRoles")
  approvalSteps ApprovalStep[]
}

model Vendor {
  id            String   @id @default(cuid())
  userId        String   @unique
  name          String
  contactPerson String
  email         String   @unique
  phone         String
  address       String
  kycStatus     KycStatus @default(Pending)
  rejectionReason String?
  
  user          User?
  quotations    Quotation[]
  contracts     Contract[]
  purchaseOrders PurchaseOrder[]
  kycDocuments  KYC_Document[]
}

model KYC_Document {
    id          String   @id @default(cuid())
    vendorId    String
    name        String
    url         String
    submittedAt DateTime
    
    vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
}

// --------------------------------------
// Procurement Workflow Models
// --------------------------------------

model PurchaseRequisition {
  id                      String      @id @default(cuid())
  transactionId           String      @unique @default(cuid())
  title                   String
  justification           String
  status                  RequisitionStatus @default(Draft)
  urgency                 Urgency     @default(Low)
  totalPrice              Float
  createdAt               DateTime    @default(now())
  updatedAt               DateTime    @updatedAt
  
  requesterId             String
  departmentId            String
  approverId              String?
  currentApproverId       String?
  parentId                String?

  requester               User        @relation("RequisitionsByUser", fields: [requesterId], references: [id])
  department              Department  @relation(fields: [departmentId], references: [id])
  approver                User?       @relation("ApprovedByUser", fields: [approverId], references: [id])
  currentApprover         User?       @relation("CurrentApprover", fields: [currentApproverId], references: [id], onDelete: SetNull)

  items                   RequisitionItem[]
  quotations              Quotation[]
  contracts               Contract[]
  purchaseOrders          PurchaseOrder[]
  reviews                 Review[]
  minutes                 Minute[]
  
  parent                  PurchaseRequisition? @relation("RequisitionRestarts", fields: [parentId], references: [id])
  children                PurchaseRequisition[] @relation("RequisitionRestarts")

  // RFQ fields
  deadline                DateTime?
  cpoAmount               Float?
  allowedVendorIds        String[]
  rfqSettings             Json        @default("{}")

  // Committee fields
  committeeName           String?
  committeePurpose        String?
  scoringDeadline         DateTime?
  awardResponseDeadline   DateTime?
  awardResponseDurationMinutes Int?
  
  awardedQuoteItemIds     String[]
  
  customQuestions         CustomQuestion[]

  // Many-to-Many relations for committees
  financialCommitteeMembers User[] @relation("FinancialCommitteeMembers")
  technicalCommitteeMembers User[] @relation("TechnicalCommitteeMembers")
  committeeAssignments      CommitteeAssignment[]
  standbyAssignments        StandbyAssignment[]
}

model RequisitionItem {
  id          String   @id @default(cuid())
  name        String
  description String?
  quantity    Int
  unitPrice   Float

  requisitionId String
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  
  quoteItems    QuoteItem[]
  poItems       POItem[]
  
  perItemAwardDetails Json?
  reopenDeadline      DateTime?
  reopenVendorIds     String[]
}

model CustomQuestion {
  id              String       @id @default(cuid())
  requisitionId   String
  questionText    String
  questionType    QuestionType
  isRequired      Boolean
  options         String[]
  
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  answers         QuoteAnswer[]
}

model Quotation {
  id              String      @id @default(cuid())
  transactionId   String
  requisitionId   String
  vendorId        String
  vendorName      String
  totalPrice      Float
  deliveryDate    DateTime
  status          QuotationStatus @default(Submitted)
  notes           String?
  rank            Int?        @db.SmallInt
  
  cpoDocumentUrl          String?
  experienceDocumentUrl   String?

  finalAverageScore Float?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  vendor          Vendor      @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  items           QuoteItem[]
  answers         QuoteAnswer[]
  scores          CommitteeScoreSet[]
  standbyAssignment StandbyAssignment?
}

model QuoteItem {
  id                String    @id @default(cuid())
  quotationId       String
  requisitionItemId String
  
  name              String
  quantity          Int
  unitPrice         Float
  leadTimeDays      Int
  brandDetails      String?
  imageUrl          String?

  quotation         Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  requisitionItem   RequisitionItem @relation(fields: [requisitionItemId], references: [id], onDelete:Restrict)
  itemScores        ItemScore[]
}

model QuoteAnswer {
    id              String @id @default(cuid())
    quotationId     String
    questionId      String
    answer          String

    quotation       Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    question        CustomQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model PurchaseOrder {
  id                String       @id @default(cuid())
  transactionId     String
  requisitionId     String
  requisitionTitle  String
  vendorId          String
  totalAmount       Float
  status            POStatus     @default(Issued)
  createdAt         DateTime     @default(now())

  requisition       PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  vendor            Vendor       @relation(fields: [vendorId], references: [id])
  items             POItem[]
  receipts          GoodsReceiptNote[]
  invoices          Invoice[]
}

model POItem {
  id              String    @id @default(cuid())
  purchaseOrderId String
  requisitionItemId String
  name            String
  quantity        Int
  unitPrice       Float
  totalPrice      Float
  receivedQuantity Int      @default(0)

  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  requisitionItem RequisitionItem @relation(fields: [requisitionItemId], references: [id])
  receiptItems    ReceiptItem[]
}

model GoodsReceiptNote {
  id              String   @id @default(cuid())
  transactionId   String
  purchaseOrderId String
  receivedById    String
  receivedDate    DateTime @default(now())

  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  receivedBy      User          @relation(fields: [receivedById], references: [id])
  items           ReceiptItem[]
}

model ReceiptItem {
    id                  String   @id @default(cuid())
    goodsReceiptNoteId  String
    poItemId            String
    quantityReceived    Int
    condition           ReceiptItemCondition
    notes               String?

    goodsReceiptNote    GoodsReceiptNote @relation(fields: [goodsReceiptNoteId], references: [id], onDelete: Cascade)
    poItem              POItem           @relation(fields: [poItemId], references: [id])
}

model Invoice {
  id                String   @id @default(cuid())
  transactionId     String
  purchaseOrderId   String
  vendorId          String
  invoiceDate       DateTime
  totalAmount       Float
  status            InvoiceStatus @default(Pending)
  documentUrl       String?
  paymentDate       DateTime?
  paymentReference  String?
  paymentEvidenceUrl String?

  po                PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  items             InvoiceItem[]
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  name        String
  quantity    Int
  unitPrice   Float
  totalPrice  Float
  
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model Contract {
    id              String @id @default(cuid())
    contractNumber  String @unique @default(cuid())
    requisitionId   String
    vendorId        String
    senderId        String
    startDate       DateTime
    endDate         DateTime
    filePath        String?
    status          String // Draft, Active, Expired, Terminated
    createdAt       DateTime @default(now())
    
    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    vendor          Vendor @relation(fields: [vendorId], references: [id])
    sender          User @relation(fields: [senderId], references: [id])
}

model Minute {
    id              String @id @default(cuid())
    requisitionId   String
    authorId        String
    decision        String // Approved, Rejected, Revision
    decisionBody    String // e.g. "Committee A"
    justification   String @db.Text
    createdAt       DateTime @default(now())

    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    author          User @relation("MinuteAuthor", fields: [authorId], references: [id])
    attendees       User[] @relation("MinuteAttendees")
}


// --------------------------------------
// Scoring and Evaluation Models
// --------------------------------------

model CommitteeAssignment {
  id              String   @id @default(cuid())
  userId          String
  requisitionId   String
  scoresSubmitted Boolean  @default(false)
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  
  @@unique([userId, requisitionId])
}

model CommitteeScoreSet {
    id               String      @id @default(cuid())
    quotationId      String
    scorerId         String
    committeeComment String
    finalScore       Float       @default(0)
    submittedAt      DateTime    @default(now())
    
    quotation        Quotation   @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    scorer           User        @relation(fields: [scorerId], references: [id], onDelete: Cascade)
    itemScores       ItemScore[]
    
    @@unique([quotationId, scorerId])
}

model ItemScore {
  id          String    @id @default(cuid())
  scoreSetId  String
  quoteItemId String
  finalScore  Float
  
  scoreSet    CommitteeScoreSet @relation(fields: [scoreSetId], references: [id], onDelete: Cascade)
  quoteItem   QuoteItem         @relation(fields: [quoteItemId], references: [id], onDelete: Cascade)
  scores      Score[]
  
  @@unique([scoreSetId, quoteItemId])
}

model Score {
    id                      String   @id @default(cuid())
    itemScoreId             String
    score                   Float
    comment                 String
    type                    ScoreType
    
    financialCriterionId    String?
    technicalCriterionId    String?

    itemScore               ItemScore @relation(fields: [itemScoreId], references: [id], onDelete: Cascade)
    financialCriterion      FinancialCriterion? @relation(fields: [financialCriterionId], references: [id])
    technicalCriterion      TechnicalCriterion? @relation(fields: [technicalCriterionId], references: [id])
}


model EvaluationCriteria {
    id              String @id @default(cuid())
    requisitionId   String @unique
    
    financialWeight Float
    technicalWeight Float

    requisition         PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    financialCriteria   FinancialCriterion[]
    technicalCriteria   TechnicalCriterion[]
}

model FinancialCriterion {
    id                      String  @id @default(cuid())
    evaluationCriteriaId    String
    name                    String
    weight                  Float
    
    evaluationCriteria      EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
    scores                  Score[]
}

model TechnicalCriterion {
    id                      String  @id @default(cuid())
    evaluationCriteriaId    String
    name                    String
    weight                  Float
    
    evaluationCriteria      EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
    scores                  Score[]
}

model StandbyAssignment {
  id            String @id @default(cuid())
  requisitionId String
  quotationId   String @unique
  rank          Int
  
  user          User                @relation(fields: [userId], references: [id])
  userId        String
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  quotation     Quotation           @relation(fields: [quotationId], references: [id], onDelete: Cascade)
}

// --------------------------------------
// Approval Workflow Models
// --------------------------------------

model ApprovalThreshold {
    id      String @id @default(cuid())
    name    String @unique // e.g., "Low Value", "Mid Value"
    min     Float
    max     Float? // Null means infinity
    
    steps   ApprovalStep[]
}

model ApprovalStep {
    id          String   @id @default(cuid())
    thresholdId String
    order       Int
    roleName    String
    
    threshold   ApprovalThreshold @relation(fields: [thresholdId], references: [id], onDelete: Cascade)
    role        Role              @relation(fields: [roleName], references: [name])
    
    @@unique([thresholdId, order])
}

model Review {
    id            String @id @default(cuid())
    requisitionId String
    reviewerId    String
    decision      String // APPROVED, REJECTED
    comment       String
    createdAt     DateTime @default(now())

    requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    reviewer      User                @relation(fields: [reviewerId], references: [id], onDelete: Cascade)
    
    @@unique([requisitionId, reviewerId])
}


// --------------------------------------
// System & Enums
// --------------------------------------

model Setting {
  key   String @id
  value Json
}


enum RequisitionStatus {
  Draft
  Pending_Approval
  Rejected
  PreApproved // Department head approved, ready for RFQ
  Accepting_Quotes // RFQ sent, vendors can submit quotes
  Scoring_In_Progress // Deadline passed, committee is scoring
  Scoring_Complete // All scores are in, ready to finalize award
  Awarded // Award has been sent to vendor(s) and is pending response
  Award_Declined // The winning vendor has declined the award
  PostApproved // All hierarchical reviews complete, ready for vendor notification
  PO_Created
  Fulfilled
  Closed
  Pending_Committee_B_Review
  Pending_Committee_A_Recommendation
  Pending_Managerial_Approval
  Pending_Director_Approval
  Pending_VP_Approval
  Pending_President_Approval
}

enum Urgency {
  Low
  Medium
  High
  Critical
}

enum KycStatus {
  Pending
  Verified
  Rejected
}

enum QuotationStatus {
  Submitted
  Awarded
  Partially_Awarded
  Rejected
  Standby
  Invoice_Submitted
  Failed
  Accepted
  Declined
  Pending_Award
}

enum POStatus {
    Issued
    Acknowledged
    Shipped
    Partially_Delivered
    Delivered
    Cancelled
    Matched
    Mismatched
    On_Hold
    Closed
}

enum ReceiptItemCondition {
    Good
    Damaged
    Incorrect
}

enum InvoiceStatus {
    Pending
    Approved_for_Payment
    Paid
    Disputed
}

enum QuestionType {
    text
    boolean
    multiple_choice
    file
}

enum ScoreType {
    FINANCIAL
    TECHNICAL
}
