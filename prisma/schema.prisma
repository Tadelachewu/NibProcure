
// datasource db defines the database connection details.
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// generator client defines the Prisma Client generator.
generator client {
  provider = "prisma-client-js"
}

// --- ENUMS ---
// Enum definitions for status fields across the application.

enum KycStatus {
  Pending
  Verified
  Rejected
}

enum RequisitionStatus {
  Draft
  Pending_Approval
  Rejected
  PreApproved
  Accepting_Quotes
  Scoring_In_Progress
  Scoring_Complete
  Award_Declined
  Awarded
  PostApproved
  PO_Created
  Partially_Closed
  Fulfilled
  Closed
  Pending_Committee_B_Review
  Pending_Committee_A_Recommendation
  Pending_Managerial_Approval
  Pending_Director_Approval
  Pending_VP_Approval
  Pending_President_Approval
}

enum Urgency {
  Low
  Medium
  High
  Critical
}

enum QuotationStatus {
  Submitted
  Awarded
  Partially_Awarded
  Rejected
  Standby
  Invoice_Submitted
  Failed
  Accepted
  Declined
  Pending_Award
}

enum PurchaseOrderStatus {
  Issued
  Acknowledged
  Shipped
  Partially_Delivered
  Delivered
  Cancelled
  Matched
  Mismatched
  On_Hold
  Closed
}

enum GoodsReceiptCondition {
  Good
  Damaged
  Incorrect
}

enum InvoiceStatus {
  Pending
  Approved_for_Payment
  Paid
  Disputed
}

enum QuestionType {
  text
  boolean
  multiple_choice
  file
}

enum ScoreType {
  FINANCIAL
  TECHNICAL
}

enum MinuteDecision {
  APPROVED
  REJECTED
  REVISION
}

// --- MODELS ---

// User and authentication related models.
model User {
  id                    String        @id @default(cuid())
  name                  String
  email                 String        @unique
  password              String
  roles                 Role[]        @relation("UserRoles")
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  departmentId          String?
  department            Department?   @relation(fields: [departmentId], references: [id])
  managingDepartment    Department?   @relation("DepartmentHead")
  vendorId              String?       @unique
  vendor                Vendor?
  auditLogs             AuditLog[]
  sentContracts         Contract[]
  committeeAssignments  CommitteeAssignment[]
  scores                CommitteeScoreSet[]
  reviews               Review[]
  authoredMinutes       Minute[]      @relation("MinuteAuthor")
  attendedMinutes       Minute[]      @relation("MinuteAttendees")
  goodsReceipts         GoodsReceiptNote[]
  createdRequisitions   PurchaseRequisition[] @relation("RequisitionRequester")
  approvedRequisitions  PurchaseRequisition[] @relation("RequisitionApprover")
  currentApprovals      PurchaseRequisition[] @relation("CurrentRequisitionApprover")
  financialCommittee    PurchaseRequisition[] @relation("FinancialCommitteeMembers")
  technicalCommittee    PurchaseRequisition[] @relation("TechnicalCommitteeMembers")
}

model Role {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  users       User[]    @relation("UserRoles")
}

model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  headId      String?  @unique
  head        User?    @relation("DepartmentHead", fields: [headId], references: [id])
  users       User[]
  requisitions PurchaseRequisition[]
}

// Vendor related models.
model Vendor {
  id              String         @id @default(cuid())
  name            String
  contactPerson   String
  email           String         @unique
  phone           String
  address         String
  kycStatus       KycStatus      @default(Pending)
  rejectionReason String?
  kycDocuments    KYC_Document[]
  userId          String         @unique
  user            User           @relation(fields: [userId], references: [id])
  quotations      Quotation[]
  contracts       Contract[]
  purchaseOrders  PurchaseOrder[]
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

model KYC_Document {
  id          String   @id @default(cuid())
  name        String
  url         String
  submittedAt DateTime
  vendorId    String
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
}

// Procurement lifecycle models.
model PurchaseRequisition {
  id                  String       @id @default(cuid())
  transactionId       String?      @unique
  requesterId         String
  requester           User         @relation("RequisitionRequester", fields: [requesterId], references: [id])
  departmentId        String
  department          Department   @relation(fields: [departmentId], references: [id])
  title               String
  justification       String
  status              RequisitionStatus @default(Draft)
  urgency             Urgency      @default(Low)
  totalPrice          Float
  items               RequisitionItem[]
  customQuestions     CustomQuestion[]
  evaluationCriteria  EvaluationCriteria?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  approverId          String?
  approver            User?        @relation("RequisitionApprover", fields: [approverId], references: [id])
  currentApproverId   String?
  currentApprover     User?        @relation("CurrentRequisitionApprover", fields: [currentApproverId], references: [id])
  approverComment     String?
  deadline            DateTime? // Quotation submission deadline
  scoringDeadline     DateTime?
  allowedVendorIds    String[]
  committeeName       String?
  committeePurpose    String?
  financialCommitteeMembers User[] @relation("FinancialCommitteeMembers")
  technicalCommitteeMembers User[] @relation("TechnicalCommitteeMembers")
  quotations          Quotation[]
  contracts           Contract[]
  purchaseOrders      PurchaseOrder[]
  reviews             Review[]
  committeeAssignments CommitteeAssignment[]
  standbyAssignments  StandbyAssignment[]
  minutes             Minute[]
  awardResponseDeadline DateTime?
  awardResponseDurationMinutes Int?
  awardedQuoteItemIds String[]
  rfqSettings         Json?
  parentRequisitionId String?
  parentRequisition   PurchaseRequisition? @relation("RequisitionRestarts", fields: [parentRequisitionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  childRequisitions   PurchaseRequisition[] @relation("RequisitionRestarts")
}

model RequisitionItem {
  id                  String       @id @default(cuid())
  name                String
  description         String?
  quantity            Int
  unitPrice           Float
  requisitionId       String
  requisition         PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  quoteItems          QuoteItem[]
  poItems             POItem[]
  perItemAwardDetails Json?
}

model CustomQuestion {
  id              String       @id @default(cuid())
  questionText    String
  questionType    QuestionType
  isRequired      Boolean
  options         Json?
  requisitionId   String
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  answers         QuoteAnswer[]
}

model EvaluationCriteria {
  id                  String       @id @default(cuid())
  requisitionId       String       @unique
  requisition         PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  financialWeight     Int
  technicalWeight     Int
  financialCriteria   FinancialCriterion[]
  technicalCriteria   TechnicalCriterion[]
}

model FinancialCriterion {
  id                   String       @id @default(cuid())
  name                 String
  weight               Int
  evaluationCriteriaId String
  evaluationCriteria   EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
  scores               Score[]
}

model TechnicalCriterion {
  id                   String       @id @default(cuid())
  name                 String
  weight               Int
  evaluationCriteriaId String
  evaluationCriteria   EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
  scores               Score[]
}

model Quotation {
  id                  String    @id @default(cuid())
  transactionId       String
  requisitionId       String
  requisition         PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  vendorId            String
  vendor              Vendor    @relation(fields: [vendorId], references: [id])
  vendorName          String
  items               QuoteItem[]
  totalPrice          Float
  deliveryDate        DateTime
  status              QuotationStatus @default(Submitted)
  notes               String?
  rank                Int?
  answers             QuoteAnswer[]
  scores              CommitteeScoreSet[]
  finalAverageScore   Float?
  cpoDocumentUrl      String?
  experienceDocumentUrl String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

model QuoteItem {
  id                String    @id @default(cuid())
  requisitionItemId String
  requisitionItem   RequisitionItem @relation(fields: [requisitionItemId], references: [id])
  name              String
  quantity          Int
  unitPrice         Float
  leadTimeDays      Int
  brandDetails      String?
  imageUrl          String?
  quotationId       String
  quotation         Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  scores            ItemScore[]
}

model QuoteAnswer {
  id          String   @id @default(cuid())
  questionId  String
  question    CustomQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answer      String
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
}

model CommitteeScoreSet {
  id                String       @id @default(cuid())
  quotationId       String
  quotation         Quotation    @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  scorerId          String
  scorer            User         @relation(fields: [scorerId], references: [id])
  itemScores        ItemScore[]
  committeeComment  String
  finalScore        Float
  submittedAt       DateTime     @default(now())

  @@unique([quotationId, scorerId])
}

model ItemScore {
  id          String    @id @default(cuid())
  scoreSetId  String
  scoreSet    CommitteeScoreSet @relation(fields: [scoreSetId], references: [id], onDelete: Cascade)
  quoteItemId String
  quoteItem   QuoteItem @relation(fields: [quoteItemId], references: [id], onDelete: Cascade)
  scores      Score[]
  finalScore  Float
}

model Score {
  id                   String    @id @default(cuid())
  itemScoreId          String
  itemScore            ItemScore @relation(fields: [itemScoreId], references: [id], onDelete: Cascade)
  financialCriterionId String?
  financialCriterion   FinancialCriterion? @relation(fields: [financialCriterionId], references: [id])
  technicalCriterionId String?
  technicalCriterion   TechnicalCriterion? @relation(fields: [technicalCriterionId], references: [id])
  score                Int
  comment              String
  type                 ScoreType
}

model CommitteeAssignment {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  requisitionId   String
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  scoresSubmitted Boolean   @default(false)
  
  @@unique([userId, requisitionId])
}

model StandbyAssignment {
  id            String    @id @default(cuid())
  requisitionId String
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  vendorId      String
  rank          Int // 2 or 3
  
  @@unique([requisitionId, rank])
}


model PurchaseOrder {
  id                  String    @id @default(cuid())
  transactionId       String
  requisitionId       String
  requisition         PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  requisitionTitle    String
  vendorId            String
  vendor              Vendor    @relation(fields: [vendorId], references: [id])
  items               POItem[]
  totalAmount         Float
  status              PurchaseOrderStatus @default(Issued)
  createdAt           DateTime  @default(now())
  receipts            GoodsReceiptNote[]
  invoices            Invoice[]
}

model POItem {
  id                String    @id @default(cuid())
  requisitionItemId String
  requisitionItem   RequisitionItem @relation(fields: [requisitionItemId], references: [id])
  name              String
  quantity          Int
  unitPrice         Float
  totalPrice        Float
  receivedQuantity  Int       @default(0)
  poId              String
  purchaseOrder     PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)
  receiptItems      ReceiptItem[]
}

model GoodsReceiptNote {
  id                String    @id @default(cuid())
  transactionId       String
  purchaseOrderId   String
  purchaseOrder     PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  receivedById      String
  receivedBy        User      @relation(fields: [receivedById], references: [id])
  receivedDate      DateTime  @default(now())
  items             ReceiptItem[]
}

model ReceiptItem {
  id                String    @id @default(cuid())
  poItemId          String
  poItem            POItem    @relation(fields: [poItemId], references: [id])
  quantityReceived  Int
  condition         GoodsReceiptCondition
  notes             String?
  grnId             String
  grn               GoodsReceiptNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
}

model Invoice {
  id                String    @id @default(cuid())
  transactionId     String
  purchaseOrderId   String
  purchaseOrder     PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  vendorId          String
  invoiceDate       DateTime
  items             InvoiceItem[]
  totalAmount       Float
  status            InvoiceStatus @default(Pending)
  documentUrl       String?
  paymentDate       DateTime?
  paymentReference  String?
  paymentEvidenceUrl String?
}

model InvoiceItem {
  id          String   @id @default(cuid())
  name        String
  quantity    Int
  unitPrice   Float
  totalPrice  Float
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model Contract {
  id             String    @id @default(cuid())
  contractNumber String    @unique @default(cuid())
  requisitionId  String
  requisition    PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  vendorId       String
  vendor         Vendor    @relation(fields: [vendorId], references: [id])
  senderId       String
  sender         User      @relation(fields: [senderId], references: [id])
  startDate      DateTime
  endDate        DateTime
  filePath       String?
  notes          String?
  status         String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model Review {
  id            String    @id @default(cuid())
  requisitionId String
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  reviewerId    String
  reviewer      User      @relation(fields: [reviewerId], references: [id])
  decision      MinuteDecision
  comment       String?
  createdAt     DateTime  @default(now())
  
  @@unique([requisitionId, reviewerId])
}

model Minute {
  id            String    @id @default(cuid())
  requisitionId String
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  authorId      String
  author        User      @relation("MinuteAuthor", fields: [authorId], references: [id])
  decision      MinuteDecision
  decisionBody  String
  justification String
  attendees     User[]    @relation("MinuteAttendees")
  createdAt     DateTime  @default(now())
}

model AuditLog {
  id            String   @id @default(cuid())
  transactionId String?
  timestamp     DateTime @default(now())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  action        String
  entity        String
  entityId      String
  details       String
}

model Setting {
  key   String @id
  value Json
}

model ApprovalThreshold {
  id    String         @id @default(cuid())
  name  String         @unique
  min   Int
  max   Int?
  steps ApprovalStep[]
}

model ApprovalStep {
  id          String            @id @default(cuid())
  thresholdId String
  threshold   ApprovalThreshold @relation(fields: [thresholdId], references: [id], onDelete: Cascade)
  roleId      String
  role        Role              @relation(fields: [roleId], references: [id], onDelete: Cascade)
  order       Int

  @@unique([thresholdId, order])
}
