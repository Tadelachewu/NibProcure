
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                  String               @id @default(cuid())
  name                String
  email               String               @unique
  password            String
  roles               Role[]
  department          Department?          @relation(fields: [departmentId], references: [id])
  departmentId        String?
  vendorId            String?              @unique
  vendor              Vendor?              @relation(fields: [vendorId], references: [id])
  requesterFor        PurchaseRequisition[] @relation("Requester")
  approverFor         PurchaseRequisition[] @relation("Approver")
  currentApproverFor  PurchaseRequisition[] @relation("CurrentApprover")
  auditLogs           AuditLog[]
  createdPOs          PurchaseOrder[]
  receivedGRNs        GoodsReceiptNote[]
  managingDepartment  Department?          @relation("DepartmentHead")
  committeeScores     CommitteeScoreSet[]
  committeeAssignments CommitteeAssignment[]
  financialCommitteeForRequisitions PurchaseRequisition[] @relation("FinancialCommitteeMembers")
  technicalCommitteeForRequisitions PurchaseRequisition[] @relation("TechnicalCommitteeMembers")
  reviews             Review[]
  createdContracts    Contract[]
  attendedMinutes     Minute[]             @relation("MinuteAttendees")
  authoredMinutes     Minute[]             @relation("MinuteAuthor")
  signatures          Signature[]
  sentSupportTickets  SupportTicket[]      @relation("RequesterTickets")
  handledSupportTickets SupportTicket[]    @relation("AdminTickets")
}

model Department {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  headId      String?   @unique
  head        User?     @relation("DepartmentHead", fields: [headId], references: [id])
  users       User[]
}

model Role {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  users       User[]
  approvalSteps ApprovalStep[]
}

model Vendor {
  id               String    @id @default(cuid())
  name             String
  contactPerson    String
  email            String    @unique
  phone            String
  address          String
  userId           String    @unique
  user             User?
  kycStatus        String    @default("Pending") // Pending, Verified, Rejected
  kycDocuments     KYC_Document[]
  rejectionReason  String?
  quotations       Quotation[]
  contracts        Contract[]
  purchaseOrders   PurchaseOrder[]
  invoices         Invoice[]
}

model KYC_Document {
  id          String   @id @default(cuid())
  name        String
  url         String
  submittedAt DateTime @default(now())
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId    String
}

model PurchaseRequisition {
  id                   String    @id @default(cuid())
  transactionId        String?
  requesterId          String
  requester            User      @relation("Requester", fields: [requesterId], references: [id])
  departmentId         String
  department           Department @relation(fields: [departmentId], references: [id])
  title                String
  justification        String
  status               String
  urgency              String
  totalPrice           Float
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  deadline             DateTime?
  scoringDeadline      DateTime?
  awardResponseDeadline DateTime?
  awardResponseDurationMinutes Int?
  approverId           String?
  approver             User?     @relation("Approver", fields: [approverId], references: [id])
  currentApproverId    String?
  currentApprover      User?     @relation("CurrentApprover", fields: [currentApproverId], references: [id])
  approverComment      String?
  items                RequisitionItem[]
  quotations           Quotation[]
  customQuestions      CustomQuestion[]
  evaluationCriteria   EvaluationCriteria?
  financialCommitteeMembers User[] @relation("FinancialCommitteeMembers")
  technicalCommitteeMembers User[] @relation("TechnicalCommitteeMembers")
  committeeName        String?
  committeePurpose     String?
  cpoAmount            Float?
  allowedVendorIds     String[]
  awardedQuoteItemIds  String[]
  rfqSettings          Json?
  purchaseOrders       PurchaseOrder[]
  contracts            Contract[]
  reviews              Review[]
  committeeAssignments CommitteeAssignment[]
  standbyAssignments   StandbyAssignment[]
  minutes              Minute[]
  rfqSentAt            DateTime?

  // For handling re-tendered items
  parentRequisitionId  String?
  parentRequisition    PurchaseRequisition?  @relation("ReTender", fields: [parentRequisitionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  childRequisitions    PurchaseRequisition[] @relation("ReTender")

  @@index([currentApproverId])
}

model RequisitionItem {
  id           String    @id @default(cuid())
  requisition  PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionId String
  name         String
  description  String?
  quantity     Int
  unitPrice    Float
  perItemAwardDetails Json?
  reopenDeadline      DateTime?
  reopenVendorIds     String[]
  poItems      POItem[]
}

model CustomQuestion {
    id            String   @id @default(cuid())
    requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    requisitionId String
    questionText  String
    questionType  String   // 'text', 'boolean', 'multiple_choice', 'file'
    isRequired    Boolean  @default(true)
    options       String[]
    answers       QuoteAnswer[]
}

model EvaluationCriteria {
  id                String               @id @default(cuid())
  requisition       PurchaseRequisition  @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionId     String               @unique
  financialWeight   Int
  technicalWeight   Int
  financialCriteria FinancialCriterion[]
  technicalCriteria TechnicalCriterion[]
}

model FinancialCriterion {
  id                   String             @id @default(cuid())
  evaluationCriteria   EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
  evaluationCriteriaId String
  name                 String
  weight               Int
  scores               Score[]
}

model TechnicalCriterion {
  id                   String             @id @default(cuid())
  evaluationCriteria   EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
  evaluationCriteriaId String
  name                 String
  weight               Int
  scores               Score[]
}

model Quotation {
    id                String     @id @default(cuid())
    transactionId     String?
    requisition       PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    requisitionId     String
    vendor            Vendor     @relation(fields: [vendorId], references: [id])
    vendorId          String
    vendorName        String
    items             QuoteItem[]
    totalPrice        Float
    deliveryDate      DateTime
    createdAt         DateTime   @default(now())
    updatedAt         DateTime   @updatedAt
    status            String
    rejectionReason   String?
    rank              Int?
    finalAverageScore Float?
    answers           QuoteAnswer[]
    scores            CommitteeScoreSet[]
    cpoDocumentUrl    String?
    experienceDocumentUrl String?
    bidDocumentUrl    String?
}

model QuoteItem {
    id               String      @id @default(cuid())
    quotation        Quotation   @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    quotationId      String
    requisitionItemId String
    name             String
    quantity         Int
    unitPrice        Float
    leadTimeDays     Int
    brandDetails     String?
    imageUrl         String?
    itemScores       ItemScore[]
}

model QuoteAnswer {
    id          String    @id @default(cuid())
    quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    quotationId String
    question    CustomQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
    questionId  String
    answer      String
}

model CommitteeScoreSet {
    id               String      @id @default(cuid())
    quotation        Quotation   @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    quotationId      String
    scorerId         String
    scorer           User        @relation(fields: [scorerId], references: [id])
    committeeComment String
    itemScores       ItemScore[]
    finalScore       Float
    submittedAt      DateTime    @default(now())

    @@unique([quotationId, scorerId])
}

model ItemScore {
    id         String           @id @default(cuid())
    scoreSet   CommitteeScoreSet @relation(fields: [scoreSetId], references: [id], onDelete: Cascade)
    scoreSetId String
    quoteItem  QuoteItem        @relation(fields: [quoteItemId], references: [id])
    quoteItemId String
    finalScore Float
    scores     Score[]

    @@unique([scoreSetId, quoteItemId])
}

model Score {
    id                   String              @id @default(cuid())
    itemScore            ItemScore           @relation(fields: [itemScoreId], references: [id], onDelete: Cascade)
    itemScoreId          String
    financialCriterion   FinancialCriterion? @relation(fields: [financialCriterionId], references: [id])
    financialCriterionId String?
    technicalCriterion   TechnicalCriterion? @relation(fields: [technicalCriterionId], references: [id])
    technicalCriterionId String?
    score                Float
    comment              String
    type                 String // FINANCIAL or TECHNICAL
}

model PurchaseOrder {
  id              String    @id @default(cuid())
  transactionId   String?
  requisitionId   String
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Restrict)
  requisitionTitle String
  vendorId        String
  vendor          Vendor    @relation(fields: [vendorId], references: [id])
  items           POItem[]
  totalAmount     Float
  status          String
  createdAt       DateTime  @default(now())
  creatorId       String?
  creator         User?     @relation(fields: [creatorId], references: [id])
  notes           String?
  receipts        GoodsReceiptNote[]
  invoices        Invoice[]
}

model POItem {
  id           String    @id @default(cuid())
  po           PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  purchaseOrderId String
  name         String
  quantity     Int
  unitPrice    Float
  totalPrice   Float
  receivedQuantity Int @default(0)
  requisitionItemId String
  requisitionItem RequisitionItem @relation(fields: [requisitionItemId], references: [id])
  receiptItems ReceiptItem[]
}

model GoodsReceiptNote {
    id              String    @id @default(cuid())
    transactionId   String?
    purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
    purchaseOrderId String
    receivedById    String
    receivedBy      User      @relation(fields: [receivedById], references: [id])
    receivedDate    DateTime  @default(now())
    items           ReceiptItem[]
    status          String    @default("Processed") // Processed, Disputed
}

model ReceiptItem {
    id               String           @id @default(cuid())
    grn              GoodsReceiptNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
    grnId            String
    poItemId         String
    poItem           POItem           @relation(fields: [poItemId], references: [id])
    quantityReceived Int
    condition        String
    notes            String?
}

model Invoice {
    id                 String    @id @default(cuid())
    transactionId      String?
    purchaseOrderId    String
    po                 PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
    vendorId           String
    vendor             Vendor    @relation(fields: [vendorId], references: [id])
    invoiceDate        DateTime
    totalAmount        Float
    status             String
    documentUrl        String?
    paymentDate        DateTime?
    paymentReference   String?
    paymentEvidenceUrl String?
    items              InvoiceItem[]
    disputeReason      String?
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId   String
  name        String
  quantity    Int
  unitPrice   Float
  totalPrice  Float
}

model AuditLog {
  id            String   @id @default(cuid())
  transactionId String?
  timestamp     DateTime @default(now())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  action        String
  entity        String
  entityId      String
  details       String
}

model Setting {
  key   String @id
  value Json
}

model ApprovalStep {
    id          String    @id @default(cuid())
    threshold   ApprovalThreshold @relation(fields: [thresholdId], references: [id])
    thresholdId String
    role        Role      @relation(fields: [roleName], references: [name])
    roleName    String
    order       Int

    @@unique([thresholdId, order])
}

model ApprovalThreshold {
    id    String   @id @default(cuid())
    name  String   @unique
    min   Float
    max   Float?
    steps ApprovalStep[]
}

model Review {
  id            String    @id @default(cuid())
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  requisitionId String
  reviewer      User      @relation(fields: [reviewerId], references: [id])
  reviewerId    String
  decision      String    // "Approved", "Rejected"
  comment       String
  createdAt     DateTime  @default(now())
}

model CommitteeAssignment {
  id              String              @id @default(cuid())
  user            User                @relation(fields: [userId], references: [id])
  userId          String
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  requisitionId   String
  scoresSubmitted Boolean             @default(false)
  
  @@unique([userId, requisitionId])
}

model StandbyAssignment {
    id            String    @id @default(cuid())
    user          User      @relation(fields: [userId], references: [id])
    userId        String
    requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    requisitionId String
    rank          Int // 2 or 3
    
    @@unique([userId, requisitionId])
}

model Contract {
  id            String   @id @default(cuid())
  contractNumber String   @unique
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  requisitionId String   @unique
  vendor        Vendor   @relation(fields: [vendorId], references: [id])
  vendorId      String
  sender        User     @relation(fields: [senderId], references: [id])
  senderId      String
  filePath      String?
  notes         String?
  startDate     DateTime @default(now())
  endDate       DateTime
  status        String   @default("Draft")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Minute {
    id            String   @id @default(cuid())
    requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    requisitionId String
    author        User     @relation("MinuteAuthor", fields: [authorId], references: [id])
    authorId      String
    decision      String
    decisionBody  String
    justification String
    attendees     User[]   @relation("MinuteAttendees")
    createdAt     DateTime @default(now())
    type          String   @default("system_generated")
    documentUrl   String?
    signatures    Signature[]
}

model Signature {
    id          String   @id @default(cuid())
    minute      Minute   @relation(fields: [minuteId], references: [id], onDelete: Cascade)
    minuteId    String
    signer      User     @relation(fields: [signerId], references: [id])
    signerId    String
    signerName  String
    signerRole  String
    decision    String   // APPROVED or REJECTED
    comment     String
    signedAt    DateTime @default(now())
}

model SupportTicket {
    id          String   @id @default(cuid())
    subject     String
    message     String
    status      String // Open, In_Progress, Closed
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    requester   User     @relation("RequesterTickets", fields: [requesterId], references: [id])
    requesterId String
    admin       User?    @relation("AdminTickets", fields: [adminId], references: [id])
    adminId     String?
    response    String?
}
