
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------------------
//           Core Models (Users, Roles, Depts)
// --------------------------------------------------

model User {
  id                      String           @id @default(cuid())
  name                    String
  email                   String           @unique
  password                String
  roles                   Role[]
  departmentId            String?
  department              Department?      @relation(fields: [departmentId], references: [id])
  vendorId                String?          @unique
  vendor                  Vendor?          @relation(fields: [vendorId], references: [id])
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  requisitions            PurchaseRequisition[] @relation("Requester")
  approvedRequisitions    PurchaseRequisition[] @relation("Approver")
  contractsSent           Contract[]
  receiptsCreated         GoodsReceiptNote[]      @relation("ReceivingUser")
  reviews                 Review[]
  authoredMinutes         Minute[]         @relation("MinuteAuthor")
  minutesAttended         Minute[]         @relation("MinuteAttendees")
  scoresGiven             CommitteeScoreSet[]
  managingDepartment      Department?      @relation("DepartmentHead")
  financialCommitteeFor   PurchaseRequisition[] @relation("FinancialCommittee")
  technicalCommitteeFor   PurchaseRequisition[] @relation("TechnicalCommittee")
  committeeAssignments    CommitteeAssignment[]
  currentApproving        PurchaseRequisition[] @relation("CurrentApprover")
  supportTickets          SupportTicket[]   @relation("RequesterTickets")
  handledSupportTickets   SupportTicket[]   @relation("AdminTickets")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  users       User[]
  approvalSteps ApprovalStep[]
}

model Department {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  users       User[]
  headId      String?   @unique
  head        User?     @relation("DepartmentHead", fields: [headId], references: [id])
  requisitions PurchaseRequisition[]
}

// --------------------------------------------------
//           Procurement Core Models
// --------------------------------------------------

model PurchaseRequisition {
  id                         String    @id @default(cuid())
  transactionId              String    @unique @default(cuid())
  title                      String
  justification              String
  status                     String    @default("Draft")
  urgency                    String    @default("Low")
  totalPrice                 Float
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime  @updatedAt
  
  requesterId                String
  requester                  User      @relation("Requester", fields: [requesterId], references: [id])

  departmentId               String
  department                 Department @relation(fields: [departmentId], references: [id])
  
  // Departmental Approval
  approverId                 String?
  approver                   User?     @relation("Approver", fields: [approverId], references: [id])
  approverComment            String?
  
  // Hierarchical / Award Approval
  currentApproverId          String?
  currentApprover            User?     @relation("CurrentApprover", fields: [currentApproverId], references: [id])
  
  deadline                   DateTime? // Deadline for vendors to submit quotes
  scoringDeadline            DateTime? // Deadline for committee to finish scoring
  awardResponseDeadline      DateTime? // Deadline for vendor to accept/reject award
  awardResponseDurationMinutes Int?
  
  // Relational Fields
  items                      RequisitionItem[]
  customQuestions            CustomQuestion[]
  evaluationCriteria         EvaluationCriteria?
  quotations                 Quotation[]
  purchaseOrders             PurchaseOrder[]
  contracts                  Contract[]
  reviews                    Review[]
  minutes                    Minute[]
  
  // RFQ Settings
  allowedVendorIds           String[]
  cpoAmount                  Float?
  rfqSettings                Json?

  // Awarding
  awardedQuoteItemIds        String[]
  standbyAssignments         StandbyAssignment[]

  // Committee
  committeeName              String?
  committeePurpose           String?
  financialCommitteeMembers  User[]    @relation("FinancialCommittee")
  technicalCommitteeMembers  User[]    @relation("TechnicalCommittee")
  committeeAssignments       CommitteeAssignment[]

  // For re-tender process
  parentRequisitionId        String?
  parentRequisition          PurchaseRequisition? @relation("Reruns", fields: [parentRequisitionId], references: [id])
  childRequisitions          PurchaseRequisition[] @relation("Reruns")

  @@index([status])
  @@index([requesterId])
  @@index([currentApproverId])
}


model RequisitionItem {
  id                   String @id @default(cuid())
  requisitionId        String
  requisition          PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  name                 String
  description          String?
  quantity             Int
  unitPrice            Float
  quoteItems           QuoteItem[]
  poItems              POItem[]
  perItemAwardDetails  Json? // Array of PerItemAwardDetail
  reopenDeadline       DateTime?
  reopenVendorIds      String[]
}

model Vendor {
  id                      String    @id @default(cuid())
  name                    String
  email                   String    @unique
  contactPerson           String
  phone                   String
  address                 String
  kycStatus               String    @default("Pending")
  rejectionReason         String?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  userId                  String    @unique
  user                    User?
  
  kycDocuments            KYC_Document[]
  quotations              Quotation[]
  purchaseOrders          PurchaseOrder[]
  contracts               Contract[]
}

model KYC_Document {
    id        String   @id @default(cuid())
    vendorId  String
    vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
    name      String   // e.g., 'Business License', 'Tax ID'
    url       String
    submittedAt DateTime
}


model Quotation {
  id                String    @id @default(cuid())
  transactionId     String
  requisitionId     String
  requisition       PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  
  vendorId          String
  vendor            Vendor    @relation(fields: [vendorId], references: [id])
  vendorName        String
  
  items             QuoteItem[]
  answers           QuoteAnswer[]
  
  totalPrice        Float
  deliveryDate      DateTime
  status            String
  notes             String?
  rejectionReason   String?
  rank              Int?
  finalAverageScore Float?

  scores            CommitteeScoreSet[]

  cpoDocumentUrl      String?
  experienceDocumentUrl String?
  summaryDocumentUrl  String?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model QuoteItem {
  id                String   @id @default(cuid())
  quotationId       String
  quotation         Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  
  requisitionItemId String
  requisitionItem   RequisitionItem @relation(fields: [requisitionItemId], references: [id])
  
  name              String
  quantity          Int
  unitPrice         Float
  leadTimeDays      Int
  brandDetails      String?
  imageUrl          String?
  scores            ItemScore[]
}

model QuoteAnswer {
  id           String    @id @default(cuid())
  quotationId  String
  quotation    Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  questionId   String
  question     CustomQuestion @relation(fields: [questionId], references: [id])
  answer       String
}

model PurchaseOrder {
  id                String    @id @default(cuid())
  transactionId     String
  requisitionId     String
  requisition       PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  requisitionTitle  String

  vendorId          String
  vendor            Vendor             @relation(fields: [vendorId], references: [id])
  
  totalAmount       Float
  status            String
  createdAt         DateTime           @default(now())
  
  items             POItem[]
  receipts          GoodsReceiptNote[]
  invoices          Invoice[]
}

model POItem {
  id                String           @id @default(cuid())
  purchaseOrderId   String
  purchaseOrder     PurchaseOrder    @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  requisitionItemId String
  requisitionItem   RequisitionItem  @relation(fields: [requisitionItemId], references: [id])
  name              String
  quantity          Int
  unitPrice         Float
  totalPrice        Float
  receivedQuantity  Int                @default(0)
  receiptItems      ReceiptItem[]
}


model GoodsReceiptNote {
  id              String      @id @default(cuid())
  transactionId   String
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  
  receivedById    String
  receivedBy      User        @relation("ReceivingUser", fields: [receivedById], references: [id])
  receivedDate    DateTime    @default(now())
  status          String      @default("Processed") // Processed, Disputed
  items           ReceiptItem[]
}

model ReceiptItem {
  id                String    @id @default(cuid())
  grnId             String
  grn               GoodsReceiptNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
  poItemId          String
  poItem            POItem    @relation(fields: [poItemId], references: [id])
  quantityReceived  Int
  condition         String // Good, Damaged, Incorrect
  notes             String?
}

model Invoice {
  id                String    @id @default(cuid())
  transactionId     String
  purchaseOrderId   String
  purchaseOrder     PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  vendorId          String
  invoiceDate       DateTime
  totalAmount       Float
  status            String
  documentUrl       String?
  paymentDate       DateTime?
  paymentReference  String?
  paymentEvidenceUrl String?
  disputeReason     String?
  items             InvoiceItem[]
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  name        String
  quantity    Int
  unitPrice   Float
  totalPrice  Float
}

model Contract {
    id              String      @id @default(cuid())
    contractNumber  String      @unique
    requisitionId   String
    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    vendorId        String
    vendor          Vendor              @relation(fields: [vendorId], references: [id])
    senderId        String
    sender          User                @relation(fields: [senderId], references: [id])
    startDate       DateTime
    endDate         DateTime
    filePath        String?
    status          String              @default("Draft")
    createdAt       DateTime            @default(now())
}

// --------------------------------------------------
//           Settings & Configuration
// --------------------------------------------------

model Setting {
  key   String @id
  value Json
}

model ApprovalThreshold {
  id      String         @id @default(cuid())
  name    String         @unique
  min     Float
  max     Float?
  steps   ApprovalStep[]
}

model ApprovalStep {
  id          String            @id @default(cuid())
  thresholdId String
  threshold   ApprovalThreshold @relation(fields: [thresholdId], references: [id], onDelete: Cascade)
  roleName    String
  role        Role              @relation(fields: [roleName], references: [name])
  order       Int

  @@unique([thresholdId, order])
}

// --------------------------------------------------
//           Auditing & Logging
// --------------------------------------------------

model AuditLog {
  id            String   @id @default(cuid())
  transactionId String?
  timestamp     DateTime @default(now())
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  action        String
  entity        String
  entityId      String
  details       String

  @@index([transactionId])
}

// --------------------------------------------------
//           Committees & Scoring
// --------------------------------------------------
model CustomQuestion {
  id            String    @id @default(cuid())
  requisitionId String
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  questionText  String
  questionType  String
  isRequired    Boolean
  options       String[]
  answers       QuoteAnswer[]
}

model EvaluationCriteria {
  id                 String               @id @default(cuid())
  requisitionId      String               @unique
  requisition        PurchaseRequisition  @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  financialWeight    Int
  technicalWeight    Int
  financialCriteria  FinancialCriterion[]
  technicalCriteria  TechnicalCriterion[]
}

model FinancialCriterion {
  id                   String              @id @default(cuid())
  evaluationCriteriaId String
  evaluationCriteria   EvaluationCriteria  @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
  name                 String
  weight               Int
  scores               Score[]
}

model TechnicalCriterion {
  id                   String              @id @default(cuid())
  evaluationCriteriaId String
  evaluationCriteria   EvaluationCriteria  @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
  name                 String
  weight               Int
  scores               Score[]
}

model CommitteeAssignment {
    userId          String
    requisitionId   String
    user            User        @relation(fields: [userId], references: [id])
    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    scoresSubmitted Boolean     @default(false)
    
    @@id([userId, requisitionId])
}

model StandbyAssignment {
    id              String @id @default(cuid())
    requisitionId   String
    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    vendorId        String
    vendor          Vendor @relation(fields: [vendorId], references: [id])
    rank            Int // 2 or 3
    
    @@unique([requisitionId, rank])
}

model CommitteeScoreSet {
  id                String      @id @default(cuid())
  quotationId       String
  quotation         Quotation   @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  scorerId          String
  scorer            User        @relation(fields: [scorerId], references: [id])
  finalScore        Float
  committeeComment  String?
  submittedAt       DateTime    @default(now())
  itemScores        ItemScore[]

  @@unique([quotationId, scorerId])
}

model ItemScore {
  id            String      @id @default(cuid())
  scoreSetId    String
  scoreSet      CommitteeScoreSet @relation(fields: [scoreSetId], references: [id], onDelete: Cascade)
  quoteItemId   String
  quoteItem     QuoteItem   @relation(fields: [quoteItemId], references: [id])
  finalScore    Float
  scores        Score[]
}

model Score {
    id                      String      @id @default(cuid())
    itemScoreId             String
    itemScore               ItemScore   @relation(fields: [itemScoreId], references: [id], onDelete: Cascade)
    type                    String // FINANCIAL or TECHNICAL
    score                   Float
    comment                 String?
    
    financialCriterionId    String?
    financialCriterion      FinancialCriterion? @relation(fields: [financialCriterionId], references: [id])

    technicalCriterionId    String?
    technicalCriterion      TechnicalCriterion? @relation(fields: [technicalCriterionId], references: [id])
}

model Review {
  id                String   @id @default(cuid())
  requisitionId     String
  requisition       PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  reviewerId        String
  reviewer          User     @relation(fields: [reviewerId], references: [id])
  status            String // PENDING, APPROVED, REJECTED
  comments          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Minute {
    id              String   @id @default(cuid())
    requisitionId   String
    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    authorId        String
    author          User     @relation("MinuteAuthor", fields: [authorId], references: [id])
    type            String   // 'system_generated' or 'uploaded_document'
    documentUrl     String?
    decision        String   // APPROVED, REJECTED, REVISION
    decisionBody    String
    justification   String
    attendees       User[] @relation("MinuteAttendees")
    createdAt       DateTime @default(now())
    signatures      Signature[]
}

model Signature {
    id              String @id @default(cuid())
    minuteId        String
    minute          Minute @relation(fields: [minuteId], references: [id])
    signerId        String
    signerName      String
    signerRole      String
    decision        String // APPROVED or REJECTED
    comment         String?
    signedAt        DateTime @default(now())
}

model SupportTicket {
  id          String   @id @default(cuid())
  subject     String
  message     String
  status      String   @default("Open") // Open, In_Progress, Closed
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  requesterId String
  requester   User     @relation("RequesterTickets", fields: [requesterId], references: [id])
  
  adminId     String?
  admin       User?    @relation("AdminTickets", fields: [adminId], references: [id])
  
  response    String?
}
