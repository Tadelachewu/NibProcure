
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                                              String    @id @default(cuid())
  name                                            String
  email                                           String    @unique
  password                                        String
  departmentId                                    String?
  department                                      Department? @relation(fields: [departmentId], references: [id])
  roles                                           Role[]    @relation("UserRoles")
  vendorId                                        String?   @unique
  vendor                                          Vendor?
  requisitions                                    PurchaseRequisition[] @relation("RequesterRequisitions")
  approvals                                       PurchaseRequisition[] @relation("ApproverRequisitions")
  financialCommitteeFor                           PurchaseRequisition[] @relation("FinancialCommitteeMembers")
  technicalCommitteeFor                           PurchaseRequisition[] @relation("TechnicalCommitteeMembers")
  committeeAssignments                            CommitteeAssignment[]
  reviews                                         Review[]
  authoredMinutes                                 Minute[]              @relation("authoredMinutes")
  attendedMinutes                                 Minute[]              @relation("MinuteAttendees")
  committeeScores                                 CommitteeScoreSet[]
  goodsReceipts                                   GoodsReceiptNote[]
  contractsSent                                   Contract[]
  signatures                                      Signature[]
  requesterTickets                                SupportTicket[]       @relation("RequesterTickets")
  adminResponses                                  SupportTicket[]       @relation("AdminResponses")
  directorPins                                    DirectorPin[]
  auditLogs                                       AuditLog[]

  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  users       User[]   @relation("UserRoles")
  steps       ApprovalStep[]

  @@map("roles")
}

model Department {
  id           String    @id @default(cuid())
  name         String    @unique
  description  String?
  users        User[]
  headId       String?   @unique
  head         User?     @relation(name: "DepartmentHead", fields: [headId], references: [id])
  requisitions PurchaseRequisition[]

  @@map("departments")
}

model PurchaseRequisition {
  id                      String    @id @default(cuid())
  transactionId           String    @unique @default(cuid())
  title                   String
  justification           String
  requesterId             String
  requester               User      @relation("RequesterRequisitions", fields: [requesterId], references: [id])
  department              Department             @relation(fields: [departmentId], references: [id])
  departmentId            String
  status                  String
  urgency                 String
  totalPrice              Float
  items                   RequisitionItem[]
  customQuestions         CustomQuestion[]
  evaluationCriteria      EvaluationCriteria?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  approverId              String?
  approver                User?     @relation("ApproverRequisitions", fields: [approverId], references: [id])
  approverComment         String?
  currentApproverId       String?
  currentApprover         User?     @relation(fields: [currentApproverId], references: [id], name: "CurrentApprover")
  allowedVendorIds        String[]
  awardedQuoteItemIds     String[]  @default([])
  deadline                DateTime?
  scoringDeadline         DateTime?
  awardResponseDeadline   DateTime?
  rfqSettings             Json?
  cpoAmount               Float?

  financialCommitteeMembers User[]                  @relation("FinancialCommitteeMembers")
  technicalCommitteeMembers User[]                  @relation("TechnicalCommitteeMembers")
  committeeName             String?
  committeePurpose          String?
  committeeAssignments      CommitteeAssignment[]

  quotations      Quotation[]
  purchaseOrders  PurchaseOrder[]
  contracts       Contract[]
  reviews         Review[]
  minutes         Minute[]
  
  parent            PurchaseRequisition?  @relation("RequisitionRestarts", fields: [parentId], references: [id])
  parentId          String?
  children          PurchaseRequisition[] @relation("RequisitionRestarts")

  directorPins        DirectorPin[]
  standbyAssignments  StandbyAssignment[]

  @@map("purchase_requisitions")
}

model RequisitionItem {
  id                  String   @id @default(cuid())
  requisition         PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionId       String
  name                String
  description         String?
  quantity            Int
  unitPrice           Float
  perItemAwardDetails Json?
  quoteItems          QuoteItem[]
  poItems             POItem[]

  @@map("requisition_items")
}

model CustomQuestion {
  id            String   @id @default(cuid())
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionId   String
  questionText  String
  questionType  String   // 'text', 'boolean', 'multiple-choice', 'file'
  isRequired    Boolean
  options       String[]
  answers         QuoteAnswer[]

  @@map("custom_questions")
}

model EvaluationCriteria {
  id                  String    @id @default(cuid())
  requisition         PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionId       String    @unique
  financialWeight     Float
  technicalWeight     Float
  financialCriteria   FinancialCriterion[]
  technicalCriteria   TechnicalCriterion[]

  @@map("evaluation_criteria")
}

model FinancialCriterion {
  id                    String    @id @default(cuid())
  evaluationCriteria    EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
  evaluationCriteriaId  String
  name                  String
  weight                Float
  scores                Score[]

  @@map("financial_criteria")
}

model TechnicalCriterion {
  id                    String    @id @default(cuid())
  evaluationCriteria    EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
  evaluationCriteriaId  String
  name                  String
  weight                Float
  scores                Score[]

  @@map("technical_criteria")
}

model Quotation {
  id                String    @id @default(cuid())
  transactionId     String
  requisition       PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionId     String
  vendor            Vendor    @relation(fields: [vendorId], references: [id])
  vendorId          String
  vendorName        String
  items             QuoteItem[]
  totalPrice        Float
  deliveryDate      DateTime
  status            String
  rank              Int?
  notes             String?
  rejectionReason   String?
  finalAverageScore Float?
  answers           QuoteAnswer[]
  scores            CommitteeScoreSet[]
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  cpoDocumentUrl    String?
  experienceDocumentUrl String?
  bidDocumentUrl    String?

  standbyAssignments StandbyAssignment[]

  @@map("quotations")
}

model QuoteItem {
  id              String    @id @default(cuid())
  quotation       Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  quotationId     String
  requisitionItem RequisitionItem @relation(fields: [requisitionItemId], references: [id])
  requisitionItemId String
  name            String
  quantity        Int
  unitPrice       Float
  leadTimeDays    Int
  brandDetails    String?
  imageUrl        String?
  itemScores      ItemScore[]

  @@map("quote_items")
}

model QuoteAnswer {
    id          String      @id @default(cuid())
    quotation   Quotation   @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    quotationId String
    question    CustomQuestion @relation(fields: [questionId], references: [id])
    questionId  String
    answer      String

    @@map("quote_answers")
}

model CommitteeScoreSet {
    id                  String      @id @default(cuid())
    quotation           Quotation   @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    quotationId         String
    scorerId            String
    scorer              User        @relation(fields: [scorerId], references: [id], onDelete: Cascade)
    itemScores          ItemScore[]
    finalScore          Float
    committeeComment    String
    submittedAt         DateTime    @default(now())

    @@unique([quotationId, scorerId])
    @@map("committee_score_sets")
}

model ItemScore {
    id          String      @id @default(cuid())
    scoreSet    CommitteeScoreSet @relation(fields: [scoreSetId], references: [id], onDelete: Cascade)
    scoreSetId  String
    quoteItem   QuoteItem   @relation(fields: [quoteItemId], references: [id])
    quoteItemId String
    scores      Score[]
    finalScore  Float
    
    @@map("item_scores")
}

model Score {
    id                      String      @id @default(cuid())
    itemScore               ItemScore   @relation(fields: [itemScoreId], references: [id], onDelete: Cascade)
    itemScoreId             String
    financialCriterion      FinancialCriterion? @relation(fields: [financialCriterionId], references: [id])
    financialCriterionId    String?
    technicalCriterion      TechnicalCriterion? @relation(fields: [technicalCriterionId], references: [id])
    technicalCriterionId    String?
    score                   Float
    comment                 String
    type                    String // 'FINANCIAL' or 'TECHNICAL'

    @@map("scores")
}

model StandbyAssignment {
    id              String      @id @default(cuid())
    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    requisitionId   String
    quotation       Quotation   @relation(fields: [quotationId], references: [id])
    quotationId     String
    rank            Int // 2 or 3
    
    @@map("standby_assignments")
}

model PurchaseOrder {
  id                String    @id @default(cuid())
  transactionId     String
  requisition       PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  requisitionId     String
  requisitionTitle  String
  vendor            Vendor    @relation(fields: [vendorId], references: [id])
  vendorId          String
  items             POItem[]
  totalAmount       Float
  status            String
  createdAt         DateTime  @default(now())
  receipts          GoodsReceiptNote[]
  invoices          Invoice[]
  notes             String?

  @@map("purchase_orders")
}

model POItem {
    id                String    @id @default(cuid())
    purchaseOrder     PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
    purchaseOrderId   String
    requisitionItem   RequisitionItem @relation(fields: [requisitionItemId], references: [id])
    requisitionItemId String
    name              String
    quantity          Int
    unitPrice         Float
    totalPrice        Float
    receivedQuantity  Int
    receiptItems      ReceiptItem[]

    @@map("po_items")
}

model GoodsReceiptNote {
  id              String    @id @default(cuid())
  transactionId   String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  purchaseOrderId String
  receivedBy      User          @relation(fields: [receivedById], references: [id])
  receivedById    String
  receivedDate    DateTime  @default(now())
  items           ReceiptItem[]
  status          String? // e.g., 'Processed', 'Disputed'

  @@map("goods_receipt_notes")
}

model ReceiptItem {
    id                  String      @id @default(cuid())
    grn                 GoodsReceiptNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
    grnId               String
    poItem              POItem      @relation(fields: [poItemId], references: [id])
    poItemId            String
    quantityReceived    Int
    condition           String // 'Good', 'Damaged', 'Incorrect'
    notes               String?

    @@map("receipt_items")
}

model Invoice {
  id                 String    @id @default(cuid())
  transactionId      String
  purchaseOrder      PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  purchaseOrderId    String
  vendor             Vendor        @relation(fields: [vendorId], references: [id])
  vendorId           String
  invoiceDate        DateTime
  items              InvoiceItem[]
  totalAmount        Float
  status             String
  documentUrl        String?
  disputeReason      String?
  paymentDate        DateTime?
  paymentReference   String?
  paymentEvidenceUrl String?

  @@map("invoices")
}

model InvoiceItem {
  id          String    @id @default(cuid())
  invoice     Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId   String
  name        String
  quantity    Int
  unitPrice   Float
  totalPrice  Float

  @@map("invoice_items")
}

model Vendor {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String
  contactPerson   String
  email           String    @unique
  phone           String
  address         String
  kycStatus       String
  rejectionReason String?
  kycDocuments    KYC_Document[]
  quotations      Quotation[]
  purchaseOrders  PurchaseOrder[]
  contracts       Contract[]
  invoices        Invoice[]

  @@map("vendors")
}

model KYC_Document {
    id          String      @id @default(cuid())
    vendor      Vendor      @relation(fields: [vendorId], references: [id], onDelete: Cascade)
    vendorId    String
    name        String
    url         String
    submittedAt DateTime
    
    @@map("kyc_documents")
}

model AuditLog {
  id            String    @id @default(cuid())
  transactionId String
  timestamp     DateTime  @default(now())
  user          User?     @relation(fields: [userId], references: [id])
  userId        String?
  action        String
  entity        String
  entityId      String
  details       String

  @@map("audit_logs")
}


model ApprovalThreshold {
    id      String @id @default(cuid())
    name    String @unique
    min     Float
    max     Float?
    steps   ApprovalStep[]
    
    @@map("approval_thresholds")
}

model ApprovalStep {
    id          String  @id @default(cuid())
    threshold   ApprovalThreshold @relation(fields: [thresholdId], references: [id], onDelete: Cascade)
    thresholdId String
    role        Role    @relation(fields: [roleName], references: [name])
    roleName    String
    order       Int

    @@map("approval_steps")
}


model Contract {
  id                String      @id @default(cuid())
  contractNumber    String      @unique
  requisition       PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  requisitionId     String      @unique
  vendorId          String
  vendor            Vendor      @relation(fields: [vendorId], references: [id])
  senderId          String
  sender            User        @relation(fields: [senderId], references: [id])
  startDate         DateTime
  endDate           DateTime
  filePath          String?
  status            String // Draft, Active, Expired
  createdAt         DateTime    @default(now())

  @@map("contracts")
}

model Review {
    id              String      @id @default(cuid())
    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    requisitionId   String
    reviewerId      String
    reviewer        User        @relation(fields: [reviewerId], references: [id])
    decision        String // Approved, Rejected
    comment         String?
    createdAt       DateTime    @default(now())

    @@map("reviews")
}

model Minute {
    id              String      @id @default(cuid())
    requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    requisitionId   String
    authorId        String
    author          User        @relation("authoredMinutes", fields: [authorId], references: [id])
    decision        String      // APPROVED, REJECTED
    decisionBody    String      // e.g., "Committee A", "Award Finalization"
    justification   String
    attendees       User[]      @relation("MinuteAttendees")
    createdAt       DateTime    @default(now())
    type            String      // 'system_generated' or 'uploaded_document'
    documentUrl     String?
    signatures      Signature[]
}

model Signature {
    id           String   @id @default(cuid())
    minute       Minute   @relation(fields: [minuteId], references: [id], onDelete: Cascade)
    minuteId     String
    signerId     String
    signer       User     @relation(fields: [signerId], references: [id])
    signerName   String
    signerRole   String
    decision     String // APPROVED, REJECTED
    comment      String?
    signedAt     DateTime @default(now())
}


model Setting {
    id        String      @id @default(cuid())
    key       String      @unique
    value     Json
    createdAt DateTime    @default(now())
    updatedAt DateTime    @updatedAt
}

model SupportTicket {
  id          String   @id @default(cuid())
  subject     String
  message     String
  status      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  requester   User     @relation("RequesterTickets", fields: [requesterId], references: [id])
  requesterId String
  admin       User?    @relation("AdminResponses", fields: [adminId], references: [id])
  adminId     String?
  response    String?
}

model DirectorPin {
  id            String    @id @default(cuid())
  pin           String    @unique
  requisition   PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionId String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String
  createdAt     DateTime  @default(now())
  expiresAt     DateTime

  @@unique([userId, requisitionId])
}
