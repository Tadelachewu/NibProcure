// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                  String                @id @default(cuid())
  name                String
  email               String                @unique
  password            String
  role                UserRole
  departmentId        String?
  vendorId            String?               @unique
  managerId           String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  department          Department?           @relation("DepartmentMembers", fields: [departmentId], references: [id])
  managingDepartment  Department?           @relation("DepartmentHead")
  requisitions        PurchaseRequisition[] @relation("requester")
  approvedRequistions PurchaseRequisition[] @relation("approver")
  currentApprovals    PurchaseRequisition[] @relation("currentApprover")
  vendor              Vendor?
  auditLogs           AuditLog[]
  receipts            GoodsReceiptNote[]
  scores              CommitteeScoreSet[]
  committeeAssignments CommitteeAssignment[]
  minutesAuthored      Minute[]              @relation("author")
  minutesAttended      Minute[]              @relation("MinuteAttendees")
  financialCommittees  PurchaseRequisition[] @relation("financialCommittee")
  technicalCommittees  PurchaseRequisition[] @relation("technicalCommittee")
  sentContracts        Contract[]
  reviews              Review[]
}

model Department {
  id          String                @id @default(cuid())
  name        String                @unique
  description String?
  headId      String?               @unique
  head        User?                 @relation("DepartmentHead", fields: [headId], references: [id])
  users       User[]                @relation("DepartmentMembers")
  requisitions PurchaseRequisition[]
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Setting {
  key   String @id
  value Json
}

model PurchaseRequisition {
  id                          String    @id @default(cuid())
  transactionId               String    @unique @default(cuid())
  title                       String
  justification               String
  status                      String    @default("Draft")
  urgency                     String    @default("Low")
  totalPrice                  Float
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime  @updatedAt
  deadline                    DateTime?
  scoringDeadline             DateTime?
  awardResponseDeadline       DateTime?
  awardResponseDurationMinutes Int?
  cpoAmount                   Float?
  committeeName               String?
  committeePurpose            String?
  purchaseOrderId             String?

  requesterId   String
  departmentId  String
  approverId    String?
  currentApproverId String?

  requester         User         @relation("requester", fields: [requesterId], references: [id])
  department        Department   @relation(fields: [departmentId], references: [id])
  approver          User?        @relation("approver", fields: [approverId], references: [id])
  currentApprover   User?        @relation("currentApprover", fields: [currentApproverId], references: [id])

  items               RequisitionItem[]
  customQuestions     CustomQuestion[]
  evaluationCriteria  EvaluationCriteria?
  financialCommitteeMembers User[]         @relation("financialCommittee")
  technicalCommitteeMembers User[]         @relation("technicalCommittee")
  committeeAssignments      CommitteeAssignment[]
  quotations          Quotation[]
  purchaseOrders      PurchaseOrder[]
  contracts           Contract[]
  reviews             Review[]
  minutes             Minute[]

  // For RFQ distribution
  allowedVendorIds String[]
  awardedQuoteItemIds String[]

  // For dynamic settings per RFQ
  rfqSettings Json?
}

model RequisitionItem {
  id              String    @id @default(cuid())
  name            String
  quantity        Int
  unitPrice       Float
  description     String?
  requisitionId   String
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  quoteItems      QuoteItem[]
  poItems         POItem[]
  standbyAssignments StandbyAssignment[]
}

model Vendor {
  id            String      @id @default(cuid())
  name          String
  contactPerson String
  email         String
  phone         String
  address       String
  kycStatus     String      @default("Pending") // Pending, Verified, Rejected
  rejectionReason String?
  userId        String      @unique
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  quotations    Quotation[]
  purchaseOrders PurchaseOrder[]
  contracts     Contract[]
  kycDocuments  KYC_Document[]
}

model KYC_Document {
  id          String   @id @default(cuid())
  name        String
  url         String
  submittedAt DateTime
  vendorId    String
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
}

model Quotation {
  id           String   @id @default(cuid())
  transactionId String
  vendorName   String
  totalPrice   Float
  deliveryDate DateTime
  status       String
  notes        String?
  rank         Int?
  finalAverageScore Float?
  cpoDocumentUrl String?
  experienceDocumentUrl String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  requisitionId String
  vendorId      String
  
  requisition       PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  vendor            Vendor              @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  
  items    QuoteItem[]
  answers  QuoteAnswer[]
  scores   CommitteeScoreSet[]
  standbyAssignments StandbyAssignment[]
}

model QuoteItem {
  id                String    @id @default(cuid())
  name              String
  quantity          Int
  unitPrice         Float
  leadTimeDays      Int
  brandDetails      String?
  quotationId       String
  requisitionItemId String
  quotation         Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  requisitionItem   RequisitionItem @relation(fields: [requisitionItemId], references: [id], onDelete: Cascade)
  itemScores        ItemScore[]
}

model QuoteAnswer {
  id          String    @id @default(cuid())
  answer      String
  questionId  String
  quotationId String
  question    CustomQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  quotation   Quotation      @relation(fields: [quotationId], references: [id], onDelete: Cascade)
}

model CustomQuestion {
  id              String   @id @default(cuid())
  questionText    String
  questionType    String // text, boolean, multiple_choice, file
  isRequired      Boolean
  options         String[]
  requisitionId   String?
  requisition     PurchaseRequisition? @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  answers         QuoteAnswer[]
}

model PurchaseOrder {
  id               String   @id @default(cuid())
  transactionId    String
  requisitionTitle String
  totalAmount      Float
  status           String
  createdAt        DateTime @default(now())

  requisitionId String
  vendorId      String

  requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id])
  vendor      Vendor              @relation(fields: [vendorId], references: [id])
  
  items     POItem[]
  receipts  GoodsReceiptNote[]
  invoices  Invoice[]
}

model POItem {
  id                String    @id @default(cuid())
  name              String
  quantity          Int
  unitPrice         Float
  totalPrice        Float
  receivedQuantity  Int
  poId              String
  requisitionItemId String
  po                PurchaseOrder   @relation(fields: [poId], references: [id], onDelete: Cascade)
  requisitionItem   RequisitionItem @relation(fields: [requisitionItemId], references: [id])
  receiptItems      ReceiptItem[]
}

model GoodsReceiptNote {
  id            String   @id @default(cuid())
  transactionId String
  receivedDate  DateTime @default(now())

  purchaseOrderId String
  receivedById    String

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  receivedBy    User          @relation(fields: [receivedById], references: [id])
  
  items ReceiptItem[]
}

model ReceiptItem {
  id               String   @id @default(cuid())
  quantityReceived Int
  condition        String
  notes            String?
  grnId            String
  poItemId         String
  grn              GoodsReceiptNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
  poItem           POItem           @relation(fields: [poItemId], references: [id])
}

model Invoice {
  id                 String   @id @default(cuid())
  transactionId      String
  invoiceDate        DateTime
  totalAmount        Float
  status             String
  documentUrl        String?
  paymentDate        DateTime?
  paymentReference   String?
  paymentEvidenceUrl String?

  purchaseOrderId String
  vendorId        String
  
  po     PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  items  InvoiceItem[]
}

model InvoiceItem {
  id          String  @id @default(cuid())
  name        String
  quantity    Int
  unitPrice   Float
  totalPrice  Float
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model StandbyAssignment {
  id                  String              @id @default(cuid())
  requisitionId       String
  requisitionItemId   String
  quotationId         String
  rank                Int
  requisition         PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionItem     RequisitionItem     @relation(fields: [requisitionItemId], references: [id])
  quotation           Quotation           @relation(fields: [quotationId], references: [id])
}


// Models for scoring and committee reviews
model EvaluationCriteria {
  id                String    @id @default(cuid())
  requisitionId     String    @unique
  financialWeight   Int
  technicalWeight   Int
  requisition       PurchaseRequisition  @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  financialCriteria FinancialCriterion[]
  technicalCriteria TechnicalCriterion[]
}

model FinancialCriterion {
  id                   String    @id @default(cuid())
  name                 String
  weight               Int
  evaluationCriteriaId String
  evaluationCriteria   EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
  scores               Score[]
}

model TechnicalCriterion {
  id                   String    @id @default(cuid())
  name                 String
  weight               Int
  evaluationCriteriaId String
  evaluationCriteria   EvaluationCriteria @relation(fields: [evaluationCriteriaId], references: [id], onDelete: Cascade)
  scores               Score[]
}

model CommitteeScoreSet {
    id        String @id @default(cuid())
    quotationId String
    scorerId String
    finalScore Float @default(0)
    committeeComment String?
    submittedAt DateTime @default(now())

    quotation Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
    scorer User @relation(fields: [scorerId], references: [id], onDelete: Cascade)
    itemScores ItemScore[]
    
    @@unique([quotationId, scorerId])
}

model ItemScore {
  id String @id @default(cuid())
  scoreSetId String
  quoteItemId String
  finalScore Float @default(0)

  scoreSet CommitteeScoreSet @relation(fields: [scoreSetId], references: [id], onDelete: Cascade)
  quoteItem QuoteItem @relation(fields: [quoteItemId], references: [id], onDelete: Cascade)
  scores Score[]

  @@unique([scoreSetId, quoteItemId])
}

model Score {
  id                   String @id @default(cuid())
  itemScoreId          String
  score                Int
  comment              String?
  type                 String // FINANCIAL or TECHNICAL
  financialCriterionId String?
  technicalCriterionId String?
  
  itemScore          ItemScore           @relation(fields: [itemScoreId], references: [id], onDelete: Cascade)
  financialCriterion FinancialCriterion? @relation(fields: [financialCriterionId], references: [id])
  technicalCriterion TechnicalCriterion? @relation(fields: [technicalCriterionId], references: [id])
}

model CommitteeAssignment {
  userId          String
  requisitionId   String
  scoresSubmitted Boolean @default(false)
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  requisition     PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  
  @@id([userId, requisitionId])
}


model ApprovalThreshold {
  id String @id @default(cuid())
  name String @unique
  min Float
  max Float?
  steps ApprovalStep[]
}

model ApprovalStep {
  id String @id @default(cuid())
  thresholdId String
  role UserRole
  order Int
  threshold ApprovalThreshold @relation(fields: [thresholdId], references: [id], onDelete: Cascade)
}

model Review {
    id String @id @default(cuid())
    decision String // APPROVED, REJECTED
    comment String?
    createdAt DateTime @default(now())
    
    requisitionId String
    reviewerId String
    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    reviewer User @relation(fields: [reviewerId], references: [id], onDelete: Cascade)
}

model Contract {
    id String @id @default(cuid())
    contractNumber String @unique
    startDate DateTime
    endDate DateTime
    status String // Draft, Active, Expired
    createdAt DateTime @default(now())

    requisitionId String @unique
    vendorId String
    senderId String
    
    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id])
    vendor Vendor @relation(fields: [vendorId], references: [id])
    sender User @relation(fields: [senderId], references: [id])
}


model AuditLog {
  id            String   @id @default(cuid())
  timestamp     DateTime
  action        String
  entity        String
  entityId      String
  details       String
  userId        String?
  transactionId String?
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
}

enum MinuteDecision {
  APPROVED
  REJECTED
  REVISION
}

model Minute {
    id String @id @default(cuid())
    requisitionId String
    authorId String
    decision MinuteDecision
    decisionBody String
    justification String
    createdAt DateTime @default(now())

    requisition PurchaseRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
    author User @relation("author", fields: [authorId], references: [id])
    attendees User[] @relation("MinuteAttendees")
}

enum UserRole {
  Requester
  Approver
  Procurement_Officer
  Finance
  Admin
  Receiving
  Vendor
  Committee_Member
  Committee
  Committee_A_Member
  Committee_B_Member
  Manager_Procurement_Division
  Director_Supply_Chain_and_Property_Management
  VP_Resources_and_Facilities
  President
}
