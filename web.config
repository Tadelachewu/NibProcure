<!--
  This configuration file is required for deploying a Next.js application to a Windows IIS server.
  It provides instructions to IIS on how to handle incoming requests and manage the Node.js process.

  Prerequisites on the IIS Server:
  1. IIS URL Rewrite Module: https://www.iis.net/downloads/microsoft/url-rewrite
  2. iisnode: https://github.com/Azure/iisnode/releases
-->
<configuration>
  <system.webServer>

    <!-- 1. HANDLER - Specifies that iisnode should handle requests for the main server file. -->
    <handlers>
      <!-- The handler tells IIS to use iisnode for any requests that match the path. -->
      <add name="iisnode" path="node_modules/next/dist/bin/next" verb="*" modules="iisnode" />
    </handlers>

    <!--
      2. URL REWRITE - This is the most critical part.
      It acts as a reverse proxy, rewriting all incoming requests to be handled by your Next.js application.
    -->
    <rewrite>
      <rules>
        <!-- Rule 1: Ignore requests for Next.js's internal static files. -->
        <rule name="next-static">
          <match url="^(\_next\/.+)" />
          <action type="None" />
        </rule>

        <!-- Rule 2: Rewrite all other incoming requests to the Next.js server entry point. -->
        <rule name="next-server">
          <match url="/*" />
          <action type="Rewrite" url="node_modules/next/dist/bin/next" />
        </rule>
      </rules>
    </rewrite>

    <!--
      3. SECURITY - Deny direct access to certain sensitive directories.
      This prevents users from browsing files in your node_modules or source directories.
    -->
    <security>
      <requestFiltering>
        <hiddenSegments>
          <add segment="node_modules" />
          <add segment="src" />
          <add segment="prisma" />
        </hiddenSegments>
      </requestFiltering>
    </security>

    <!--
      4. IISNODE CONFIGURATION - Settings specific to how iisnode runs your Node.js app.
    -->
    <iisnode
      node_env="production"
      nodeProcessCommandLine="&quot;%programfiles%\nodejs\node.exe&quot;"
      loggingEnabled="true"
      debuggingEnabled="false"
      watchedFiles="web.config;*.js;*.json"
      devErrorsEnabled="false"
    />

  </system.webServer>
</configuration>
